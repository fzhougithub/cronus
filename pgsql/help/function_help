claimsprocess=# SELECT pg_get_functiondef(p.oid)
claimsprocess-# FROM pg_proc p
claimsprocess-# JOIN pg_namespace n ON n.oid = p.pronamespace
claimsprocess-# WHERE n.nspname = 'stg_global'
claimsprocess-#   AND p.proname = 'initial_dur_history';
-[ RECORD 1 ]------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
pg_get_functiondef | CREATE OR REPLACE PROCEDURE stg_global.initial_dur_history(IN input_schema text, IN input_table text, IN input_customer text, IN input_set text)                                                                                    +
                   |  LANGUAGE plpgsql                                                                                                                                                                                                                   +
                   | AS $procedure$\r                                                                                                                                                                                                                    +
                   | DECLARE\r                                                                                                                                                                                                                           +
                   |     each_thread RECORD;\r                                                                                                                                                                                                           +
                   |         customer_array INT[];\r                                                                                                                                                                                                     +
                   |         v_customer INT;\r                                                                                                                                                                                                           +
                   |         v_count INT8 := 0;\r                                                                                                                                                                                                        +
                   |         target_schema text;\r                                                                                                                                                                                                       +
                   |         target_table text;\r                                                                                                                                                                                                        +
                   |         v_c52_lkp text;\r                                                                                                                                                                                                           +
                   |         v_o59_lkp text;\r                                                                                                                                                                                                           +
                   |         threads_table text;\r                                                                                                                                                                                                       +
                   | BEGIN\r                                                                                                                                                                                                                             +
                   |         -- Set the time zone to America/Chicago\r                                                                                                                                                                                   +
                   |         PERFORM set_config('TimeZone', 'America/Chicago', true);\r                                                                                                                                                                  +
                   |         \r                                                                                                                                                                                                                          +
                   |         -- Pharse the input customer LIST\r                                                                                                                                                                                         +
                   |         customer_array := array(SELECT unnest(string_to_array(input_customer, ','))::INT);\r                                                                                                                                        +
                   |         \r                                                                                                                                                                                                                          +
                   |         -- Pharse the input schema\r                                                                                                                                                                                                +
                   |         IF input_schema in ('stg_customer','stg_global', 'stg_customer_320') \r                                                                                                                                                     +
                   |                 THEN target_schema := 'claimsprocess';\r                                                                                                                                                                            +
                   |         ELSIF input_schema in ('stg_customer_humana','stg_global_humana') \r                                                                                                                                                        +
                   |                 THEN target_schema := 'claimsprocess_humana';\r                                                                                                                                                                     +
                   |         ELSIF input_schema in ('stg_customer_other','stg_global_other') \r                                                                                                                                                          +
                   |                 THEN target_schema := 'claimsprocess_other';\r                                                                                                                                                                      +
                   |         ELSIF input_schema in ('stg_customer_ddc','stg_global_ddc')\r                                                                                                                                                               +
                   |                 THEN target_schema := 'claimsprocess_ddc';\r                                                                                                                                                                        +
                   |         ELSIF input_schema in ('stg_customer_ssnc','stg_global_ssnc')  \r                                                                                                                                                           +
                   |                 THEN target_schema := 'claimsprocess_ssnc';\r                                                                                                                                                                       +
                   |         ELSE\r                                                                                                                                                                                                                      +
                   |                 RETURN;\r                                                                                                                                                                                                           +
                   |         END IF;\r                                                                                                                                                                                                                   +
                   |         \r                                                                                                                                                                                                                          +
                   | \r                                                                                                                                                                                                                                  +
                   |         --Start Looping by customer_id\r                                                                                                                                                                                            +
                   |         FOREACH v_customer IN ARRAY customer_array\r                                                                                                                                                                                +
                   |         LOOP\r                                                                                                                                                                                                                      +
                   |                 \r                                                                                                                                                                                                                  +
                   |                 -- Pharse the target table\r                                                                                                                                                                                        +
                   |                 /*if input_set ='1' \r                                                                                                                                                                                              +
                   |                         then target_table := 'dur_hist_3unlog320_99';\r                                                                                                                                                             +
                   |                 else target_table := 'dur_hist_3unlog'||v_customer::text||'_'||input_set::text;\r                                                                                                                                   +
                   |                 end if;\r                                                                                                                                                                                                           +
                   |                 */\r                                                                                                                                                                                                                +
                   |                 target_table := 'dur_hist_1unlog'||v_customer::text||'_'||input_set::text;\r                                                                                                                                        +
                   |                 --EXECUTE format('DROP TABLE IF EXISTS %I.%I', input_schema, target_table);\r                                                                                                                                       +
                   |                 EXECUTE format('CREATE UNLOGGED TABLE IF not EXISTS %I.%I (LIKE %I.claim_dur_history INCLUDING ALL)', target_schema, target_table, target_schema);\r                                                                +
                   |                         \r                                                                                                                                                                                                          +
                   |                 RAISE NOTICE 'target table is %', target_table;\r                                                                                                                                                                   +
                   |                 \r                                                                                                                                                                                                                  +
                   |                 threads_table:= 'dur_threads_'||v_customer::text;\r                                                                                                                                                                 +
                   | \r                                                                                                                                                                                                                                  +
                   |                 v_c52_lkp := 'dur_c52_lkp_'||v_customer::text||'_'||input_set::text;\r                                                                                                                                              +
                   |                 v_o59_lkp := 'dur_o59_lkp_'||v_customer::text||'_'||input_set::text;\r                                                                                                                                              +
                   |                 -- Find all claims have not been loaded to target table for Looping\r                                                                                                                                               +
                   |                 FOR each_thread IN\r                                                                                                                                                                                                +
                   | \r                                                                                                                                                                                                                                  +
                   |                         EXECUTE format('SELECT thread_value, customer_id, min_claim, max_claim, thread_count\r                                                                                                                      +
                   |                                                         FROM %I.%I\r                                                                                                                                                                +
                   |                                                         WHERE migrate_ind is null\r                                                                                                                                                 +
                   |                                                         AND set_no::text = %L\r                                                                                                                                                     +
                   |                                                         AND customer_id = %s\r                                                                                                                                                      +
                   |                                                         ORDER BY thread_value\r                                                                                                                                                     +
                   |                                         ', input_schema, threads_table, input_set, v_customer)\r                                                                                                                                    +
                   |                 \r                                                                                                                                                                                                                  +
                   |                 LOOP\r                                                                                                                                                                                                              +
                   |                         \r                                                                                                                                                                                                          +
                   |                         RAISE NOTICE 'Start to refesh Customer% thread#%', each_thread.customer_id, each_thread.thread_value;\r                                                                                                     +
                   |                         \r                                                                                                                                                                                                          +
                   |                 \r                                                                                                                                                                                                                  +
                   |                         -- Insert the claims of the thread to target table\r                                                                                                                                                        +
                   |                         BEGIN\r                                                                                                                                                                                                     +
                   |                                                                                 \r                                                                                                                                                  +
                   |                                 EXECUTE format('INSERT INTO %I.%I\r                                                                                                                                                                 +
                   |                                                           (customer_id\r                                                                                                                                                            +
                   |                                                           ,claim_id\r                                                                                                                                                               +
                   |                                                           ,process_create_ts\r                                                                                                                                                      +
                   |                                                           ,process_create_by_user_id\r                                                                                                                                              +
                   |                                                           ,process_create_by_program_id\r                                                                                                                                           +
                   |                                                           ,process_update_ts\r                                                                                                                                                      +
                   |                                                           ,process_update_by_user_id\r                                                                                                                                              +
                   |                                                           ,process_update_by_program_id\r                                                                                                                                           +
                   |                                                           ,process_action_ind\r                                                                                                                                                     +
                   |                                                           ,client_id\r                                                                                                                                                              +
                   |                                                           ,group_id\r                                                                                                                                                               +
                   |                                                           ,member_id\r                                                                                                                                                              +
                   |                                                           ,active_product_type\r                                                                                                                                                    +
                   |                                                           ,days_supply_cnt\r                                                                                                                                                        +
                   |                                                           ,fill_dt\r                                                                                                                                                                +
                   |                                                           ,metric_qty\r                                                                                                                                                             +
                   |                                                           ,prescriber_id\r                                                                                                                                                          +
                   |                                                           ,pharmacy_id\r                                                                                                                                                            +
                   |                                                           ,pharmacy_affiliate_id\r                                                                                                                                                  +
                   |                                                           ,stANDard_therapeutic_class_cd\r                                                                                                                                          +
                   |                                                           ,special_therapeutic_class_cd_1\r                                                                                                                                         +
                   |                                                           ,special_therapeutic_class_cd_2\r                                                                                                                                         +
                   |                                                           ,special_therapeutic_class_cd_3\r                                                                                                                                         +
                   |                                                           ,special_therapeutic_class_cd_4\r                                                                                                                                         +
                   |                                                           ,special_therapeutic_class_cd_5\r                                                                                                                                         +
                   |                                                           ,special_therapeutic_class_cd_6\r                                                                                                                                         +
                   |                                                           ,special_therapeutic_class_cd_7\r                                                                                                                                         +
                   |                                                           ,gcn_id\r                                                                                                                                                                 +
                   |                                                           ,hic_list_cd_1\r                                                                                                                                                          +
                   |                                                           ,hic_list_cd_2\r                                                                                                                                                          +
                   |                                                           ,hic_list_cd_3\r                                                                                                                                                          +
                   |                                                           ,hic_list_cd_4\r                                                                                                                                                          +
                   |                                                           ,hic_list_cd_5\r                                                                                                                                                          +
                   |                                                           ,hic_list_cd_6\r                                                                                                                                                          +
                   |                                                           ,hic_list_cd_7\r                                                                                                                                                          +
                   |                                                           ,hic_list_cd_8\r                                                                                                                                                          +
                   |                                                           ,hic_list_cd_9\r                                                                                                                                                          +
                   |                                                           ,active_product_id\r                                                                                                                                                      +
                   |                                                           ,route_administration_cd\r                                                                                                                                                +
                   |                                                           ,ndc_id\r                                                                                                                                                                 +
                   |                                                           ,pharmacy_status_ind\r                                                                                                                                                    +
                   |                                                           ,postpay_ind_2\r                                                                                                                                                          +
                   |                                                           ,ndc_generic_product_ind\r                                                                                                                                                +
                   |                                                           ,npi_prescriber_id\r                                                                                                                                                      +
                   |                                                           ,npi_pharmacy_id\r                                                                                                                                                        +
                   |                                                           ,adjudication_cd\r                                                                                                                                                        +
                   |                                                           ,cms_transition_cd\r                                                                                                                                                      +
                   |                                                           ,patient_location_cd\r                                                                                                                                                    +
                   |                                                           ,level_of_service_cd\r                                                                                                                                                    +
                   |                                                           ,dur_conflict_cd\r                                                                                                                                                        +
                   |                                                           ,therapy_class_specific_cd\r                                                                                                                                              +
                   |                                                           ,authorization_nbr\r                                                                                                                                                      +
                   |                                                           ,associated_claim_id\r                                                                                                                                                    +
                   |                                                           ,claim_status_cd\r                                                                                                                                                        +
                   |                                                           ,npi_pharmacy_id_qualifier\r                                                                                                                                              +
                   |                                                           ,refill_nbr\r                                                                                                                                                             +
                   |                                                           ,submitted_days_supply_cnt\r                                                                                                                                              +
                   |                                                           ,gcn_sequence_nbr\r                                                                                                                                                       +
                   |                                                           ,fdb_hicl_sequence_nbr\r                                                                                                                                                  +
                   |                                                           ,generic_ind\r                                                                                                                                                            +
                   |                                                           ,post_pay_review_ind\r                                                                                                                                                    +
                   |                                                           ,health_insurance_claim_id\r                                                                                                                                              +
                   |                                                           ,rail_road_benefit_id\r                                                                                                                                                   +
                   |                                                           ,prescription_id\r                                                                                                                                                        +
                   |                                                           ,submission_clarification_cd\r                                                                                                                                            +
                   |                                                           ,drug_category_cd\r                                                                                                                                                       +
                   |                                                           ,coverage_code_1\r                                                                                                                                                        +
                   |                                                           ,coverage_code_2\r                                                                                                                                                        +
                   |                                                           ,copay_amt\r                                                                                                                                                              +
                   |                                                           ,tier_level_cnt\r                                                                                                                                                         +
                   |                                                           ,pharmacy_chain_id\r                                                                                                                                                      +
                   |                                                           ,pharmacy_network_id\r                                                                                                                                                    +
                   |                                                           ,ahfs_therapeutic_class_id\r                                                                                                                                              +
                   |                                                           ,brAND_long_nm\r                                                                                                                                                          +
                   |                                                           ,core_9_cd\r                                                                                                                                                              +
                   |                                                           ,generic_therapeutic_class_id\r                                                                                                                                           +
                   |                                                           ,generic_name_txt\r                                                                                                                                                       +
                   |                                                           ,medication_id\r                                                                                                                                                          +
                   |                                                           ,fill_type_cd\r                                                                                                                                                           +
                   |                                                           ,prescription_written_dt\r                                                                                                                                                +
                   |                                                           ,added_dt\r                                                                                                                                                               +
                   |                                                           ,prescribed_quantity_cnt\r                                                                                                                                                +
                   |                                                           ,dispensing_status_ind\r                                                                                                                                                  +
                   |                                                           ,relationship\r                                                                                                                                                           +
                   |                                                           ,record_source_ind\r                                                                                                                                                      +
                   |                                                           ,error_code_json\r                                                                                                                                                        +
                   |                                                           ,preauthorization_nbr\r                                                                                                                                                   +
                   |                                                           ,provider_status_cd\r                                                                                                                                                     +
                   |                                                           ,associated_prescription_nbr\r                                                                                                                                            +
                   |                                                           ,associated_prescription_id\r                                                                                                                                             +
                   |                                                           ,associated_prescription_service_dt\r                                                                                                                                     +
                   |                                                           ,ndc_label_nm\r                                                                                                                                                           +
                   |                                                           ,postpay_ind_3\r                                                                                                                                                          +
                   |                                                           ,postpay_ind_4\r                                                                                                                                                          +
                   |                                                           ,compound_cd\r                                                                                                                                                            +
                   |                                                           ,hic_data_json\r                                                                                                                                                          +
                   |                                                           ,cob_ind\r                                                                                                                                                                +
                   |                                                           ,processed_cms_ind\r                                                                                                                                                      +
                   |                                                           ,submitted_total_prescription_cost_amt\r                                                                                                                                  +
                   |                                                           ,partd_claim_process_cd\r                                                                                                                                                 +
                   |                                                           ,presumptive_eligibility_ind\r                                                                                                                                            +
                   |                                                           ,drug_data_interaction_severity_level_cd\r                                                                                                                                +
                   |                                                           ,duplicate_allowance_cnt\r                                                                                                                                                +
                   |                                                           ,drug_data_interaction_expANDed_cd\r                                                                                                                                      +
                   |                                                           ,duplicate_therapy_class_id\r                                                                                                                                             +
                   |                                                           ,diagnosis_cd\r                                                                                                                                                           +
                   |                                                           ,pharmacy_channel_cd\r                                                                                                                                                    +
                   |                                                           ,other_coverage_cd\r                                                                                                                                                      +
                   |                                                           ,dur_history_client_id)\r                                                                                                                                                 +
                   |                                                   SELECT dur_hist.cust_id\r                                                                                                                                                         +
                   |                                                                 ,dur_hist.clm_id\r                                                                                                                                                  +
                   |                                                                 ,dur_hist.prcs_add_tmsp\r                                                                                                                                           +
                   |                                                                 ,dur_hist.prcs_add_user_id\r                                                                                                                                        +
                   |                                                                 ,''DMCLAIM''\r                                                                                                                                                      +
                   |                                                                 ,dur_hist.prcs_strt_tmsp\r                                                                                                                                          +
                   |                                                                 ,dur_hist.prcs_usr_id\r                                                                                                                                             +
                   |                                                                 ,NULL\r                                                                                                                                                             +
                   |                                                                 ,dur_hist.prcs_actn_indr\r                                                                                                                                          +
                   |                                                                 ,CASE WHEN dur_hist.clnt_id = 9999 THEN COALESCE(o59.clnt_id,dur_hist.clnt_id) ELSE dur_hist.clnt_id END\r                                                          +
                   |                                                                 ,dur_hist.grp_intl_id\r                                                                                                                                             +
                   |                                                                 ,dur_hist.mbr_id\r                                                                                                                                                  +
                   |                                                                 ,dur_hist.actv_prd_typ\r                                                                                                                                            +
                   |                                                                 ,dur_hist.days_sply::smallint\r                                                                                                                                     +
                   |                                                                 ,dur_hist.fill_dte\r                                                                                                                                                +
                   |                                                                 ,dur_hist.mtrc_qnty\r                                                                                                                                               +
                   |                                                                 ,dur_hist.presbr_id\r                                                                                                                                               +
                   |                                                                 ,dur_hist.provr_id\r                                                                                                                                                +
                   |                                                                 ,dur_hist.provr_affl_id\r                                                                                                                                           +
                   |                                                                 ,dur_hist.std_tc_cde\r                                                                                                                                              +
                   |                                                                 ,dur_hist.spec_tc_cde_1\r                                                                                                                                           +
                   |                                                                 ,dur_hist.spec_tc_cde_2\r                                                                                                                                           +
                   |                                                                 ,dur_hist.spec_tc_cde_3\r                                                                                                                                           +
                   |                                                                 ,dur_hist.spec_tc_cde_4\r                                                                                                                                           +
                   |                                                                 ,dur_hist.spec_tc_cde_5\r                                                                                                                                           +
                   |                                                                 ,dur_hist.spec_tc_cde_6\r                                                                                                                                           +
                   |                                                                 ,dur_hist.spec_tc_cde_7\r                                                                                                                                           +
                   |                                                                 ,dur_hist.gcn\r                                                                                                                                                     +
                   |                                                                 ,dur_hist.hic_list_cde_1\r                                                                                                                                          +
                   |                                                                 ,dur_hist.hic_list_cde_2\r                                                                                                                                          +
                   |                                                                 ,dur_hist.hic_list_cde_3\r                                                                                                                                          +
                   |                                                                 ,dur_hist.hic_list_cde_4\r                                                                                                                                          +
                   |                                                                 ,dur_hist.hic_list_cde_5\r                                                                                                                                          +
                   |                                                                 ,dur_hist.hic_list_cde_6\r                                                                                                                                          +
                   |                                                                 ,dur_hist.hic_list_cde_7\r                                                                                                                                          +
                   |                                                                 ,dur_hist.hic_list_cde_8\r                                                                                                                                          +
                   |                                                                 ,dur_hist.hic_list_cde_9\r                                                                                                                                          +
                   |                                                                 ,dur_hist.actv_prd_id\r                                                                                                                                             +
                   |                                                                 ,dur_hist.rte_adminn_cde\r                                                                                                                                          +
                   |                                                                 ,dur_hist.ndc\r                                                                                                                                                     +
                   |                                                                 ,dur_hist.pharm_stat_indr\r                                                                                                                                         +
                   |                                                                 ,dur_hist.pay_educ_indr\r                                                                                                                                           +
                   |                                                                 ,dur_hist.gnrc_prod_indr\r                                                                                                                                          +
                   |                                                                 ,dur_hist.npi_presbr_id\r                                                                                                                                           +
                   |                                                                 ,dur_hist.npi_pharm_id\r                                                                                                                                            +
                   |                                                                 ,dur_hist.adjudn_cde\r                                                                                                                                              +
                   |                                                                 ,dur_hist.cms_transtn_cde\r                                                                                                                                         +
                   |                                                                 ,dur_hist.pat_locn_cde\r                                                                                                                                            +
                   |                                                                 ,dur_hist.lvl_of_serv_cde\r                                                                                                                                         +
                   |                                                                 ,dur_hist.dur_cfl_cde\r                                                                                                                                             +
                   |                                                                 ,dur_hist.ther_clas_cde_spec\r                                                                                                                                      +
                   |                                                                 ,dur_hist.auth_nbr\r                                                                                                                                                +
                   |                                                                 ,dur_hist.assocd_clm_id\r                                                                                                                                           +
                   |                                                                 ,COALESCE(NULLIF(TRIM(BOTH FROM dur_hist.clm_stat_cde),''''),''0'')::smallint\r                                                                                     +
                   |                                                                 ,dur_hist.pharm_id_npi_qlfr\r                                                                                                                                       +
                   |                                                                 ,dur_hist.rfl_nbr::smallint\r                                                                                                                                       +
                   |                                                                 ,dur_hist.ucf_days_sply::smallint\r                                                                                                                                 +
                   |                                                                 ,dur_hist.gcn_seq_nbr\r                                                                                                                                             +
                   |                                                                 ,dur_hist.fdb_hicl_seq_nbr\r                                                                                                                                        +
                   |                                                                 ,dur_hist.gnrc_indr\r                                                                                                                                               +
                   |                                                                 ,dur_hist.pst_pay_rvw_indr\r                                                                                                                                        +
                   |                                                                 ,dur_hist.health_insurance_claim_id\r                                                                                                                               +
                   |                                                                 ,dur_hist.rail_road_benefit_id\r                                                                                                                                    +
                   |                                                                 ,dur_hist.prescription_id\r                                                                                                                                         +
                   |                                                                 ,COALESCE(m49.submission_clarification_cd,ARRAY[dur_hist.submission_clarification_cd::smallint]) \r                                                                 +
                   |                                                                 ,dur_hist.drug_category_cd\r                                                                                                                                        +
                   |                                                                 ,dur_hist.coverage_1_cd\r                                                                                                                                           +
                   |                                                                 ,dur_hist.coverage_2_cd\r                                                                                                                                           +
                   |                                                                 ,dur_hist.copay_at\r                                                                                                                                                +
                   |                                                                 ,dur_hist.tier_level_ct::smallint\r                                                                                                                                 +
                   |                                                                 ,dur_hist.pharm_chain_id\r                                                                                                                                          +
                   |                                                                 ,dur_hist.pharmacy_network_id\r                                                                                                                                     +
                   |                                                                 ,dur_hist.ahfs_therapeutic_class_id\r                                                                                                                               +
                   |                                                                 ,dur_hist.brand_lng_nm\r                                                                                                                                            +
                   |                                                                 ,dur_hist.core_9_cd\r                                                                                                                                               +
                   |                                                                 ,dur_hist.generic_therapeutic_class_id::smallint\r                                                                                                                  +
                   |                                                                 ,dur_hist.generic_name_tx\r                                                                                                                                         +
                   |                                                                 ,dur_hist.med_id\r                                                                                                                                                  +
                   |                                                                 ,dur_hist.fill_type_cd\r                                                                                                                                            +
                   |                                                                 ,stg_global.verify_date_value(COALESCE(o59.rx_date_written,0)::integer) \r                                                                                          +
                   |                                                                 ,CURRENT_TIMESTAMP\r                                                                                                                                                +
                   |                                                                 ,c52.prescribed_quantity_ct\r                                                                                                                                       +
                   |                                                                 ,COALESCE(o59.dispg_stat_indr,''0'')\r                                                                                                                              +
                   |                                                                 ,COALESCE(o59.relationship,''0'')  \r                                                                                                                               +
                   |                                                                 ,COALESCE(o59.record_source_flag,'''') \r                                                                                                                           +
                   |                                                                 ,o59.error_code_json \r                                                                                                                                             +
                   |                                                                 ,COALESCE(o59.pre_author_number,0)\r                                                                                                                                +
                   |                                                                 ,COALESCE(o59.provider_status_code,'''')\r                                                                                                                          +
                   |                                                                 ,COALESCE(o59.assocd_rx_nbr,''0'')  \r                                                                                                                              +
                   |                                                                 ,COALESCE(o59.assocd_prescription_id,0)\r                                                                                                                           +
                   |                                                                 ,stg_global.verify_date_value(COALESCE(o59.assocd_rx_serv_ste,0)::integer)\r                                                                                        +
                   |                                                                 ,COALESCE(o59.ndc_label_name,'''')\r                                                                                                                                +
                   |                                                                 ,COALESCE(o59.pst_pay_3_indr,'''')\r                                                                                                                                +
                   |                                                                 ,COALESCE(o59.pst_pay_4_indr,'''')\r                                                                                                                                +
                   |                                                                 ,COALESCE(o59.compound_code,0) \r                                                                                                                                   +
                   |                                                                 ,c52_y08.hic_data_json \r                                                                                                                                           +
                   |                                                                 ,COALESCE(o59.cob_flag,''0'') \r                                                                                                                                    +
                   |                                                                 ,COALESCE(o59.prcsd_cms_flg,''Z'')  \r                                                                                                                              +
                   |                                                                 ,COALESCE(o59.ucf_tot_presc_cost,0)\r                                                                                                                               +
                   |                                                                 ,COALESCE(b45.process_as_cd,'' '') as process_as_cd\r                                                                                                               +
                   |                                                                 ,''N'' as presumptive_eligibility_ind\r                                                                                                                             +
                   |                                                                 ,COALESCE(y18.ddi_severity_level_cd,'''')\r                                                                                                                         +
                   |                                                                 ,COALESCE(y21.dpt_allowance_ct,0)\r                                                                                                                                 +
                   |                                                                 ,COALESCE(y18.ddi_expanded_cd,0) as drug_data_interaction_expanded_cd\r                                                                                             +
                   |                                                                 ,COALESCE(y21.duplicate_therapy_class_id,0)\r                                                                                                                       +
                   |                                                                 ,COALESCE(o59.diagnosis,'''')\r                                                                                                                                     +
                   |                                                                 ,'''' as pharmacy_channel_cd\r                                                                                                                                      +
                   |                                                                 ,COALESCE(c52.other_coverage_cd,0) \r                                                                                                                               +
                   |                                                                 ,dur_hist.clnt_id\r                                                                                                                                                 +
                   |                                                         FROM %I.%I AS dur_hist\r                                                                                                                                                    +
                   |                                                         LEFT JOIN %I.dur_b45_lkp as b45\r                                                                                                                                           +
                   |                                                           ON dur_hist.cust_id = b45.customer_id\r                                                                                                                                   +
                   |                                                          AND dur_hist.clm_id = b45.claim_id\r                                                                                                                                       +
                   |                                                         LEFT JOIN %I.%I o59\r                                                                                                                                                       +
                   |                                                           ON dur_hist.cust_id = o59.cust_id\r                                                                                                                                       +
                   |                                                          AND dur_hist.clm_id = o59.document_no\r                                                                                                                                    +
                   |                                                         LEFT JOIN %I.dur_y18_lkp y18\r                                                                                                                                              +
                   |                                                           ON dur_hist.gcn_seq_nbr = y18.gcn_seqno_id\r                                                                                                                              +
                   |                                                         LEFT JOIN %I.dur_y21_lkp y21\r                                                                                                                                              +
                   |                                                           ON dur_hist.gcn_seq_nbr = y21.gcn_seqno_id\r                                                                                                                              +
                   |                                                         LEFT JOIN %I.%I c52\r                                                                                                                                                       +
                   |                                                           ON dur_hist.cust_id = c52.customer_id\r                                                                                                                                   +
                   |                                                          AND dur_hist.clm_id = c52.claim_id\r                                                                                                                                       +
                   |                                                         LEFT JOIN %I.dur_y08_lkp c52_y08\r                                                                                                                                          +
                   |                                                           ON c52.hic_external_seq_id = c52_y08.ingredient_list_id\r                                                                                                                 +
                   |                                                         LEFT JOIN %I.dur_m49_lkp as m49\r                                                                                                                                           +
                   |                                                           ON dur_hist.cust_id = m49.customer_id\r                                                                                                                                   +
                   |                                                          AND dur_hist.clm_id = m49.claim_id\r                                                                                                                                       +
                   |                                                    where dur_hist.clm_id BETWEEN %L AND %L\r                                                                                                                                        +
                   |                                                    AND dur_hist.cust_id = %s',\r                                                                                                                                                    +
                   |                                                    target_schema,target_table, input_schema, input_table, input_schema, input_schema, v_o59_lkp, input_schema, input_schema, input_schema, v_c52_lkp, input_schema, input_schema, \r+
                   |                                                    each_thread.min_claim, each_thread.max_claim, each_thread.customer_id)\r                                                                                                         +
                   |                                                 ;\r                                                                                                                                                                                 +
                   |                                                 --on conflict (customer_id, claim_id, process_create_ts) do nothing\r                                                                                                               +
                   | \r                                                                                                                                                                                                                                  +
                   |                                 COMMIT;         \r                                                                                                                                                                                  +
                   |                 \r                                                                                                                                                                                                                  +
                   |                                 RAISE NOTICE '% Cust_ID % Thread#% Inserted', CURRENT_TIMESTAMP, each_thread.customer_id, each_thread.thread_value;\r                                                                               +
                   |                         END;\r                                                                                                                                                                                                      +
                   |                                                                 \r                                                                                                                                                                  +
                   |                         -- Mark the Thread set as "Y" in threads table\r                                                                                                                                                            +
                   |                         BEGIN\r                                                                                                                                                                                                     +
                   |                         \r                                                                                                                                                                                                          +
                   |                                 EXECUTE format('UPDATE %I.%I\r                                                                                                                                                                      +
                   |                                                                 SET migrate_ind = ''Y''\r                                                                                                                                           +
                   |                                                                 WHERE customer_id = %s\r                                                                                                                                            +
                   |                                                                   AND thread_value = %s\r                                                                                                                                           +
                   |                                         ', input_schema, threads_table, each_thread.customer_id, each_thread.thread_value);\r                                                                                                       +
                   |                                   \r                                                                                                                                                                                                +
                   |                                 COMMIT;\r                                                                                                                                                                                           +
                   |                                 --RAISE NOTICE '% Updated %.o59_threads.migrate_ind', CURRENT_TIMESTAMP, input_schema;\r                                                                                                            +
                   |                         END;\r                                                                                                                                                                                                      +
                   |                         \r                                                                                                                                                                                                          +
                   | \r                                                                                                                                                                                                                                  +
                   |                 END LOOP;  --All Threads        \r                                                                                                                                                                                  +
                   |                 RAISE NOTICE '% completed %.%', CURRENT_TIMESTAMP, target_schema, target_table;\r                                                                                                                                   +
                   |                 \r                                                                                                                                                                                                                  +
                   |         END LOOP; --All given customer_id(s)\r                                                                                                                                                                                      +
                   |         \r                                                                                                                                                                                                                          +
                   |         --RAISE NOTICE '% Loaded % records of customer_id % to %.%', CURRENT_TIMESTAMP, v_count, input_customer, target_schema,target_table;\r                                                                                      +
                   | \r                                                                                                                                                                                                                                  +
                   | END;\r                                                                                                                                                                                                                              +
                   | $procedure$                                                                                                                                                                                                                         +
                   |

claimsprocess=# \x
