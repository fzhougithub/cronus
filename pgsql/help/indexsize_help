


SELECT
  pg_size_pretty(SUM(pg_indexes_size(pg_class.oid))) AS total_index_size
FROM pg_stat_user_tables
JOIN pg_class ON pg_class.relname = pg_stat_user_tables.relname
WHERE schemaname = 'claimsprocess_humana';
 total_index_size
------------------
 1093 GB

-- total without PK

SELECT
    pg_size_pretty(
        SUM(
            pg_indexes_size(c.oid)
            - COALESCE((
                SELECT pg_relation_size(i.indexrelid)
                FROM pg_index i
                WHERE i.indrelid = c.oid
                  AND i.indisprimary
            ), 0)
        )
    ) AS total_index_size_without_pk
FROM pg_class c
JOIN pg_namespace n ON n.oid = c.relnamespace
WHERE n.nspname = 'claimsprocess_humana'
  AND c.relkind = 'r';



-- Per table index size minus PK
SELECT
    n.nspname           AS schema,
    c.relname           AS table,
    pg_size_pretty(
        pg_indexes_size(c.oid)
        - COALESCE((
            SELECT pg_relation_size(i.indexrelid)
            FROM pg_index i
            WHERE i.indrelid = c.oid
              AND i.indisprimary
        ), 0)
    ) AS index_size_without_pk
FROM pg_class c
JOIN pg_namespace n ON n.oid = c.relnamespace
WHERE n.nspname = 'claimsprocess_humana'
  AND c.relkind = 'r' order by index_size_without_pk desc;




--- This one definitely works

SELECT
  p.relname AS partition_name,
  idx.relname AS index_name,
  pg_relation_size(idx.oid)/1024/1024 AS index_size_MB,
  pt.reltuples AS table_rows,
  idx.reltuples AS index_tuples,
  CASE
    WHEN pt.reltuples > 0 THEN (pg_relation_size(idx.oid) / pt.reltuples)
    ELSE 0
  END AS tuple_size_bytes
FROM pg_class AS p
JOIN pg_inherits AS i ON p.oid = i.inhrelid
JOIN pg_index AS pidx ON pidx.indrelid = p.oid
JOIN pg_class AS idx ON idx.oid = pidx.indexrelid
LEFT JOIN pg_class AS pt ON pt.oid = p.oid
WHERE i.inhparent = 'claim_core_p1_319'::regclass
  AND pg_relation_size(p.oid) > 0
  AND p.relkind = 'r'
ORDER BY index_size_MB DESC;



-- all not only leaf

SELECT
  p.relname AS partition_name,
  idx.relname AS index_name,
  pg_size_pretty(pg_relation_size(idx.oid)) AS index_size,
  pt.reltuples AS table_rows,
  idx.reltuples AS index_tuples,
  CASE
    WHEN pt.reltuples > 0 THEN (pg_relation_size(idx.oid) / pt.reltuples)
    ELSE 0
  END AS tuple_size_bytes
FROM pg_class AS p
JOIN pg_inherits AS i ON p.oid = i.inhrelid
JOIN pg_class AS idx ON idx.indrelid = p.oid
JOIN pg_index AS pidx ON pidx.indexrelid = idx.oid
JOIN pg_namespace AS ns ON ns.oid = p.relnamespace
LEFT JOIN pg_class AS pt ON pt.oid = p.oid -- We need this to get the row count for the leaf partition.
WHERE i.inhparent = 'claim_core_p1_319'::regclass
  AND pg_relation_size(p.oid) > 0 -- Only select leaf partitions with data.
  AND p.relkind = 'r'
ORDER BY index_size DESC;





--Only Leaf

SELECT
  pg_class.relname AS index_name,
  pg_size_pretty(pg_relation_size(pg_class.oid)) AS index_size,
  (SELECT count(*) FROM pg_stat_user_tables WHERE relname = 'your_table_name') AS table_rows,
  pg_class.reltuples AS index_tuples,
  CASE
    WHEN pg_class.reltuples > 0 THEN pg_relation_size(pg_class.oid) / pg_class.reltuples
    ELSE 0
  END AS tuple_size_bytes
FROM pg_class
JOIN pg_index ON pg_index.indexrelid = pg_class.oid
JOIN pg_namespace ON pg_namespace.oid = pg_class.relnamespace
WHERE pg_index.indrelid = 'claim_core_p1_319'::regclass
  AND pg_namespace.nspname = 'claimsprocess'
ORDER BY index_size DESC;
