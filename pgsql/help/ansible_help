This is the final solution for the ansible required python
brew install pyenv
brew install pyenv-virtualenv
pyenv install 3.12.9
pyenv virtualenv 3.12.9 venv
# ~/.zshrc
eval "$(pyenv init -)"
eval "$(pyenv virtualenv-init -)
pyenv activate venv
pip3 install ansible==9.13.0 ansible-core==2.16.14 hvac dnspython

==========================================================
ansible-playbook ./playbook.yaml --tags pg-base,pg-repmanager,pg-credentials -e "do_replica_bootstrap=yes" -e "postgresql_restart_allowed=yes"
ansible-playbook ./playbook.yaml --tags pg-repmanager -e "do_replica_bootstrap=yes" -e "postgresql_restart_allowed=yes"



ansible-doc -t lookup -l

source work/p312/bin/activate
Then, you can get the right ansible-playbook

ansible-playbook ./playbook.yaml --limit claimshumana-db-01-alma8-prod-drx-kc.ssnc-corp.cloud --diff --tags pg-base --check
ansible-playbook ./playbook.yaml --limit claimshumana-db-01-alma8-prod-drx-kc.ssnc-corp.cloud --diff --tags pg-base

Right way

1. brew install python@3.12
2.  /opt/homebrew/bin/python3.12 -m venv ~/work/p312
3. source ~/work/p312/bin/activate
4. vi ~/work/p312/requirements.txt
   ansible==9.13.0
   ansible-core==2.16.14
5. pip install -r ~/work/p312/requirements.txt

Finally, got the right python and ansible version. 



ansible-playbook ./playbook.yaml --limit finance-db-01-olly-drx-kc.ssnc-corp.cloud --diff --tags pgbase
pip install 'ansible-core<2.12' 'ansible<5.0'

ansible-galaxy collection install ansible.posix
pip install certifi --upgrade

ansible-galaxy collection install ansible.posix --ignore-certs

pip install certifi
/Applications/Python\ 3.6/Install\ Certificates.command

pip install --upgrade "ansible>=2.13"

curl -O https://www.python.org/ftp/python/3.8.10/Python-3.8.10.tgz

tar xzf Python-3.8.10.tgz

cd Python-3.8.10
./configure --prefix=/usr/local/Python3.8 --enable-optimizations --with-system-ffi --with-computed-gotos --enable-loadable-sqlite-extensions
make -j $(nproc)

sudo make altinstall

 /usr/local/Python3.8/bin/python3.8 --version
Python 3.8.10

/usr/local/Python3.8/bin/python3.8 -m venv ~/work/p38

https://www.doubao.com/thread/w859e0787409d72fb



brew install python@3.9
/opt/homebrew/bin/python3.9 -m venv ~/work/p3.9
source ~/work/p3.9/bin/activate


ss -ltnp | grep 9187

To deploy a **PostgreSQL Prometheus exporter** to a target server using the Ansible role you described, you typically follow these steps:

---

## âœ… 1. **Understand the Role Structure You Have**

You've already got a valid Ansible role structure:

```
prometheus-pg-exporter/
â”œâ”€â”€ defaults/main.yaml                  # Default variables (lowest priority)
â”œâ”€â”€ handlers/main.yaml                  # Handlers like systemd reload/restart
â”œâ”€â”€ tasks/
â”‚   â”œâ”€â”€ install.yaml                    # Installation tasks (e.g. binary, user)
â”‚   â”œâ”€â”€ configure.yaml                  # Config setup (e.g. systemd, configs)
â”‚   â””â”€â”€ main.yaml                       # Entry point for the role
â””â”€â”€ templates/postgres-exporter.service.j2  # Systemd service file template
```

---

## âœ… 2. **Write a Playbook That Uses the Role**

Create a playbook like `deploy-exporter.yaml`:

```yaml
- name: Deploy PostgreSQL Exporter
  hosts: exporters
  become: true
  roles:
    - role: prometheus-pg-exporter
```

---

## âœ… 3. **Define Your Inventory File**

Create `inventory.yaml` (or use `hosts` file):

```ini
[exporters]
pg-target-01 ansible_host=192.168.10.100

[exporters:vars]
pg_user=postgres
exporter_version=0.15.0
```

Or YAML format:

```yaml
all:
  hosts:
    pg-target-01:
      ansible_host: 192.168.10.100
  children:
    exporters:
      hosts:
        pg-target-01:
```

---

## âœ… 4. **Ensure the Roleâ€™s `main.yaml` Includes Other Tasks**

Example: `tasks/main.yaml` should include your subtasks:

```yaml
- name: Include install tasks
  include_tasks: install.yaml

- name: Include configure tasks
  include_tasks: configure.yaml
```

---

## âœ… 5. **Run the Playbook**

```bash
ansible-playbook -i inventory.yaml deploy-exporter.yaml
```

---

## âœ… 6. **Common Role Tasks You Might Include**

### install.yaml:

* Download binary or install via `apt`/`yum`
* Create user `postgres_exporter`
* Place the binary in `/usr/local/bin/`

### configure.yaml:

* Use `templates/postgres-exporter.service.j2` to create a systemd unit
* Reload systemd
* Enable + start service

### handlers/main.yaml:

```yaml
- name: Restart postgres exporter
  systemd:
    name: postgres-exporter
    state: restarted
    enabled: true
    daemon_reload: true
```

---

## ðŸ”§ Optional Variables (`defaults/main.yaml`):

```yaml
exporter_version: "0.15.0"
exporter_user: postgres_exporter
exporter_install_path: /usr/local/bin
exporter_service_name: postgres-exporter
```

---

## âœ… Summary

To deploy your `prometheus-pg-exporter` role:

1. Create a playbook using the role.
2. Define target hosts in inventory.
3. Ensure your role includes proper install/configure tasks.
4. Run `ansible-playbook`.

Let me know if you'd like a **complete working example** of the role files (`install.yaml`, `service.j2`, etc.).

