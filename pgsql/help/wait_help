WITH blocked AS (
    SELECT
        pid AS blocked_pid,
        pg_blocking_pids(pid) AS blocking_pids,
        query AS blocked_query
    FROM pg_stat_activity
    WHERE state <> 'idle'
)
SELECT 
    b.blocked_pid,
    bl.blocking_pid,
    b.blocked_query,
    a.query AS blocking_query
FROM blocked b
CROSS JOIN LATERAL unnest(b.blocking_pids) AS bl(blocking_pid)
JOIN pg_stat_activity a ON a.pid = bl.blocking_pid;




SELECT pid,
       usename,
       query,
       wait_event_type,
       wait_event,
       state,
       query_start
FROM pg_stat_activity
WHERE wait_event_type = 'LWLock';



