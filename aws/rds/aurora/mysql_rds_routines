mysql> select * from routines where routine_name like 'mysql.rds%';
Empty set (0.04 sec)

mysql> select * from routines where routine_name like '%rds%';
+--------------------------------------------------------+-----------------+----------------+--------------------------------------------------------+--------------+-----------+--------------------------+------------------------+-------------------+---------------+--------------------+--------------------+--------------------+---------------------------------------+--------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------+-------------------+-----------------+------------------+-----------------+----------+---------------+---------------------+---------------------+------------------------+-----------------+--------------------+----------------------+----------------------+--------------------+
| SPECIFIC_NAME                                          | ROUTINE_CATALOG | ROUTINE_SCHEMA | ROUTINE_NAME                                           | ROUTINE_TYPE | DATA_TYPE | CHARACTER_MAXIMUM_LENGTH | CHARACTER_OCTET_LENGTH | NUMERIC_PRECISION | NUMERIC_SCALE | DATETIME_PRECISION | CHARACTER_SET_NAME | COLLATION_NAME     | DTD_IDENTIFIER                        | ROUTINE_BODY | ROUTINE_DEFINITION                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | EXTERNAL_NAME | EXTERNAL_LANGUAGE | PARAMETER_STYLE | IS_DETERMINISTIC | SQL_DATA_ACCESS | SQL_PATH | SECURITY_TYPE | CREATED             | LAST_ALTERED        | SQL_MODE               | ROUTINE_COMMENT | DEFINER            | CHARACTER_SET_CLIENT | COLLATION_CONNECTION | DATABASE_COLLATION |
+--------------------------------------------------------+-----------------+----------------+--------------------------------------------------------+--------------+-----------+--------------------------+------------------------+-------------------+---------------+--------------------+--------------------+--------------------+---------------------------------------+--------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------+-------------------+-----------------+------------------+-----------------+----------+---------------+---------------------+---------------------+------------------------+-----------------+--------------------+----------------------+----------------------+--------------------+
| rds_set_configuration                                  | def             | mysql          | rds_set_configuration                                  | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | sp: BEGIN
  DECLARE v_exists INT;
  DECLARE sql_logging BOOLEAN;
  
  
  
  
  
  SELECT COUNT(1) INTO v_exists FROM mysql.rds_configuration WHERE mysql.rds_configuration.name = name;
  IF v_exists = 0 THEN
    SET @err = CONCAT('Cannot set unknown configuration parameter ', QUOTE(name), ' using mysql.rds_set_configuration.');
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @err; 
  END IF;
  IF name = 'binlog retention hours' AND rds_is_semi_sync() = 'REPLICA' THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Cannot enable the binlog retention hours on the reader instance in RDS Multi-AZ DB cluster. Please run this query on the writer.';
  ELSEIF name = 'binlog retention hours' AND value NOT BETWEEN 1 AND 168 THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'For binlog retention hours the value must be between 1 and 168 inclusive or be NULL';
  ELSEIF name = 'target delay' AND rds_is_semi_sync() != 'NO' THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Target delay is not supported on the MySQL Multi-AZ cluster';
  ELSEIF name = 'target delay' AND (value IS NULL OR value NOT BETWEEN 0 AND 86400) THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'For target delay the value must be between 0 and 86400 inclusive';
  ELSEIF name = 'source delay' THEN
    CALL mysql.rds_set_source_delay(value);
    LEAVE sp;
  END IF;
  SELECT @@sql_log_bin INTO sql_logging;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    UPDATE mysql.rds_configuration
    SET mysql.rds_configuration.value = value
    WHERE mysql.rds_configuration.name = name;
    COMMIT;
    SET @@sql_log_bin=sql_logging;
  END;
END |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_set_source_delay                                   | def             | mysql          | rds_set_source_delay                                   | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  CALL mysql.rds_set_source_delay_for_channel(delay, '');
END                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_show_configuration                                 | def             | mysql          | rds_show_configuration                                 | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  SELECT name, value, description FROM mysql.rds_configuration;
END                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_kill                                               | def             | mysql          | rds_kill                                               | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  DECLARE l_user TEXT;
  DECLARE l_host TEXT;
  DECLARE rsv_user TEXT;
  DECLARE rsv_host TEXT;
  
  SELECT user, host INTO l_user, l_host
  FROM information_schema.processlist
  WHERE id = thread;
  
  SELECT MAX(user), MAX(host) INTO rsv_user, rsv_host
  FROM mysql.rds_reserved_users
  WHERE user = l_user;
  IF CONNECTION_ID() = thread THEN
    
    
    DO NULL;
  ELSEIF (rsv_user IS NOT NULL AND (l_host = rsv_host OR rsv_host = '%')) THEN
    
    SET @err_msg = CONCAT('CANNOT KILL ', UPPER(l_user), ' SESSION');
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @err_msg;
  END IF;
  KILL thread;
END                                                                                                                                                                                                                                                                                                                                                                                                                            |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_kill_query                                         | def             | mysql          | rds_kill_query                                         | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  DECLARE l_user TEXT;
  DECLARE l_host TEXT;
  DECLARE rsv_user TEXT;
  DECLARE rsv_host TEXT;
  
  SELECT user, host INTO l_user, l_host
  FROM information_schema.processlist
  WHERE id = thread;
  
  SELECT MAX(user), MAX(host) INTO rsv_user, rsv_host
  FROM mysql.rds_reserved_users
  WHERE user = l_user;
  IF CONNECTION_ID() = thread THEN
    
    
    DO NULL;
  ELSEIF (rsv_user IS NOT NULL AND (l_host = rsv_host OR rsv_host = '%')) THEN
    
    SET @err_msg = CONCAT('CANNOT KILL ', UPPER(l_user), ' SESSION');
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @err_msg;
  END IF;
  KILL QUERY thread;
END                                                                                                                                                                                                                                                                                                                                                                                                                      |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_rotate_general_log                                 | def             | mysql          | rds_rotate_general_log                                 | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
   DECLARE v_called_by_user VARCHAR(352);
   DECLARE v_mysql_version VARCHAR(20);
   DECLARE sql_logging BOOLEAN;
   DECLARE b_general_query_log BOOLEAN;
   SELECT @@sql_log_bin, @@general_log, user(), version() INTO sql_logging, b_general_query_log, v_called_by_user, v_mysql_version;
   
   BEGIN
     DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; SET GLOBAL general_log=b_general_query_log; RESIGNAL; END;
     SET @@sql_log_bin=OFF;
     SET GLOBAL general_log=OFF;
     DROP TABLE IF EXISTS mysql.general_log2;
     CREATE TABLE IF NOT EXISTS mysql.general_log2 LIKE mysql.general_log;
     DROP TABLE IF EXISTS mysql.general_log_backup;
     FLUSH GENERAL LOGS;
     
     
     RENAME TABLE mysql.general_log TO mysql.general_log_backup, mysql.general_log2 TO mysql.general_log;
     INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user, 'rotate_general_log', v_mysql_version);
     COMMIT;
     SET @@sql_log_bin=sql_logging;
     SET GLOBAL general_log=b_general_query_log;
   END;
END |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_rotate_slow_log                                    | def             | mysql          | rds_rotate_slow_log                                    | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
   DECLARE v_called_by_user VARCHAR(352);
   DECLARE v_mysql_version VARCHAR(20);
   DECLARE sql_logging BOOLEAN;
   DECLARE b_slow_query_log BOOLEAN;
   SELECT @@sql_log_bin, @@GLOBAL.slow_query_log, user(), version() INTO sql_logging, b_slow_query_log, v_called_by_user, v_mysql_version;
   
   BEGIN
     DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; SET GLOBAL slow_query_log=b_slow_query_log; RESIGNAL; END;
     SET @@sql_log_bin=OFF;
     SET GLOBAL slow_query_log=OFF;
     DROP TABLE IF EXISTS mysql.slow_log2;
     CREATE TABLE IF NOT EXISTS mysql.slow_log2 LIKE mysql.slow_log;
     DROP TABLE IF EXISTS mysql.slow_log_backup;
     FLUSH SLOW LOGS;
     
     
     RENAME TABLE mysql.slow_log TO mysql.slow_log_backup, mysql.slow_log2 TO mysql.slow_log;
     INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user, 'rotate_slow_log', v_mysql_version);
     COMMIT;
     SET @@sql_log_bin=sql_logging;
     SET GLOBAL slow_query_log=b_slow_query_log;
   END;
END |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_clean_replication_status                           | def             | mysql          | rds_clean_replication_status                           | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  DECLARE v_has_replication_log_file_column INT;
  DECLARE v_has_replication_stop_point_column INT;
  DECLARE v_has_replication_gtid_column INT;
  DECLARE v_current_security_context_user VARCHAR(352);
  
  
  
  
  SELECT CURRENT_USER() INTO v_current_security_context_user;
  IF v_current_security_context_user <> 'rdsadmin@localhost' THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Must be rdsadmin@localhost to call this procedure';
  END IF;
  SELECT count(*) INTO v_has_replication_log_file_column FROM information_schema.columns WHERE table_schema = 'mysql' AND column_name = 'replication_log_file' AND table_name = 'rds_replication_status';
  SELECT count(*) INTO v_has_replication_stop_point_column FROM information_schema.columns WHERE table_schema = 'mysql' AND column_name = 'replication_stop_point' AND table_name = 'rds_replication_status';
  SELECT count(*) INTO v_has_replication_gtid_column FROM information_schema.columns WHERE table_schema = 'mysql' AND column_name = 'replication_gtid' AND table_name = 'rds_replication_status';
  IF v_has_replication_log_file_column > 0 THEN
    UPDATE mysql.rds_replication_status SET replication_log_file=NULL WHERE action IS NOT NULL;
  END IF;
  IF v_has_replication_stop_point_column > 0 THEN
    UPDATE mysql.rds_replication_status SET replication_stop_point=NULL WHERE action IS NOT NULL;
  END IF;
  IF v_has_replication_gtid_column > 0 THEN
    UPDATE mysql.rds_replication_status SET replication_gtid=NULL WHERE action IS NOT NULL;
  END IF;
  commit;
END |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | INVOKER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_clean_replication_status_for_channel               | def             | mysql          | rds_clean_replication_status_for_channel               | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  DECLARE v_has_replication_log_file_column INT;
  DECLARE v_has_replication_stop_point_column INT;
  DECLARE v_has_replication_gtid_column INT;
  DECLARE v_has_replication_channel_name_column INT;
  DECLARE v_current_security_context_user VARCHAR(352);
  DECLARE sql_logging BOOLEAN;
  SELECT @@sql_log_bin INTO sql_logging;
  SELECT CURRENT_USER() INTO v_current_security_context_user;
  IF CONVERT(v_current_security_context_user USING utf8mb4) COLLATE utf8mb4_0900_ai_ci <> CONVERT('rdsadmin@localhost' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Must be rdsadmin@localhost to call this procedure';
  END IF;
  SELECT count(*) INTO v_has_replication_log_file_column FROM information_schema.columns WHERE table_schema = 'mysql' AND column_name = 'replication_log_file' AND table_name = 'rds_replication_status';
  SELECT count(*) INTO v_has_replication_stop_point_column FROM information_schema.columns WHERE table_schema = 'mysql' AND column_name = 'replication_stop_point' AND table_name = 'rds_replication_status';
  SELECT count(*) INTO v_has_replication_gtid_column FROM information_schema.columns WHERE table_schema = 'mysql' AND column_name = 'replication_gtid' AND table_name = 'rds_replication_status';
  SELECT count(*) INTO v_has_replication_channel_name_column FROM information_schema.columns WHERE table_schema = 'mysql' AND column_name = 'channel_name' AND table_name = 'rds_replication_status';
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    IF v_has_replication_channel_name_column > 0 THEN
      IF v_has_replication_log_file_column > 0 THEN
        UPDATE mysql.rds_replication_status SET replication_log_file=NULL WHERE action IS NOT NULL AND CONVERT(QUOTE(channel_name) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
      END IF;
      IF v_has_replication_stop_point_column > 0 THEN
        UPDATE mysql.rds_replication_status SET replication_stop_point=NULL WHERE action IS NOT NULL AND CONVERT(QUOTE(channel_name) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
      END IF;
      IF v_has_replication_gtid_column > 0 THEN
        UPDATE mysql.rds_replication_status SET replication_gtid=NULL WHERE action IS NOT NULL AND CONVERT(QUOTE(channel_name) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
      END IF;
    ELSE
      IF v_has_replication_log_file_column > 0 THEN
        UPDATE mysql.rds_replication_status SET replication_log_file=NULL WHERE action IS NOT NULL;
      END IF;
      IF v_has_replication_stop_point_column > 0 THEN
        UPDATE mysql.rds_replication_status SET replication_stop_point=NULL WHERE action IS NOT NULL;
      END IF;
      IF v_has_replication_gtid_column > 0 THEN
        UPDATE mysql.rds_replication_status SET replication_gtid=NULL WHERE action IS NOT NULL;
      END IF;
    END IF;
    COMMIT;
    SET @@sql_log_bin=sql_logging;
  END;
END |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | INVOKER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_external_master                                    | def             | mysql          | rds_external_master                                    | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  DECLARE v_rdsrepl INT;
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE v_service_state ENUM('ON', 'OFF', 'BROKEN');
  DECLARE v_called_by_user VARCHAR(352);
  DECLARE v_rep_status int;
  DECLARE v_rep_status_stop int;
  DECLARE sql_logging BOOLEAN;
  SELECT @@sql_log_bin, user(), version(), mysql.rds_replication_service_state() INTO sql_logging, v_called_by_user, v_mysql_version, v_service_state;
  Select count(1) into v_rep_status_stop from mysql.rds_replication_status where action = 'stop slave';
  Select count(1) into v_rep_status from mysql.rds_replication_status;
  Select count(1) into v_rdsrepl from mysql.rds_history where action = 'disable set master' and master_user = 'rdsrepladmin';
  
  IF v_called_by_user != 'rdsadmin@localhost'
  THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'You do not have privileges to call this procedure';
  END IF;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    IF v_rep_status = 0
    Then
      
      insert into mysql.rds_replication_status(called_by_user, action, mysql_version)values (v_called_by_user,'disable set master',v_mysql_version);
      insert into mysql.rds_history(called_by_user, action, master_user, mysql_version)values (v_called_by_user,'disable set master','rdsrepladmin',v_mysql_version);
      commit;
    ELSEIF phase not in ('enable','disable')
    then
      
      
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Please use the values enable or disable for the phase argument';
    
    
    ElseIF v_rdsrepl > 0 and phase = 'disable'
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'MYSQL.RDS_SET_EXTERNAL_MASTER is disabled';
    
    ElseIF v_rdsrepl = 0 and phase = 'disable'
    THEN
      if v_service_state in ('ON'  , 'BROKEN'  )
      then
        call mysql.rds_stop_replication();
        DO SLEEP(1);
        update mysql.rds_replication_status set called_by_user=v_called_by_user, action='disable set master', mysql_version=v_mysql_version where action is not null;
        commit;
        DO SLEEP(1);
        INSERT into mysql.rds_history(called_by_user, action, mysql_version, master_user) values (v_called_by_user,'disable set master', v_mysql_version, 'rdsrepladmin');
        commit;
        select 'Replication has been stopped and MYSQL.RDS_SET_EXTERNAL_MASTER has been disabled' as message;
      else 
        update mysql.rds_replication_status set called_by_user=v_called_by_user, action='disable set master', mysql_version=v_mysql_version where action is not null;
        commit;
        DO SLEEP(1);
        INSERT into mysql.rds_history(called_by_user, action, mysql_version, master_user) values (v_called_by_user,'disable set master', v_mysql_version, 'rdsrepladmin');
        commit;
        Select 'MYSQL.RDS_SET_EXTERNAL_MASTER has been disabled' as message;
      end if;
    
    ELSEIF v_rdsrepl = 0 and phase = 'enable'
    THEN
      if v_service_state in ('ON'  , 'BROKEN'  )
      then
        update mysql.rds_replication_status set called_by_user=v_called_by_user,action='enable set master', mysql_version=v_mysql_version where action is not null;
        commit;
        select 'MYSQL.RDS_SET_EXTERNAL_MASTER is enabled.' as message;
        
      end if;
    ELSEIF v_rdsrepl > 0 and phase = 'enable'
    THEN
      update mysql.rds_replication_status set called_by_user=v_called_by_user,action='enable set master', mysql_version=v_mysql_version where action is not null;
      commit;
      DO SLEEP(1);
      UPDATE mysql.rds_history set action = 'enable set master' where action = 'disable set master' and master_user = 'rdsrepladmin';
      commit;
      select 'MYSQL.RDS_SET_EXTERNAL_MASTER has been enabled' as message;
    END IF;
    IF v_rep_status_stop = 1
    Then
      update mysql.rds_replication_status set called_by_user=v_called_by_user,action='stop slave', mysql_version=v_mysql_version where action is not null;
      commit;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
END |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_reset_external_master                              | def             | mysql          | rds_reset_external_master                              | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  CALL mysql.rds_reset_external_source_for_channel('');
END                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_reset_external_source_for_channel                  | def             | mysql          | rds_reset_external_source_for_channel                  | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
 DECLARE v_rdsrepl INT;
 DECLARE v_mysql_version VARCHAR(20);
 DECLARE v_called_by_user VARCHAR(352);
 DECLARE v_channel_service_state ENUM('ON', 'OFF', 'BROKEN', 'NOT_EXIST');
 DECLARE sql_logging BOOLEAN;
 SELECT @@sql_log_bin, user(), version(), mysql.rds_replication_service_state_for_channel(channel) into sql_logging, v_called_by_user, v_mysql_version, v_channel_service_state;
 SELECT count(1) INTO v_rdsrepl from mysql.rds_history WHERE CONVERT(action USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('disable set master' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci and CONVERT(master_user USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('rdsrepladmin' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
 BEGIN
   DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
   SET @@sql_log_bin=OFF;
   IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
   THEN
     INSERT INTO mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user,'Starting: reset slave', v_mysql_version);
     COMMIT;
   ELSE
     INSERT INTO mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user,'Starting: reset replica for channel', v_mysql_version);
     COMMIT;
   END IF;
   SET @@sql_log_bin=sql_logging;
 END;
 IF v_rdsrepl > 0 and CONVERT(v_called_by_user USING utf8mb4) COLLATE utf8mb4_0900_ai_ci != CONVERT('rdsadmin@localhost' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
 THEN
     SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Permission Denied: This instance is a RDS Read Replica.';
 ELSEIF CONVERT(v_called_by_user USING utf8mb4) COLLATE utf8mb4_0900_ai_ci != CONVERT('rdsadmin@localhost' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci AND CONVERT(mysql.rds_is_semi_sync() USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('REPLICA' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
 THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Permission Denied: Replication for Multi-AZ clusters is managed exclusively by RDS.';
 END IF;
 BEGIN
   DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
   SET @@sql_log_bin=OFF;
   IF CONVERT(v_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('NOT_EXIST' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci 
   THEN
     IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
     THEN
       SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'You can't reset replication because replication isn't configured. First run mysql.rds_set_external_master.';
     ELSE
       SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'The given channel does not exist. Run SHOW REPLICA STATUS\G to find all existing channel names.';
     END IF;
   ELSEIF CONVERT(v_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('OFF' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
   THEN
     CALL mysql.rds_clean_replication_status_for_channel(channel);
   ELSE 
     SET @cmd = CONCAT('STOP REPLICA FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)));
     PREPARE rds_stop_replica_for_channel FROM @cmd;
     EXECUTE rds_stop_replica_for_channel;
     DEALLOCATE PREPARE rds_stop_replica_for_channel;
     DO SLEEP(2);
     CALL mysql.rds_clean_replication_status_for_channel(channel);
   END IF;
   SET @cmd = CONCAT('RESET REPLICA ALL FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)));
   PREPARE rds_reset_replica_for_channel FROM @cmd;
   EXECUTE rds_reset_replica_for_channel;
   DEALLOCATE PREPARE rds_reset_replica_for_channel;
   IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
   THEN
      INSERT INTO mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user,'reset slave', v_mysql_version);
      COMMIT;
   ELSE
      INSERT INTO mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user,'reset replica for channel', v_mysql_version);
      COMMIT;
   END IF;
   
   IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
   THEN
     UPDATE mysql.rds_replication_status SET called_by_user=v_called_by_user, action='reset slave', mysql_version=v_mysql_version, master_host=NULL, master_port=NULL WHERE action is not null AND (CONVERT(channel_name USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci OR channel_name IS NULL);
     COMMIT;
     SELECT 'Slave has been reset' as message;
   ELSE
     DELETE FROM mysql.rds_replication_status WHERE CONVERT(QUOTE(channel_name) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
     COMMIT;
     SELECT CONCAT('Replication has been reset for channel ', QUOTE(TRIM(BOTH FROM channel))) as message;
   END IF;
   SET @@sql_log_bin=sql_logging;
 END;
END |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_set_external_master_with_auto_position             | def             | mysql          | rds_set_external_master_with_auto_position             | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  CALL mysql.rds_set_external_source_with_auto_position_for_channel(host, port, user, passwd, enable_ssl_encryption, delay, '');
END                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_set_external_source_with_auto_position_for_channel | def             | mysql          | rds_set_external_source_with_auto_position_for_channel | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  DECLARE v_rdsrepl INT;
  DECLARE v_same_name_channel_service_state ENUM('ON', 'OFF', 'BROKEN', 'NOT_EXIST');
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE v_called_by_user VARCHAR(352);
  DECLARE sql_logging BOOLEAN;
  DECLARE v_channel_count INT;
  DECLARE v_same_source_count INT;
  SELECT @@sql_log_bin, user(), version(), mysql.rds_replication_service_state_for_channel(channel) INTO sql_logging, v_called_by_user, v_mysql_version, v_same_name_channel_service_state;
  SELECT count(1) INTO v_rdsrepl from mysql.rds_history WHERE CONVERT(action USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('disable set master' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci and CONVERT(master_user USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('rdsrepladmin' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
  SELECT count(1) INTO v_channel_count FROM performance_schema.replication_connection_status WHERE CONVERT(QUOTE(channel_name) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci != CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
  SELECT count(1) INTO v_same_source_count FROM performance_schema.replication_connection_configuration rcc WHERE rcc.HOST = host AND rcc.PORT = port AND CONVERT(QUOTE(rcc.CHANNEL_NAME) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci != CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      INSERT INTO mysql.rds_history(called_by_user, action, mysql_version, master_host, master_port, master_user, master_ssl, master_delay, auto_position)
      VALUES (v_called_by_user,'Starting: set master AP', v_mysql_version, trim(both from host), port, trim(both from user), enable_ssl_encryption, delay, 1);
      COMMIT;
    ELSE
      INSERT INTO mysql.rds_history(called_by_user, action, mysql_version, master_host, master_port, master_user, master_ssl, master_delay, auto_position)
      VALUES (v_called_by_user,'Starting: set channel AP', v_mysql_version, trim(both from host), port, trim(both from user), enable_ssl_encryption, delay, 1);
      COMMIT;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
  IF delay NOT BETWEEN 0 AND 86400
  THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'For source delay the value must be between 0 and 86400 inclusive.';
  END IF;
  IF v_rdsrepl > 0 and CONVERT(v_called_by_user USING utf8mb4) COLLATE utf8mb4_0900_ai_ci != CONVERT('rdsadmin@localhost' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
  THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Permission Denied: This instance is a RDS Read Replica.';
  ELSEIF CONVERT(v_called_by_user USING utf8mb4) COLLATE utf8mb4_0900_ai_ci != CONVERT('rdsadmin@localhost' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci AND CONVERT(mysql.rds_is_semi_sync() USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('REPLICA' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
  THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Permission Denied: Replication for Multi-AZ clusters is managed exclusively by RDS.';
  END IF;
  IF CONVERT(v_same_name_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('ON' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci OR CONVERT(v_same_name_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('BROKEN' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
  THEN
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'You can't modify replication because replication is running. First call mysql.rds_stop_replication.';
    ELSE
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'You can't modify the given channel because replication is running. First call mysql.rds_stop_replication_for_channel.';
    END IF;
  END IF;
  
  IF v_channel_count >= 15
  THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Maximum 15 channels are allowed in multi source replication on RDS.';
  END IF;
  
  IF v_same_source_count > 0
  THEN
    
    SET @error_message = CONCAT('Use multiple channels to replicate from the host: ', host, ' and port: ', port, ' is not supported.');
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @error_message;
  END IF;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    
    SET @cmd = CONCAT('CHANGE REPLICATION SOURCE TO',
                      ' SOURCE_HOST = ', QUOTE(TRIM(BOTH FROM host)),
                      ', SOURCE_PORT = ', port, 
                      ', SOURCE_USER = ', QUOTE(TRIM(BOTH FROM user)),
                      ', SOURCE_PASSWORD = ', QUOTE(TRIM(BOTH FROM passwd)),
                      ', SOURCE_SSL = ', enable_ssl_encryption, 
                      ', SOURCE_AUTO_POSITION = 1',
                      ', SOURCE_DELAY = ', delay, 
                      ' FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel))
                     );
    PREPARE rds_set_source_for_channel FROM @cmd;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      UPDATE mysql.rds_replication_status SET called_by_user=v_called_by_user, action='set master', mysql_version=v_mysql_version , master_host=trim(both from host), master_port=port WHERE action is not null AND (CONVERT(channel_name USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci OR channel_name IS NULL);
      COMMIT;
    ELSE
      DELETE FROM mysql.rds_replication_status WHERE CONVERT(QUOTE(channel_name) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
      COMMIT;
      INSERT INTO mysql.rds_replication_status(called_by_user, action, mysql_version, master_host, master_port, channel_name)
        VALUES (v_called_by_user, 'set channel source', v_mysql_version, trim(both from host), port, channel);
      COMMIT;
    END IF;
    CALL mysql.rds_clean_replication_status_for_channel(channel);
    EXECUTE rds_set_source_for_channel;
    DEALLOCATE PREPARE rds_set_source_for_channel;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      INSERT INTO mysql.rds_history(called_by_user, action, mysql_version, master_host, master_port, master_user, master_ssl, master_delay, auto_position)
        VALUES (v_called_by_user,'set master with AP', v_mysql_version, trim(both from host), port, trim(both from user), enable_ssl_encryption, delay, 1);
      COMMIT;
      
      
      UPDATE mysql.rds_configuration
        SET mysql.rds_configuration.value = delay
        WHERE CAST(mysql.rds_configuration.name AS BINARY) = 'source delay';
      COMMIT;
    ELSE
      INSERT INTO mysql.rds_history(called_by_user, action, mysql_version, master_host, master_port, master_user, master_ssl, master_delay, auto_position)
        VALUES (v_called_by_user,'set channel with AP', v_mysql_version, trim(both from host), port, trim(both from user), enable_ssl_encryption, delay, 1);
      COMMIT;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
END |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_set_source_delay_for_channel                       | def             | mysql          | rds_set_source_delay_for_channel                       | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE v_called_by_user VARCHAR(352);
  DECLARE sql_logging BOOLEAN;
  DECLARE v_service_state_for_channel ENUM('ON', 'OFF', 'BROKEN', 'NOT_EXIST');
  SELECT @@sql_log_bin, user(), version(), mysql.rds_replication_service_state_for_channel(channel) INTO sql_logging, v_called_by_user, v_mysql_version, v_service_state_for_channel;
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      INSERT INTO mysql.rds_history(called_by_user, action, mysql_version, master_delay) VALUES(v_called_by_user, 'Starting: set source delay', v_mysql_version, delay);
      COMMIT;
    ELSE
      INSERT INTO mysql.rds_history(called_by_user, action, mysql_version, master_delay) VALUES(v_called_by_user, 'Starting: set source delay channel', v_mysql_version, delay);
      COMMIT;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
  IF CONVERT(rds_is_semi_sync() USING utf8mb4) COLLATE utf8mb4_0900_ai_ci != CONVERT('NO' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Source delay is not supported on the MySQL Multi-AZ cluster';
  ELSEIF delay IS NULL OR delay NOT BETWEEN 0 AND 86400 THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'For source delay the value must be between 0 and 86400 inclusive.';
  END IF;
  IF CONVERT(v_service_state_for_channel USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('NOT_EXIST' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci 
  THEN
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'You can't set replication delay because the replica isn't configured. First call mysql.rds_set_external_master.';
    ELSE
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'The given channel does not exist. Run SHOW REPLICA STATUS\G to find all existing channel names.';
    END IF;
  ELSEIF CONVERT(v_service_state_for_channel USING utf8mb4) COLLATE utf8mb4_0900_ai_ci in (CONVERT('ON' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci  , CONVERT('BROKEN' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci  )
  THEN
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'You can't set replication delay because replication is running. First call mysql.rds_stop_replication.';
    ELSE
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'You can't set replication delay for the given channel when replication is running. First call rds_stop_replication_for_channel.';
    END IF;
  END IF;
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    SET @cmd = CONCAT('CHANGE REPLICATION SOURCE TO SOURCE_DELAY = ', delay, ' FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)));
    PREPARE rds_set_delay_for_channel FROM @cmd;
    EXECUTE rds_set_delay_for_channel;
    DEALLOCATE PREPARE rds_set_delay_for_channel;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      UPDATE mysql.rds_configuration SET value = delay WHERE CONVERT(name USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('source delay' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
      COMMIT;
      INSERT INTO mysql.rds_history(called_by_user, action, mysql_version, master_delay) VALUES(v_called_by_user, 'set source delay', v_mysql_version, delay);
      COMMIT;
      SELECT 'source delay is set successfully.' AS Message;
    ELSE
      INSERT INTO mysql.rds_history(called_by_user, action, mysql_version, master_delay) VALUES(v_called_by_user, 'source delay channel', v_mysql_version, delay);
      COMMIT;
      SELECT CONCAT('source delay is set successfully for channel ', QUOTE(TRIM(BOTH FROM channel))) AS Message;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
END |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_start_replication                                  | def             | mysql          | rds_start_replication                                  | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  CALL mysql.rds_start_replication_for_channel('');
END                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_start_replication_for_channel                      | def             | mysql          | rds_start_replication_for_channel                      | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE v_semi_sync ENUM('SOURCE', 'REPLICA', 'NO');
  DECLARE v_called_by_user VARCHAR(50);
  DECLARE v_channel_service_state ENUM('ON', 'OFF', 'BROKEN', 'NOT_EXIST');
  DECLARE sql_logging BOOLEAN;
  DECLARE skip_repl_error INT;
  SELECT @@sql_log_bin, user(), version(), mysql.rds_replication_service_state_for_channel(channel), mysql.rds_is_semi_sync()
  INTO sql_logging, v_called_by_user, v_mysql_version, v_channel_service_state, v_semi_sync;
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      INSERT INTO mysql.rds_history (called_by_user,action,mysql_version) VALUES (v_called_by_user, 'Starting: start slave', v_mysql_version);
      COMMIT;
    ELSE
      INSERT INTO mysql.rds_history (called_by_user,action,mysql_version) VALUES (v_called_by_user, 'Starting: start channel', v_mysql_version);
      COMMIT;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
  IF CONVERT(v_called_by_user USING utf8mb4) COLLATE utf8mb4_0900_ai_ci != CONVERT('rdsadmin@localhost' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci AND CONVERT(v_semi_sync USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('REPLICA' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
  THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Permission Denied: Replication for Multi-AZ clusters is managed exclusively by RDS.';
  ELSEIF CONVERT(v_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('ON' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci 
  THEN
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Replication may already be running. Call rds_stop_replication to stop replication';
    ELSE
      SET @message_text = CONCAT('Replication may already be running for channel. Run SHOW REPLICA STATUS FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)), '\G .' );
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @message_text;
    END IF;
  ELSEIF CONVERT(v_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('NOT_EXIST' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci 
  THEN
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SET @message_text = CONCAT('You can't start replication because the replica isn't configured. First call mysql.rds_set_external_master.');
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @message_text;
    ELSE
      SET @message_text = CONCAT('The given channel does not exist. Run SHOW REPLICA STATUS\G to find all existing channel names.');
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @message_text;
    END IF;
  ELSEIF CONVERT(v_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('BROKEN' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci 
  THEN
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      
      
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Replication might be running. First call mysql.rds_stop_replication.';
    ELSE
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'The replication on given channel might be running. First call mysql.rds_stop_replication_for_channel.';
    END IF;
  ELSEIF CONVERT(v_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('OFF' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci 
  THEN
    
    BEGIN
      DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
      SET @@sql_log_bin=OFF;
      IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
      THEN
        SET @action = 'start slave';
      ELSE
        SET @action = 'start channel';
      END IF;
      SET @cmd = CONCAT('START REPLICA FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)));
      PREPARE rds_start_replica_for_channel FROM @cmd;
      UPDATE mysql.rds_replication_status rrs SET called_by_user=v_called_by_user, action=@action, mysql_version=v_mysql_version
                                              WHERE rrs.action IS NOT NULL AND CONVERT(QUOTE(rrs.channel_name) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
      COMMIT;
      CALL mysql.rds_clean_replication_status_for_channel(channel);
      DO SLEEP(1);
      SELECT @@global.sql_replica_skip_counter INTO skip_repl_error;
      IF skip_repl_error = 0
      THEN
        EXECUTE rds_start_replica_for_channel;
      ELSE
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Another session currently running the procedure mysql.rds_skip_repl_error_for_channel. Consider retrying the procedure call.';
      END IF;
      DO SLEEP(2);
      SELECT mysql.rds_replication_service_state_for_channel(channel) INTO v_channel_service_state;
      IF CONVERT(v_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('ON' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
      THEN
        INSERT INTO mysql.rds_history (called_by_user,action,mysql_version) VALUES (v_called_by_user, @action, v_mysql_version);
        COMMIT;
        IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
        THEN
          SELECT 'Replication started. Slave is now running normally.' AS Message;
        ELSE
          SELECT CONCAT('Replication started for channel ', QUOTE(TRIM(BOTH FROM channel)), ' and replication is now running normally.') AS Message;
        END IF;
      ELSE
        IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
        THEN
          SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Slave has encountered an error. Run SHOW SLAVE STATUS\G; to see the error.';
        ELSE
          SET @message_text = CONCAT('Start replication failed. To see the error, run SHOW REPLICA STATUS FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)), '\G .');
          SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @message_text;
        END IF;
      END IF;
      DEALLOCATE PREPARE rds_start_replica_for_channel;
      SET @@sql_log_bin=sql_logging;
    END;
  END IF;
END |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_stop_replication                                   | def             | mysql          | rds_stop_replication                                   | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  CALL mysql.rds_stop_replication_for_channel('');
END                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_stop_replication_for_channel                       | def             | mysql          | rds_stop_replication_for_channel                       | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE v_called_by_user VARCHAR(50);
  DECLARE v_channel_service_state ENUM('ON', 'OFF', 'BROKEN', 'NOT_EXIST');
  DECLARE sql_logging BOOLEAN;
  SELECT @@sql_log_bin, user(), version(), mysql.rds_replication_service_state_for_channel(channel) INTO sql_logging, v_called_by_user, v_mysql_version, v_channel_service_state;
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      INSERT INTO mysql.rds_history (called_by_user,action,mysql_version) VALUES (v_called_by_user, 'Starting: stop slave', v_mysql_version);
      COMMIT;
    ELSE
      INSERT INTO mysql.rds_history (called_by_user,action,mysql_version) VALUES (v_called_by_user, 'Starting: stop channel', v_mysql_version);
      COMMIT;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
  IF CONVERT(v_called_by_user USING utf8mb4) COLLATE utf8mb4_0900_ai_ci != CONVERT('rdsadmin@localhost' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci AND CONVERT(mysql.rds_is_semi_sync() USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('REPLICA' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
  THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Permission Denied: Replication for Multi-AZ clusters is managed exclusively by RDS.';
  END IF;
  IF CONVERT(v_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('OFF' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
  THEN
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Slave is already stopped or may not be configured. Run SHOW SLAVE STATUS\G;';
    ELSE
      SET @message_text = CONCAT('Replication is already stopped for the given channel. Run SHOW REPLICA STATUS\G .');
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @message_text;
    END IF;
  ELSEIF CONVERT(v_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('NOT_EXIST' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci 
  THEN
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'You can't stop replication because the replica isn't configured. First call mysql.rds_set_external_master.';
    ELSE
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'The given channel does not exist. Run SHOW REPLICA STATUS\G to find all existing channel names.';
    END IF;
  ELSE
    BEGIN
      DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
      SET @@sql_log_bin=OFF;
      IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
      THEN
        SET @action = 'stop slave';
      ELSE
        SET @action = 'stop channel';
      END IF;
      SET @cmd = CONCAT('STOP REPLICA FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)));
      PREPARE rds_stop_replica_for_channel FROM @cmd;
      UPDATE mysql.rds_replication_status rrs SET called_by_user=v_called_by_user, action=@action, mysql_version=v_mysql_version
                                              WHERE rrs.action IS NOT NULL AND CONVERT(QUOTE(rrs.channel_name) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
      COMMIT;
      DO SLEEP(1);
      EXECUTE rds_stop_replica_for_channel;
      DO SLEEP(2);
      SELECT mysql.rds_replication_service_state_for_channel(channel) INTO v_channel_service_state;
      IF CONVERT(v_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('OFF' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
      THEN
        INSERT INTO mysql.rds_history (called_by_user,action,mysql_version) VALUES (v_called_by_user, @action, v_mysql_version);
        COMMIT;
        IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
        THEN
          SELECT 'Slave is now down or disabled' AS Message;
        ELSE
          SELECT CONCAT('Replication for channel ', QUOTE(TRIM(BOTH FROM channel)), ' is down or disabled.') AS Message;
        END IF;
      ELSE
        IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
        THEN
          SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Slave has encountered an error. Run SHOW SLAVE STATUS\G; to see the error.';
        ELSE
          SET @message_text = CONCAT('Stop replication failed. To see the error, run SHOW REPLICA STATUS FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)), '\G .');
          SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @message_text;
        END IF;
      END IF;
      DEALLOCATE PREPARE rds_stop_replica_for_channel;
      SET @@sql_log_bin=sql_logging;
    END;
  END IF;
END |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_is_semi_sync                                       | def             | mysql          | rds_is_semi_sync                                       | FUNCTION     | enum      |                        7 |                     28 |              NULL |          NULL |               NULL | utf8mb4            | utf8mb4_0900_ai_ci | enum('SOURCE','REPLICA','NO')         | SQL          | BEGIN
  DECLARE is_semi_sync_source INTEGER;
  DECLARE is_semi_sync_replica INTEGER;
  
  
  
  
  
  
  
  
  
  
  SELECT SUM(variable_value = 'ON' AND variable_name in ('rpl_semi_sync_source_enabled', 'rpl_semi_sync_master_enabled')),
         SUM(variable_value = 'ON' AND variable_name in ('rpl_semi_sync_replica_enabled', 'rpl_semi_sync_slave_enabled'))
  INTO is_semi_sync_source, is_semi_sync_replica
  FROM performance_schema.global_variables;
  IF is_semi_sync_source > 0 THEN
    RETURN 'SOURCE';
  ELSEIF is_semi_sync_replica > 0 THEN
    RETURN 'REPLICA';
  ELSE
    RETURN 'NO';
  END IF;
END                                                                                                                                                                                                                                                                                                                                                                                                                                   |          NULL | SQL               | SQL             | NO               | READS SQL DATA  |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_replication_service_state                          | def             | mysql          | rds_replication_service_state                          | FUNCTION     | enum      |                        6 |                     24 |              NULL |          NULL |               NULL | utf8mb4            | utf8mb4_0900_ai_ci | enum('ON','OFF','BROKEN')             | SQL          | BEGIN
  DECLARE v_service_state ENUM('ON', 'OFF', 'BROKEN');
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
    
    SELECT COALESCE(MAX(
      CASE WHEN rcs.service_state = 'ON' and rca.service_state = 'ON' THEN 'ON'
           WHEN rcs.service_state = 'OFF' and rca.service_state = 'OFF' THEN 'OFF'
           ELSE 'BROKEN' END), 'OFF')
    INTO v_service_state
    FROM performance_schema.replication_connection_status rcs
    JOIN performance_schema.replication_applier_status rca USING (channel_name)
    WHERE channel_name='';
  RETURN v_service_state;
END                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |          NULL | SQL               | SQL             | NO               | READS SQL DATA  |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_replication_service_state_for_channel              | def             | mysql          | rds_replication_service_state_for_channel              | FUNCTION     | enum      |                        9 |                     36 |              NULL |          NULL |               NULL | utf8mb4            | utf8mb4_0900_ai_ci | enum('ON','OFF','BROKEN','NOT_EXIST') | SQL          | BEGIN
  DECLARE v_service_state ENUM('ON', 'OFF', 'BROKEN', 'NOT_EXIST');
  SELECT COALESCE(MAX(
    CASE WHEN rcs.service_state = 'ON' AND rca.service_state = 'ON' THEN 'ON'
       WHEN rcs.service_state = 'OFF' AND rca.service_state = 'OFF' THEN 'OFF'
       ELSE 'BROKEN' END), 'NOT_EXIST')
  INTO v_service_state
  FROM performance_schema.replication_connection_status rcs
           JOIN performance_schema.replication_applier_status rca USING (channel_name)
  WHERE CONVERT(QUOTE(channel_name) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
  RETURN v_service_state;
END                                                                                                                                                                                                                                                                                                                                                                                  |          NULL | SQL               | SQL             | NO               | READS SQL DATA  |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_set_fk_checks_off                                  | def             | mysql          | rds_set_fk_checks_off                                  | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  DECLARE v_called_by_user VARCHAR(352);
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE sql_logging BOOLEAN;
  SELECT @@sql_log_bin, user(), version() INTO sql_logging, v_called_by_user, v_mysql_version;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user,'set_fk_checks_off', v_mysql_version);
    commit;
    SET GLOBAL `foreign_key_checks`=0;
    SET SESSION `foreign_key_checks`=0;
    SET @@sql_log_bin=sql_logging;
  END;
END                                                                                                                                                                                                                                                                                                                                                                                                                        |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_set_fk_checks_on                                   | def             | mysql          | rds_set_fk_checks_on                                   | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  DECLARE v_called_by_user VARCHAR(352);
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE sql_logging BOOLEAN;
  SELECT @@sql_log_bin, user(), version() INTO sql_logging, v_called_by_user, v_mysql_version;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user,'set_fk_checks_on', v_mysql_version);
    commit;
    SET GLOBAL `foreign_key_checks`=1;
    SET SESSION `foreign_key_checks`=1;
    SET @@sql_log_bin=sql_logging;
  END;
END                                                                                                                                                                                                                                                                                                                                                                                                                         |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_collect_global_status_history                      | def             | mysql          | rds_collect_global_status_history                      | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | begin
  declare my_row_count int(5) default 0;
  DECLARE sql_logging BOOLEAN;
  select @@sql_log_bin into sql_logging;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    
    set transaction isolation level read committed;
    insert into rds_global_status_history ( collection_start, variable_name, variable_value, variable_delta )
    select b.collection_end, a.variable_name, a.variable_value, a.variable_value-coalesce(b.variable_value,0) as variable_delta
    from performance_schema.global_status a
    left outer join rds_global_status_history b on a.variable_name = b.variable_name
    where b.collection_end = (select max(collection_end) from rds_global_status_history);
    select row_count() into my_row_count;
    if my_row_count = 0
    then
      insert into rds_global_status_history ( collection_start, variable_name, variable_value, variable_delta )
      select null, variable_name, variable_value, variable_value from performance_schema.global_status ;
    end if;
    commit;
    SET @@sql_log_bin=sql_logging;
  END;
end |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_disable_gsh_collector                              | def             | mysql          | rds_disable_gsh_collector                              | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | begin
  DECLARE sql_logging BOOLEAN;
  select @@sql_log_bin into sql_logging;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    alter event ev_rds_gsh_collector DISABLE;
    select 'Collector Disabled' as `Success`;
    SET @@sql_log_bin=sql_logging;
  END;
end                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_disable_gsh_rotation                               | def             | mysql          | rds_disable_gsh_rotation                               | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | begin
  DECLARE sql_logging BOOLEAN;
  select @@sql_log_bin into sql_logging;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    alter event ev_rds_gsh_table_rotation DISABLE;
    select 'Table Rotation Disabled' as `Success`;
    SET @@sql_log_bin=sql_logging;
  END;
end                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_enable_gsh_collector                               | def             | mysql          | rds_enable_gsh_collector                               | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | begin
  call rds_set_gsh_collector(5);
end                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_enable_gsh_rotation                                | def             | mysql          | rds_enable_gsh_rotation                                | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | begin
  call rds_set_gsh_rotation(7);
end                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_rotate_global_status_history                       | def             | mysql          | rds_rotate_global_status_history                       | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  DECLARE sql_logging BOOLEAN;
  select @@sql_log_bin into sql_logging;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    drop table mysql.rds_global_status_history_old;
    rename table mysql.rds_global_status_history to mysql.rds_global_status_history_old;
    create table mysql.rds_global_status_history like mysql.rds_global_status_history_old;
    SET @@sql_log_bin=sql_logging;
  END;
END                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_set_gsh_collector                                  | def             | mysql          | rds_set_gsh_collector                                  | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | begin
  declare v_es varchar(3);
  DECLARE sql_logging BOOLEAN;
  select @@sql_log_bin into sql_logging;
  select variable_value into v_es from performance_schema.global_variables where variable_name = 'EVENT_SCHEDULER';
  
  
  
  if v_es != 'ON' then
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Scheduler is NOT Active. Please set the parameter event_scheduler=ON in your Parameter Group';
  end if;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    alter event ev_rds_gsh_collector ON SCHEDULE EVERY p_period MINUTE STARTS CURRENT_TIMESTAMP ENABLE;
    select concat('Collector Enabled every ', p_period ,' Minutes, Scheduler is Active') as `Success`;
    SET @@sql_log_bin=sql_logging;
  END;
end                                                                                                                                                                                                                                           |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_set_gsh_rotation                                   | def             | mysql          | rds_set_gsh_rotation                                   | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | begin
  declare v_es varchar(3);
  DECLARE sql_logging BOOLEAN;
  select @@sql_log_bin into sql_logging;
  select variable_value into v_es from performance_schema.global_variables where variable_name = 'EVENT_SCHEDULER';
  
  
  
  if v_es != 'ON' then
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Scheduler is NOT Active. Please set the parameter event_scheduler=ON in your Parameter Group';
  end if;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    alter event ev_rds_gsh_table_rotation ON SCHEDULE EVERY p_period DAY STARTS CURRENT_TIMESTAMP + interval p_period day ENABLE;
    select concat('Table Rotation Enabled every ', p_period ,' Days, Scheduler is Active') as `Success`;
    SET @@sql_log_bin=sql_logging;
  END;
end                                                                                                                                                                                                               |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_group_replication_advance_gtid                     | def             | mysql          | rds_group_replication_advance_gtid                     | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  DECLARE v_called_by_user VARCHAR(352);
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE v_plugin_installed INT UNSIGNED;
  DECLARE v_loop_id INT UNSIGNED;
  DECLARE sql_logging BOOLEAN;
  SELECT @@sql_log_bin, user(), version() INTO sql_logging, v_called_by_user, v_mysql_version;
  SELECT count(*) INTO v_plugin_installed FROM information_schema.plugins WHERE plugin_name='group_replication';
  IF v_plugin_installed = 0 THEN
    SIGNAL SQLSTATE 'HY000' SET MESSAGE_TEXT = 'Procedure must be executed with group_replication plugin installed.', MYSQL_ERRNO = 1524;
  END IF;
  IF begin_id = 0 or end_id = 0 THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Both start and end transaction ID of the transactions should be bigger than 0.', MYSQL_ERRNO = 1644;
  ELSEIF begin_id > end_id THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Start transaction ID should be smaller or equal to the end transaction ID.', MYSQL_ERRNO = 1644;
  END IF;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; SET @@GTID_NEXT='AUTOMATIC'; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    SET v_loop_id = begin_id;
    loop_label: LOOP
      IF v_loop_id > end_id THEN
        LEAVE loop_label;
      END IF;
      SET @@GTID_NEXT=CONCAT(server_uuid, ':', v_loop_id);
      COMMIT;
      SET v_loop_id = v_loop_id + 1;
      SET @@GTID_NEXT='AUTOMATIC';
    END LOOP;
    
    INSERT into mysql.rds_history(called_by_user, action, mysql_version, master_gtid) values
                                 (v_called_by_user, 'advance gtid', v_mysql_version, CONCAT(server_uuid, ':', begin_id, '-', end_id));
    COMMIT;
    SET @@sql_log_bin=sql_logging;
  END;
END |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_group_replication_create_user                      | def             | mysql          | rds_group_replication_create_user                      | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  DECLARE v_called_by_user VARCHAR(352);
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE v_plugin_installed INT UNSIGNED;
  DECLARE v_count_user_exist INT UNSIGNED;
  DECLARE v_count_mysql_session_exist INT UNSIGNED;
  DECLARE sql_logging BOOLEAN;
  DECLARE user_altered INT DEFAULT 0;
  SELECT @@sql_log_bin, user(), version() INTO sql_logging, v_called_by_user, v_mysql_version;
  SELECT count(*) INTO v_plugin_installed FROM information_schema.plugins WHERE plugin_name='group_replication';
  IF v_plugin_installed = 0 THEN
    SIGNAL SQLSTATE 'HY000' SET MESSAGE_TEXT = 'You must install the group_replication plugin before you call the mysql.rds_group_replication_create_user stored procedure. Install the plugin, and then run the procedure again.', MYSQL_ERRNO = 1524;
  END IF;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    
    SET @@sql_log_bin=OFF;
    
    SELECT count(*) INTO v_count_mysql_session_exist FROM mysql.user WHERE Host='localhost' AND user = 'mysql.session';
    
    IF v_count_mysql_session_exist=0 THEN
      CREATE USER IF NOT EXISTS 'mysql.session'@'localhost'
      IDENTIFIED WITH 'caching_sha2_password' AS '$A$005$THISISACOMBINATIONOFINVALIDSALTANDPASSWORDTHATMUSTNEVERBRBEUSED'
      REQUIRE NONE PASSWORD EXPIRE DEFAULT ACCOUNT LOCK PASSWORD HISTORY DEFAULT PASSWORD REUSE INTERVAL DEFAULT PASSWORD REQUIRE CURRENT DEFAULT;
      GRANT SELECT ON mysql.user to 'mysql.session'@localhost;
      GRANT SELECT ON performance_schema.* TO 'mysql.session'@localhost;
    END IF;
    
    SELECT count(*) into v_count_user_exist FROM mysql.user WHERE Host='%' and user = 'rdsgrprepladmin';
    IF v_count_user_exist>0 THEN
      SET @alter_u_cmd = CONCAT('ALTER USER rdsgrprepladmin@'%' IDENTIFIED BY ',
                  QUOTE(TRIM(BOTH FROM passwd)),
                  ';'
                  );
      PREPARE alter_u_cmd FROM @alter_u_cmd;
      EXECUTE alter_u_cmd;
      SET user_altered=1;
    ELSE
      SET @create_u_cmd = CONCAT('CREATE USER rdsgrprepladmin@'%' IDENTIFIED BY ',
                    QUOTE(TRIM(BOTH FROM passwd)),
                    ';'
                    );
      PREPARE create_u_stmt FROM @create_u_cmd;
      EXECUTE create_u_stmt;
    END IF;
    SET @grant_u_cmd = CONCAT('GRANT REPLICATION SLAVE, GROUP_REPLICATION_STREAM ',
                  'ON *.* TO rdsgrprepladmin@'%';');
    PREPARE grant_u_stmt FROM @grant_u_cmd;
    EXECUTE grant_u_stmt;
    FLUSH PRIVILEGES;
    
    IF user_altered=1 THEN
          SELECT 'Warning: Group replication user already exists, password altered. Please ensure that all your instances have the same password for this user.' AS Message;
          INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user, 'group replication user altered.', v_mysql_version);
    ELSE
          SELECT 'Group replication user created successfully.' AS Message;
          INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user, 'group replication user created.', v_mysql_version);
    END IF;
    
    SET @@sql_log_bin=sql_logging;
  END;
END |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_group_replication_set_recovery_channel             | def             | mysql          | rds_group_replication_set_recovery_channel             | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  DECLARE v_called_by_user VARCHAR(352);
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE v_plugin_installed INT UNSIGNED;
  DECLARE v_count_user_exist INT UNSIGNED;
  DECLARE sql_logging BOOLEAN;
  SELECT @@sql_log_bin, user(), version() INTO sql_logging, v_called_by_user, v_mysql_version;
  SELECT count(*) INTO v_plugin_installed FROM information_schema.plugins WHERE plugin_name='group_replication';
  SELECT count(*) into v_count_user_exist FROM mysql.user WHERE Host='%' and user = 'rdsgrprepladmin';
  IF v_plugin_installed = 0 THEN
    SIGNAL SQLSTATE 'HY000' SET MESSAGE_TEXT = 'You must install the group_replication plugin before you call the mysql.rds_group_replication_set_recovery_channel stored procedure. Install the plugin, and then run the procedure again.', MYSQL_ERRNO = 1524;
  ELSEIF v_count_user_exist = 0 THEN
    SIGNAL SQLSTATE 'HY000' SET MESSAGE_TEXT = 'The database user rdsgrprepladmin must exist to set up the group replication recovery channel. Call the stored procedure mysql.rds_group_replication_create_user to create the user, and then set up the group replication recovery channel.', MYSQL_ERRNO = 3162;
  END IF;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    SET @cmd = CONCAT('CHANGE REPLICATION SOURCE TO ',
                      'SOURCE_USER='rdsgrprepladmin'',
                      ', SOURCE_PASSWORD=', QUOTE(TRIM(BOTH FROM passwd)),
                      ' FOR CHANNEL 'group_replication_recovery''
                      );
    PREPARE stmt FROM @cmd;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
    INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user, 'set group replication recovery channel', v_mysql_version);
    COMMIT;
    SET @@sql_log_bin=sql_logging;
  END;
END |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_group_replication_start                            | def             | mysql          | rds_group_replication_start                            | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  DECLARE v_called_by_user VARCHAR(352);
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE v_plugin_installed INT UNSIGNED;
  DECLARE v_member_state VARCHAR(20);
  DECLARE sql_logging BOOLEAN;
  SELECT @@sql_log_bin, user(), version() INTO sql_logging, v_called_by_user, v_mysql_version;
  SELECT count(*) INTO v_plugin_installed FROM information_schema.plugins WHERE plugin_name='group_replication';
  IF v_plugin_installed = 0 THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Procedure must be executed with group_replication plugin installed.';
  END IF;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN
      SET @cmd = 'SET GLOBAL group_replication_bootstrap_group = OFF';
      PREPARE stmt FROM @cmd;
      EXECUTE stmt;
      DEALLOCATE PREPARE stmt;
      SET @@sql_log_bin=sql_logging;
      RESIGNAL;
    END;
    SET @@sql_log_bin=OFF;
    SET @cmd = CONCAT('SET GLOBAL group_replication_bootstrap_group = ', bootstrap);
    PREPARE stmt FROM @cmd;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
    START GROUP_REPLICATION;
    DO SLEEP(2);
    SET @cmd = 'SET GLOBAL group_replication_bootstrap_group = OFF';
    PREPARE stmt FROM @cmd;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
    INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user, CONCAT('start group replication. bootstrap:', bootstrap), v_mysql_version);
    COMMIT;
    SELECT MEMBER_STATE INTO v_member_state FROM performance_schema.replication_group_members WHERE MEMBER_ID=@@server_uuid;
    IF v_member_state = 'ONLINE' THEN
      SELECT 'Group replication started successfully.' AS Message;
    ELSEIF v_member_state = 'RECOVERING' THEN
      SELECT 'Group replication started and recovery is in progress. Run SELECT * FROM performance_schema.replication_group_members to get the current member state.' AS Message;
    ELSE
      SELECT 'Group replication might have encountered an error as member state is not ONLINE or RECOVERING. Run SELECT * FROM performance_schema.replication_group_members to get the current member state.' AS Message;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
END |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_group_replication_stop                             | def             | mysql          | rds_group_replication_stop                             | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  DECLARE v_called_by_user VARCHAR(352);
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE v_plugin_installed INT UNSIGNED;
  DECLARE v_member_state VARCHAR(20);
  DECLARE sql_logging BOOLEAN;
  SELECT @@sql_log_bin, user(), version() INTO sql_logging, v_called_by_user, v_mysql_version;
  SELECT count(*) INTO v_plugin_installed FROM information_schema.plugins WHERE plugin_name='group_replication';
  IF v_plugin_installed = 0 THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Procedure must be executed with group_replication plugin installed.';
  END IF;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    STOP GROUP_REPLICATION;
    DO SLEEP(2);
    INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user, 'stop group replication', v_mysql_version);
    COMMIT;
    SELECT MEMBER_STATE INTO v_member_state FROM performance_schema.replication_group_members WHERE MEMBER_ID=@@server_uuid;
    IF v_member_state = 'OFFLINE' THEN
      SELECT 'Group replication stopped successfully.' AS MESSAGE;
    ELSE
      SELECT 'Group replication might have encountered an error as member state is not OFFLINE. Run select * from performance_schema.replication_group_members to get the current member state.' AS MESSAGE;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
END |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_innodb_buffer_pool_dump_now                        | def             | mysql          | rds_innodb_buffer_pool_dump_now                        | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  DECLARE v_called_by_user VARCHAR(352);
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE sql_logging BOOLEAN;
  SELECT @@sql_log_bin, user(), version() INTO sql_logging, v_called_by_user, v_mysql_version;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user,'innodb_buf_dump_now', v_mysql_version);
    commit;
    SET GLOBAL `INNODB_BUFFER_POOL_DUMP_NOW`=1;
    SET @@sql_log_bin=sql_logging;
  END;
END                                                                                                                                                                                                                                                                                                                                                                                                                                                     |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_innodb_buffer_pool_load_abort                      | def             | mysql          | rds_innodb_buffer_pool_load_abort                      | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  DECLARE v_called_by_user VARCHAR(352);
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE sql_logging BOOLEAN;
  SELECT @@sql_log_bin, user(), version() INTO sql_logging, v_called_by_user, v_mysql_version;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user,'innodb_buf_ld_abort', v_mysql_version);
    commit;
    SET GLOBAL `innodb_buffer_pool_load_abort`=1;
    SET @@sql_log_bin=sql_logging;
  END;
END                                                                                                                                                                                                                                                                                                                                                                                                                                                   |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_innodb_buffer_pool_load_now                        | def             | mysql          | rds_innodb_buffer_pool_load_now                        | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  DECLARE v_called_by_user VARCHAR(352);
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE sql_logging BOOLEAN;
  SELECT @@sql_log_bin, user(), version() INTO sql_logging, v_called_by_user, v_mysql_version;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user,'innodb_buf_load_now', v_mysql_version);
    commit;
    SET GLOBAL `innodb_buffer_pool_load_now`=1;
    SET @@sql_log_bin=sql_logging;
  END;
END                                                                                                                                                                                                                                                                                                                                                                                                                                                     |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_next_master_log                                    | def             | mysql          | rds_next_master_log                                    | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  CALL mysql.rds_next_source_log_for_channel(curr_master_log, '');
END                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_next_source_log_for_channel                        | def             | mysql          | rds_next_source_log_for_channel                        | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  DECLARE v_service_state_for_channel ENUM('ON', 'OFF', 'BROKEN', 'NOT_EXIST');
  DECLARE v_called_by_user VARCHAR(352);
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE sql_logging BOOLEAN;
  DECLARE skip_repl_error INT;
  DECLARE source_log_name TEXT;
  SELECT @@sql_log_bin, user(), version(), mysql.rds_replication_service_state_for_channel(channel) INTO sql_logging, v_called_by_user, v_mysql_version, v_service_state_for_channel;
  SELECT SUBSTRING(Master_log_name, 1, CHAR_LENGTH(Master_log_name)-6) INTO source_log_name FROM mysql.slave_master_info WHERE CONVERT(QUOTE(channel_name) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      INSERT into mysql.rds_history(called_by_user, action, mysql_version, master_log_file, master_log_pos) values (v_called_by_user,'Starting: next_master_log', v_mysql_version, CONCAT('mysql-bin-changelog.', LPAD('1' + curr_source_log, 6, '0')),4);
      COMMIT;
    ELSE
      INSERT into mysql.rds_history(called_by_user, action, mysql_version, master_log_file, master_log_pos) values (v_called_by_user,'Starting: next_channel_log', v_mysql_version, CONCAT(source_log_name, LPAD('1' + curr_source_log, 6, '0')),4);
      COMMIT;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
  IF CONVERT(v_service_state_for_channel USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('NOT_EXIST' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci 
  THEN
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'You can't set the log file name because the replica isn't configured. First call mysql.rds_set_external_master.';
    ELSE
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'The given channel does not exist. Run SHOW REPLICA STATUS\G to find all existing channel names.';
    END IF;
  ELSEIF CONVERT(v_service_state_for_channel USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('ON' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci 
  THEN
    
    
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Slave is running normally.  No errors detected to skip.';
    ELSE
      SET @message_text = CONCAT('Replication is running normally and no errors detected to skip for channel - ', QUOTE(TRIM(BOTH FROM channel)), '');
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @message_text;
    END IF;
  ELSEIF CONVERT(v_service_state_for_channel USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('OFF' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci 
  THEN
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Slave is down or disabled.';
    ELSE
      SET @message_text = CONCAT('Replication is down or disabled for channel ', QUOTE(TRIM(BOTH FROM channel)));
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @message_text;
    END IF;
  ELSE 
    
    
    SELECT @@global.sql_replica_skip_counter into skip_repl_error;
    IF skip_repl_error = 0
    THEN
      SET @cmd = CONCAT('STOP REPLICA FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)));
      PREPARE rds_stop_replica_for_channel FROM @cmd;
      EXECUTE rds_stop_replica_for_channel;
      DEALLOCATE PREPARE rds_stop_replica_for_channel;
      DO SLEEP(2);
      
      IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
      THEN
        
        SET @cmd = CONCAT('CHANGE REPLICATION SOURCE TO SOURCE_LOG_FILE = ', QUOTE(CONCAT('mysql-bin-changelog.', LPAD(1 + curr_source_log, 6, '0'))) ,', SOURCE_LOG_POS = 4 FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)));
      ELSE
        
        SET @cmd = CONCAT('CHANGE REPLICATION SOURCE TO SOURCE_LOG_FILE = ', QUOTE(CONCAT(source_log_name, LPAD(1 + curr_source_log, 6, '0'))) ,', SOURCE_LOG_POS = 4 FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)));
      END IF;
      PREPARE rds_set_source FROM @cmd;
      EXECUTE rds_set_source;
      DEALLOCATE PREPARE rds_set_source;
      SET @cmd = CONCAT('START REPLICA FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)));
      PREPARE rds_start_replica_for_channel FROM @cmd;
      EXECUTE rds_start_replica_for_channel;
      DEALLOCATE PREPARE rds_start_replica_for_channel;
      DO SLEEP(2);
      IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
      THEN
        SELECT 'Master Log Position has been set to start of next log' AS Message;
      ELSE
        SELECT CONCAT('Replication Log Position has been set to start from the next binary log for channel - ', QUOTE(TRIM(BOTH FROM channel))) AS Message;
      END IF;
    ELSE
    
      SET @message_text = CONCAT('Another session currently running the procedure mysql.rds_skip_repl_error_for_channel. Consider to retry the procedure call.');
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @message_text;
    END IF;
    SELECT mysql.rds_replication_service_state_for_channel(channel) INTO v_service_state_for_channel;
    
    BEGIN
      DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
      SET @@sql_log_bin=OFF;
      IF CONVERT(v_service_state_for_channel USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('ON' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
      THEN
        IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
        THEN
          SELECT 'Slave is now running normally' AS Message;
          INSERT into mysql.rds_history(called_by_user, action, mysql_version, master_log_file, master_log_pos) values (v_called_by_user,'next_master_log:OK', v_mysql_version, CONCAT('mysql-bin-changelog.', LPAD('1' + curr_source_log, 6, '0')),4);
          COMMIT;
        ELSE
          SELECT CONCAT('Replication is now running normally for channel ', QUOTE(TRIM(BOTH FROM channel))) AS Message;
          INSERT into mysql.rds_history(called_by_user, action, mysql_version, master_log_file, master_log_pos) values (v_called_by_user,'next_channel_log:OK', v_mysql_version, CONCAT(source_log_name, LPAD('1' + curr_source_log, 6, '0')),4);
          COMMIT;
        END IF;
      ELSE
        IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
        THEN
          INSERT into mysql.rds_history(called_by_user, action, mysql_version, master_log_file, master_log_pos) values (v_called_by_user,'next_master_log:ERR', v_mysql_version, CONCAT('mysql-bin-changelog.', LPAD('1' + curr_source_log, 6, '0')),4);
          COMMIT;
          SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Slave has encountered a new error. Please use SHOW SLAVE STATUS to see the error.';
        ELSE
          INSERT into mysql.rds_history(called_by_user, action, mysql_version, master_log_file, master_log_pos) values (v_called_by_user,'next_channel_log:ERR', v_mysql_version, CONCAT(source_log_name, LPAD('1' + curr_source_log, 6, '0')),4);
          COMMIT;
          SET @message_text = CONCAT('Replication on mentioned channel encountered a new error. Run SHOW REPLICA STATUS FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)));
          SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @message_text;
        END IF;
      END IF;
      SET @@sql_log_bin=sql_logging;
    END;
  END IF;
END |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_set_external_master                                | def             | mysql          | rds_set_external_master                                | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  CALL mysql.rds_set_external_source_for_channel(host, port, user, passwd, name, pos, enable_ssl_encryption, '');
END                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_set_external_master_with_delay                     | def             | mysql          | rds_set_external_master_with_delay                     | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  CALL mysql.rds_set_external_source_with_delay_for_channel(host, port, user, passwd, name, pos, enable_ssl_encryption, delay, '');
END                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_set_external_source_for_channel                    | def             | mysql          | rds_set_external_source_for_channel                    | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  DECLARE v_rdsrepl INT;
  DECLARE v_same_name_channel_service_state ENUM('ON', 'OFF', 'BROKEN', 'NOT_EXIST');
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE v_called_by_user VARCHAR(50);
  DECLARE v_channel_count INT;
  DECLARE v_same_source_count INT;
  DECLARE sql_logging BOOLEAN;
  SELECT @@sql_log_bin, user(), version(), mysql.rds_replication_service_state_for_channel(channel) INTO sql_logging, v_called_by_user, v_mysql_version, v_same_name_channel_service_state;
  SELECT count(1) INTO v_rdsrepl from mysql.rds_history WHERE CONVERT(action USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('disable set master' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci and CONVERT(master_user USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('rdsrepladmin' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
  SELECT count(1) INTO v_channel_count FROM performance_schema.replication_connection_status WHERE CONVERT(QUOTE(channel_name) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci != CONVERT(QUOTE(TRIM(BOTH FROM channel))USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
  SELECT count(1) INTO v_same_source_count FROM performance_schema.replication_connection_configuration rcc WHERE rcc.HOST = host AND rcc.PORT = port AND CONVERT(QUOTE(rcc.CHANNEL_NAME) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci != CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      INSERT INTO mysql.rds_history(called_by_user, action, mysql_version, master_host, master_port, master_user, master_log_file, master_log_pos, master_ssl, auto_position)
      VALUES (v_called_by_user,'Starting: set master', v_mysql_version, TRIM(BOTH FROM host), port, TRIM(BOTH FROM user), TRIM(BOTH FROM log_file_name), pos, enable_ssl_encryption, 0);
      COMMIT;
    ELSE
      INSERT INTO mysql.rds_history(called_by_user, action, mysql_version, master_host, master_port, master_user, master_log_file, master_log_pos, master_ssl, auto_position)
      VALUES (v_called_by_user,'Starting: set channel', v_mysql_version, TRIM(BOTH FROM host), port, TRIM(BOTH FROM user), TRIM(BOTH FROM log_file_name), pos, enable_ssl_encryption, 0);
      COMMIT;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
  IF v_rdsrepl > 0 AND CONVERT(v_called_by_user USING utf8mb4) COLLATE utf8mb4_0900_ai_ci != CONVERT('rdsadmin@localhost' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
  THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Permission Denied: This instance is a RDS Read Replica.';
  END IF;
  IF CONVERT(v_same_name_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci != CONVERT('OFF' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci AND CONVERT(v_same_name_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci != CONVERT('NOT_EXIST' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
  THEN
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'You can't modify replication because replication is running. First call mysql.rds_stop_replication.';
    ELSE
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'You can't modify the given channel because replication is running. First call mysql.rds_stop_replication_for_channel.';
    END IF;
  END IF;
  
  IF v_channel_count >= 15
  THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Maximum 15 channels are allowed in multi-source replication on RDS.';
  END IF;
  
  IF v_same_source_count > 0
  THEN
    SET @error_message = CONCAT('Configuring multiple channels to replicate from the host: ', host, ' and port: ', port, ' is not supported.');
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @error_message;
  END IF;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    SET @cmd = CONCAT('CHANGE REPLICATION SOURCE TO',
                      ' SOURCE_HOST = ', QUOTE(TRIM(BOTH FROM host)),
                      ', SOURCE_PORT = ', port, 
                      ', SOURCE_USER = ', QUOTE(TRIM(BOTH FROM user)),
                      ', SOURCE_PASSWORD = ', QUOTE(TRIM(BOTH FROM passwd)),
                      ', SOURCE_LOG_FILE = ', QUOTE(TRIM(BOTH FROM log_file_name)),
                      ', SOURCE_LOG_POS = ', pos, 
                      ', SOURCE_SSL = ', enable_ssl_encryption, 
                      ', SOURCE_AUTO_POSITION = 0',
                      '  FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel))
                     );
    PREPARE rds_set_source FROM @cmd;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      UPDATE mysql.rds_replication_status SET called_by_user=v_called_by_user, action='set master', mysql_version=v_mysql_version, master_host=TRIM(BOTH FROM host), master_port=port WHERE CONVERT(channel_name USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci AND action IS NOT NULL;
      COMMIT;
    ELSE
      DELETE FROM mysql.rds_replication_status rrs WHERE CONVERT(QUOTE(rrs.channel_name) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
      INSERT INTO mysql.rds_replication_status(called_by_user, action, mysql_version, master_host, master_port, channel_name)
      VALUES (v_called_by_user, 'set channel source', v_mysql_version, TRIM(BOTH FROM host), port, TRIM(BOTH FROM channel));
      COMMIT;
    END IF;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      CALL mysql.rds_clean_replication_status_for_channel(channel);
    END IF;
    EXECUTE rds_set_source;
    DEALLOCATE PREPARE rds_set_source;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      INSERT INTO mysql.rds_history(called_by_user, action, mysql_version, master_host, master_port, master_user, master_log_file, master_log_pos, master_ssl, auto_position)
      VALUES (v_called_by_user,'set master', v_mysql_version, TRIM(BOTH FROM host), port, TRIM(BOTH FROM user), TRIM(BOTH FROM log_file_name), pos, enable_ssl_encryption, 0);
      COMMIT;
    ELSE
      INSERT INTO mysql.rds_history(called_by_user, action, mysql_version, master_host, master_port, master_user, master_log_file, master_log_pos, master_ssl, auto_position)
      VALUES (v_called_by_user,'set channel source', v_mysql_version, TRIM(BOTH FROM host), port, TRIM(BOTH FROM user), TRIM(BOTH FROM log_file_name), pos, enable_ssl_encryption, 0);
      COMMIT;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
END |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_set_external_source_gtid_purged                    | def             | mysql          | rds_set_external_source_gtid_purged                    | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  DECLARE v_rdsrepl INT;
  DECLARE v_active_replication_channels INT;
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE v_called_by_user VARCHAR(352);
  DECLARE sql_logging BOOLEAN;
  SELECT @@sql_log_bin, user(), version() INTO sql_logging, v_called_by_user, v_mysql_version;
  SELECT count(1) INTO v_rdsrepl from mysql.rds_history WHERE CONVERT(action USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('disable set master' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci and CONVERT(master_user USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('rdsrepladmin' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
  SELECT count(1) INTO v_active_replication_channels FROM performance_schema.replication_connection_status rcs JOIN performance_schema.replication_applier_status rca USING (channel_name) WHERE CONVERT(rcs.service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('ON' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci OR CONVERT(rca.service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('ON' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
      BEGIN
        SET @@sql_log_bin=OFF;
        INSERT INTO mysql.rds_history(called_by_user, action, mysql_version) VALUES (v_called_by_user,'set gtid_purged:ERR', v_mysql_version);
        COMMIT;
        SET @@sql_log_bin=sql_logging;
        RESIGNAL;
      END;
    SET @@sql_log_bin=OFF;
    
    INSERT INTO mysql.rds_history(called_by_user, action, mysql_version) VALUES (v_called_by_user,'begin: set gtid_purged', v_mysql_version);
    COMMIT;
    SET @@sql_log_bin=sql_logging;
    
    
    
    IF v_rdsrepl > 0 and CONVERT(v_called_by_user USING utf8mb4) COLLATE utf8mb4_0900_ai_ci != CONVERT('rdsadmin@localhost' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Permission Denied: This instance is an RDS Read Replica';
    ELSEIF CONVERT(v_called_by_user USING utf8mb4) COLLATE utf8mb4_0900_ai_ci != CONVERT('rdsadmin@localhost' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci AND (CONVERT(mysql.rds_is_semi_sync() USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('REPLICA' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci OR CONVERT(mysql.rds_is_semi_sync() USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('SOURCE' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci)
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Permission Denied: Replication for Multi-AZ clusters is managed exclusively by RDS.';
    END IF;
    
    IF v_active_replication_channels > 0
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'You can't modify gtid_purged because replication is already running.';
    END IF;
    IF CONVERT(server_uuid USING utf8mb4) COLLATE utf8mb4_0900_ai_ci REGEXP '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$' != 1
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = "Invalid input value for server_uuid";
    ELSEIF start_pos < 1
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = "Invalid input value for start_pos. The value of start_pos should be greater than or equal to 1";
    ELSEIF end_pos < start_pos
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = "Invalid input value for end_pos. The value of end_pos should be greater than or equal to start_pos value";
    END IF;
    
    
    SET @cmd = CONCAT("SELECT count(1) INTO @rds_external_gtid_count FROM mysql.gtid_executed 
                WHERE source_uuid='",server_uuid,"' and (",
    start_pos," BETWEEN interval_start AND interval_end 
    OR ",
    end_pos," BETWEEN interval_start AND interval_end 
    OR
    interval_start BETWEEN ",start_pos," AND ",end_pos,"
    OR
    interval_end BETWEEN ",start_pos," AND ",end_pos,")");
    PREPARE rds_external_gtid_check FROM @cmd;
    EXECUTE rds_external_gtid_check;
    DEALLOCATE PREPARE rds_external_gtid_check;
    IF CONVERT(server_uuid USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(@@GLOBAL.SERVER_UUID USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = "You cannot change the GTID set belongs to the current instance";
    END IF;
    IF @rds_external_gtid_count > 0
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = "The GTID set must be a superset of current @@GLOBAL.GTID_PURGED value";
    END IF;
    
    SET GLOBAL GTID_PURGED = CONCAT('+',server_uuid,':',start_pos,'-',end_pos);
    SET @@sql_log_bin=OFF;
    INSERT INTO mysql.rds_history(called_by_user, action, mysql_version) VALUES (v_called_by_user,'set gtid_purged:OK', v_mysql_version);
    COMMIT;
    SET @@sql_log_bin=sql_logging;
  END;
END |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_set_external_source_with_delay_for_channel         | def             | mysql          | rds_set_external_source_with_delay_for_channel         | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  DECLARE v_rdsrepl INT;
  DECLARE v_channel_service_state ENUM('ON', 'OFF', 'BROKEN', 'NOT_EXIST');
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE v_called_by_user VARCHAR(50);
  DECLARE v_channel_count INT;
  DECLARE v_same_source_count INT;
  DECLARE sql_logging BOOLEAN;
  SELECT @@sql_log_bin, user(), version(), mysql.rds_replication_service_state_for_channel(channel) INTO sql_logging, v_called_by_user, v_mysql_version, v_channel_service_state;
  SELECT count(1) INTO v_rdsrepl from mysql.rds_history WHERE CONVERT(action USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('disable set master' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci and CONVERT(master_user USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('rdsrepladmin' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
  SELECT count(1) INTO v_channel_count FROM performance_schema.replication_connection_status WHERE CONVERT( QUOTE(channel_name) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci != CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
  SELECT count(1) INTO v_same_source_count FROM performance_schema.replication_connection_configuration rcc WHERE rcc.HOST = host AND rcc.PORT = port AND CONVERT(QUOTE(rcc.CHANNEL_NAME) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci != CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      INSERT INTO mysql.rds_history(called_by_user,action,mysql_version,master_host,master_port,master_user,master_log_file,master_log_pos,master_ssl,master_delay,auto_position)
      VALUES (v_called_by_user,'Starting: set master',v_mysql_version,trim(both from host),port,trim(both from user),trim(both from log_file_name),pos,enable_ssl_encryption,delay, 0);
      COMMIT;
    ELSE
      INSERT INTO mysql.rds_history(called_by_user,action,mysql_version,master_host,master_port,master_user,master_log_file,master_log_pos,master_ssl,master_delay,auto_position)
      VALUES (v_called_by_user,'Starting: set channel',v_mysql_version,trim(both from host),port,trim(both from user),trim(both from log_file_name),pos,enable_ssl_encryption,delay, 0);
      COMMIT;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
  IF delay NOT BETWEEN 0 AND 86400 THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'For source delay the value must be between 0 and 86400 inclusive.';
  END IF;
  IF v_rdsrepl > 0 and CONVERT(v_called_by_user USING utf8mb4) COLLATE utf8mb4_0900_ai_ci != CONVERT('rdsadmin@localhost' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
  THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Permission Denied: This instance is a RDS Read Replica.';
  END IF;
  IF CONVERT(v_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('ON' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci OR CONVERT(v_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('BROKEN' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
  THEN
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'You can't modify replication because replication is running. First call mysql.rds_stop_replication.';
    ELSE
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'You can't modify the given channel because replication is running. First call mysql.rds_stop_replication_for_channel.';
    END IF;
  END IF;
  
  IF v_channel_count >= 15
  THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Maximum 15 channels are allowed in multi source replication on RDS';
  END IF;
  
  IF v_same_source_count > 0
  THEN
    
    SET @error_message = CONCAT('Use multiple channels to replicate from the host: ', host, ' and port: ', port, ' is not supported');
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @error_message;
  END IF;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    SET @cmd = CONCAT('CHANGE REPLICATION SOURCE TO',
                        ' SOURCE_HOST = ', QUOTE(TRIM(BOTH FROM host)),
                        ', SOURCE_PORT = ', port, 
                        ', SOURCE_USER = ', QUOTE(TRIM(BOTH FROM user)),
                        ', SOURCE_PASSWORD = ', QUOTE(TRIM(BOTH FROM passwd)),
                        ', SOURCE_LOG_FILE = ', QUOTE(TRIM(BOTH FROM log_file_name)),
                        ', SOURCE_LOG_POS = ', pos, 
                        ', SOURCE_SSL = ', enable_ssl_encryption, 
                        ', SOURCE_AUTO_POSITION = 0',
                        ', SOURCE_DELAY = ', delay, 
                        ' FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel))
        );
    PREPARE rds_set_source_with_delay FROM @cmd;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      UPDATE mysql.rds_replication_status SET called_by_user=v_called_by_user, action='set master', mysql_version=v_mysql_version , master_host=trim(both from host), master_port=port WHERE action is not null AND (CONVERT(channel_name USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci OR channel_name IS NULL);
      COMMIT;
    ELSE
      DELETE FROM mysql.rds_replication_status WHERE CONVERT(QUOTE(channel_name) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
      INSERT INTO mysql.rds_replication_status(called_by_user, action, mysql_version, master_host, master_port, channel_name) VALUES (v_called_by_user, 'set channel source', v_mysql_version, trim(both from host), port, channel);
      COMMIT;
    END IF;
    CALL mysql.rds_clean_replication_status_for_channel(channel);
    EXECUTE rds_set_source_with_delay;
    DEALLOCATE PREPARE rds_set_source_with_delay;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      INSERT INTO mysql.rds_history(called_by_user,action,mysql_version,master_host,master_port,master_user,master_log_file,master_log_pos,master_ssl,master_delay,auto_position)
        VALUES (v_called_by_user,'set master',v_mysql_version,trim(both from host),port,trim(both from user),trim(both from log_file_name),pos,enable_ssl_encryption,delay, 0);
      COMMIT;
      
      
      UPDATE mysql.rds_configuration
        SET mysql.rds_configuration.value = delay
        WHERE CAST(mysql.rds_configuration.name AS BINARY) = 'source delay';
      COMMIT;
    ELSE
      INSERT INTO mysql.rds_history(called_by_user,action,mysql_version,master_host,master_port,master_user,master_log_file,master_log_pos,master_ssl,master_delay,auto_position)
        VALUES (v_called_by_user,'set channel source',v_mysql_version,trim(both from host),port,trim(both from user),trim(both from log_file_name),pos,enable_ssl_encryption,delay, 0);
      COMMIT;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
END |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_set_master_auto_position                           | def             | mysql          | rds_set_master_auto_position                           | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  CALL mysql.rds_set_source_auto_position_for_channel(auto_position_mode, '');
END                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_set_source_auto_position_for_channel               | def             | mysql          | rds_set_source_auto_position_for_channel               | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  DECLARE v_channel_service_state ENUM('ON', 'OFF', 'BROKEN', 'NOT_EXIST');
  DECLARE v_called_by_user VARCHAR(352);
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE sql_logging BOOLEAN;
  SELECT @@sql_log_bin, user(), version(), mysql.rds_replication_service_state_for_channel(channel) INTO sql_logging, v_called_by_user, v_mysql_version, v_channel_service_state;
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      INSERT into mysql.rds_history(called_by_user, action, mysql_version, auto_position) values (v_called_by_user,'Starting: set_master_AP', v_mysql_version, auto_position_mode);
      COMMIT;
    ELSE
      INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user,'Starting: set_channel_AP',v_mysql_version);
      COMMIT;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
  IF CONVERT(v_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('NOT_EXIST' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci 
  THEN
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SET @message_text = CONCAT('You can't modify auto_position mode because the replica isn't configured. First call mysql.rds_set_external_master.');
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @message_text;
    ELSE
      SET @message_text = CONCAT('The given channel does not exist. Run SHOW REPLICA STATUS\G to find all existing channel names.');
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @message_text;
    END IF;
  END IF;
  
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    SET @cmd = CONCAT('STOP REPLICA FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)));
    PREPARE rds_stop_replica_for_channel FROM @cmd;
    EXECUTE rds_stop_replica_for_channel;
    DEALLOCATE PREPARE rds_stop_replica_for_channel;
    
    SET @cmd = CONCAT('CHANGE REPLICATION SOURCE TO SOURCE_AUTO_POSITION = ', auto_position_mode,
                       ' FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)));
    PREPARE rds_set_source_for_channel FROM @cmd;
    EXECUTE rds_set_source_for_channel;
    DEALLOCATE PREPARE rds_set_source_for_channel;
    SET @cmd = CONCAT('START REPLICA FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)));
    PREPARE rds_start_replica_for_channel FROM @cmd;
    EXECUTE rds_start_replica_for_channel;
    DEALLOCATE PREPARE rds_start_replica_for_channel;
    DO SLEEP(2);
    SELECT mysql.rds_replication_service_state_for_channel(channel) INTO v_channel_service_state;
    IF CONVERT(v_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('ON' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
      THEN
        SELECT CONCAT('Master Auto Position has been set to ', auto_position_mode,'.') AS Message;
        SELECT 'Slave is running normally' as Message;
        INSERT into mysql.rds_history(called_by_user, action, mysql_version, auto_position) values (v_called_by_user,'set_master_AP:OK', v_mysql_version, auto_position_mode);
        COMMIT;
      ELSE
        SELECT CONCAT('Source Auto Position has been set to ', auto_position_mode,' for channel ', QUOTE(TRIM(BOTH FROM channel)),'.') AS Message;
        SELECT CONCAT('Replication is running normally for channel ', QUOTE(TRIM(BOTH from channel))) as Message;
        INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user,'set_channel_AP:OK',v_mysql_version);
        COMMIT;
      END IF;
    ELSE
      IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
      THEN
        SELECT CONCAT('Master Auto Position has been set to ', auto_position_mode,'.') AS Message;
        INSERT into mysql.rds_history(called_by_user, action, mysql_version, auto_position) values (v_called_by_user,'set_master_AP:ERR', v_mysql_version, auto_position_mode);
        COMMIT;
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Slave has encountered a new error. Please use SHOW SLAVE STATUS to see the error.';
      ELSE
        SELECT CONCAT('Source Auto Position has been set to ', auto_position_mode,' for channel ', QUOTE(TRIM(BOTH FROM channel)),'.') AS Message;
        INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user,'set_channel_AP:ERR',v_mysql_version);
        COMMIT;
        SET @message_text = CONCAT('Replication for specified channel encountered a new error.Run SHOW REPLICA STATUS FOR CHANNEL ', QUOTE(TRIM(BOTH from channel)));
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @message_text;
      END IF;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
END |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_skip_repl_error                                    | def             | mysql          | rds_skip_repl_error                                    | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  CALL mysql.rds_skip_repl_error_for_channel('');
END                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_skip_repl_error_for_channel                        | def             | mysql          | rds_skip_repl_error_for_channel                        | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  DECLARE v_channel_service_state ENUM('ON', 'OFF', 'BROKEN', 'NOT_EXIST');
  DECLARE v_called_by_user VARCHAR(352);
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE sql_logging BOOLEAN;
  DECLARE v_max_applier_error_number INT;
  DECLARE skip_repl_error INT;
  SELECT @@sql_log_bin, user(), version(), mysql.rds_replication_service_state_for_channel(channel) into sql_logging, v_called_by_user, v_mysql_version, v_channel_service_state;
  SELECT MAX(rasbw.LAST_ERROR_NUMBER) INTO v_max_applier_error_number FROM performance_schema.replication_applier_status_by_worker rasbw WHERE CONVERT(QUOTE(channel_name) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user,'Starting: skip_repl_error',v_mysql_version);
      COMMIT;
    ELSE
      INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user,'Starting: skip_repl_err_ch',v_mysql_version);
      COMMIT;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
  IF CONVERT(v_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('NOT_EXIST' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci 
  THEN
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'You can't skip a replication error because the replica isn't configured. First call mysql.rds_set_external_master.';
    ELSE
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'The given channel does not exist. Run SHOW REPLICA STATUS\G to find all existing channel names.';
    END IF;
  ELSEIF CONVERT(v_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('ON' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci 
  THEN
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Slave is running normally.  No errors detected to skip.';
    ELSE
      SET @message_text = CONCAT('Replication is running normally and no errors detected to skip for channel ', QUOTE(TRIM(BOTH FROM channel)));
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @message_text;
    END IF;
  ELSEIF CONVERT(v_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('OFF' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci 
  THEN
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Slave is down or disabled.';
    ELSE
      SET @message_text = CONCAT('Replication is down or disabled for channel ', QUOTE(TRIM(BOTH FROM channel)));
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @message_text;
    END IF;
  ELSE 
    
    IF v_max_applier_error_number > 0
    THEN
      BEGIN
        DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
        SET @@sql_log_bin=OFF;
        
        
        SELECT @@global.sql_replica_skip_counter into skip_repl_error;
        IF skip_repl_error = 0
        THEN
          SET GLOBAL sql_replica_skip_counter = 1;
          SET @cmd = CONCAT('STOP REPLICA FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)));
          PREPARE rds_stop_replica_for_channel FROM @cmd;
          EXECUTE rds_stop_replica_for_channel;
          DEALLOCATE PREPARE rds_stop_replica_for_channel;
          DO SLEEP(2);
          SET @cmd = CONCAT('START REPLICA FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)));
          PREPARE rds_start_replica_for_channel FROM @cmd;
          EXECUTE rds_start_replica_for_channel;
          DEALLOCATE PREPARE rds_start_replica_for_channel;
          DO SLEEP(2);
        ELSE
          IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
          THEN
            SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'A mysql.rds_skip_repl_error procedure is in progress. Wait a few seconds before calling mysql.rds_skip_repl_error again.';
          ELSE
            SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Another skip_repl_error procedure is in progress. Wait a few seconds before calling mysql.rds_skip_repl_error_for_channel again.';
          END IF;
        END IF;
        IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
        THEN
          SELECT 'Statement in error has been skipped' as Message;
        ELSE
          SELECT CONCAT('Statement in error has been skipped for channel ', QUOTE(TRIM(BOTH from channel))) as Message;
        END IF;
        SELECT mysql.rds_replication_service_state_for_channel(channel) INTO v_channel_service_state;
        IF CONVERT(v_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('ON' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
        THEN
          IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
          THEN
            SELECT 'Slave is now running normally' as Message;
            INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user,'skip_repl_error:OK',v_mysql_version);
            COMMIT;
          ELSE
            SELECT CONCAT('Replication is running normally for channel ', QUOTE(TRIM(BOTH from channel))) as Message;
            INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user,'skip_repl_err_ch:OK',v_mysql_version);
            COMMIT;
          END IF;
        ELSE
          IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
          THEN
            INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user,'skip_repl_error:ERR',v_mysql_version);
            COMMIT;
            SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Slave has encountered a new error. Please use SHOW SLAVE STATUS to see the error.';
          ELSE
            INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user,'skip_repl_err_ch:ERR',v_mysql_version);
            COMMIT;
            SELECT CONCAT('Replication for specified channel encountered a new error. Run SHOW REPLICA STATUS FOR CHANNEL ', QUOTE(TRIM(BOTH from channel)), ';') as Message;
          END IF;
        END IF;
        SET @@sql_log_bin=sql_logging;
      END;
    ELSE
      
      IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
      THEN
        SELECT CONCAT('The replica SQL thread is running for the specified channel without encountering errors. Run SHOW REPLICA STATUS FOR CHANNEL ', QUOTE(''), ';') as Message;
      ELSE
        SELECT CONCAT('Replica SQL_Thread running normally for specified channel. Run SHOW REPLICA STATUS FOR CHANNEL ', QUOTE(TRIM(BOTH from channel)), ';') as Message;
      END IF;
    END IF;
  END IF;
END |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_skip_transaction_with_gtid                         | def             | mysql          | rds_skip_transaction_with_gtid                         | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  DECLARE v_threads_running int;
  DECLARE v_called_by_user VARCHAR(352);
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE sql_logging BOOLEAN;
  SELECT @@sql_log_bin, user(), version() INTO sql_logging, v_called_by_user, v_mysql_version;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    SET GTID_NEXT=gtid_to_skip;
    START TRANSACTION;
    COMMIT;
    SET GTID_NEXT="AUTOMATIC";
    Select 'Transaction has been skipped successfully.' as Message;
    set @@sql_log_bin=off; 
    INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user,'rds_skip_transaction_with_gtid:OK',v_mysql_version);
    commit;
    SET @@sql_log_bin=sql_logging;
  END;
END                                                                                                                                                                                                                                                     |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_start_replication_until                            | def             | mysql          | rds_start_replication_until                            | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  CALL rds_start_replication_until_for_channel(replication_log_file, replication_stop_point, '');
END                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_start_replication_until_for_channel                | def             | mysql          | rds_start_replication_until_for_channel                | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE v_called_by_user VARCHAR(352);
  DECLARE v_service_state_for_channel ENUM('ON', 'OFF', 'BROKEN', 'NOT_EXIST');
  DECLARE v_replica_parallel_workers INT;
  DECLARE sql_logging BOOLEAN;
  DECLARE skip_repl_error INT;
  SELECT @@sql_log_bin, user(), version(), mysql.rds_replication_service_state_for_channel(channel) INTO sql_logging, v_called_by_user, v_mysql_version, v_service_state_for_channel;
  SELECT @@replica_parallel_workers into v_replica_parallel_workers;
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      INSERT INTO mysql.rds_history(called_by_user, action, mysql_version, master_log_file, master_log_pos) VALUES(v_called_by_user, 'Starting: start slave until', v_mysql_version, SUBSTRING(replication_log_file, 1, 50), replication_stop_point);
      COMMIT;
    ELSE
      INSERT INTO mysql.rds_history(called_by_user, action, mysql_version, master_log_file, master_log_pos) VALUES(v_called_by_user, 'Starting: start channel until', v_mysql_version, SUBSTRING(replication_log_file, 1, 50), replication_stop_point);
      COMMIT;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
  IF CONVERT(v_service_state_for_channel USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('NOT_EXIST' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci 
  THEN
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SET @message_text = CONCAT('You can't start replication because the replica isn't configured. First call mysql.rds_set_external_master.');
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @message_text;
    ELSE
      SET @message_text = CONCAT('The given channel does not exist. Run SHOW REPLICA STATUS\G to find all existing channel names.');
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @message_text;
    END IF;
  ELSEIF CONVERT(v_service_state_for_channel USING utf8mb4) COLLATE utf8mb4_0900_ai_ci in (CONVERT('ON' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci  , CONVERT('BROKEN' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci  )
  THEN
    
    
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Replication may already be running. Call rds_stop_replication to stop replication';
    ELSE
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Replication may already be running. Call rds_stop_replication_for_channel procedure to stop replication.';
    END IF;
  ELSEIF v_replica_parallel_workers > 1
  THEN
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'rds_start_replication_until is not supported for multi-threaded slaves';
    ELSE
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'rds_start_replication_until_for_channel is not supported in multi-threaded replica environment.';
    END IF;
  ELSEIF replication_stop_point IS NULL OR replication_stop_point <= 0
  THEN
    
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Invalid input: replication_stop_point cannot be NULL, less than or equal to 0';
  END IF;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    
    
    SELECT @@global.sql_replica_skip_counter INTO skip_repl_error;
    IF skip_repl_error > 0
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Another session currently running the procedure mysql.rds_skip_repl_error_for_channel. Consider retrying the procedure call.';
    END IF;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      UPDATE mysql.rds_replication_status SET called_by_user = v_called_by_user, action = 'start slave until', mysql_version = v_mysql_version, replication_log_file = TRIM(replication_log_file), replication_stop_point = replication_stop_point, replication_gtid = NULL WHERE action IS NOT NULL AND (CONVERT(channel_name USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci OR channel_name IS NULL);
      COMMIT;
    ELSE
      UPDATE mysql.rds_replication_status SET called_by_user = v_called_by_user, action = 'start channel until', mysql_version = v_mysql_version, replication_log_file = TRIM(replication_log_file), replication_stop_point = replication_stop_point, replication_gtid = NULL WHERE action IS NOT NULL AND CONVERT(QUOTE(channel_name) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
      COMMIT;
    END IF;
    
    SET @cmd = CONCAT('START REPLICA UNTIL SOURCE_LOG_FILE = ', QUOTE(TRIM(replication_log_file)), ', SOURCE_LOG_POS = ', replication_stop_point, ' FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)));
    PREPARE rds_start_replication_for_channel_until FROM @cmd;
    EXECUTE rds_start_replication_for_channel_until;
    DEALLOCATE PREPARE rds_start_replication_for_channel_until;
    DO SLEEP(2);
    SELECT mysql.rds_replication_service_state_for_channel(channel) INTO v_service_state_for_channel;
    IF CONVERT(v_service_state_for_channel USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('ON' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
      THEN
        INSERT INTO mysql.rds_history(called_by_user, action, mysql_version, master_log_file, master_log_pos) VALUES(v_called_by_user, 'start slave until', v_mysql_version, SUBSTRING(replication_log_file, 1, 50), replication_stop_point);
        COMMIT;
        SELECT CONCAT('Replication started until MASTER_LOG_FILE = ', QUOTE(TRIM(replication_log_file)), ' and MASTER_LOG_POS = ', replication_stop_point) AS Message;
      ELSE
        INSERT INTO mysql.rds_history(called_by_user, action, mysql_version, master_log_file, master_log_pos) VALUES(v_called_by_user, 'start channel until', v_mysql_version, SUBSTRING(replication_log_file, 1, 50), replication_stop_point);
        COMMIT;
        SELECT CONCAT('Replication started until SOURCE_LOG_FILE = ', QUOTE(TRIM(replication_log_file)), ' and SOURCE_LOG_POS = ', replication_stop_point, ' for channel ', QUOTE(TRIM(BOTH FROM channel))) AS Message;
      END IF;
    ELSE
      IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
      THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Slave has encountered an error. Run SHOW SLAVE STATUS\G; to see the error.';
      ELSE
        SET @error_message = CONCAT('Replication for specified channel encountered an error. Run SHOW REPLICA STATUS FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)));
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @error_message;
      END IF;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
END |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_start_replication_until_gtid                       | def             | mysql          | rds_start_replication_until_gtid                       | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  CALL mysql.rds_start_replication_until_gtid_for_channel(gtid, '');
END                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_start_replication_until_gtid_for_channel           | def             | mysql          | rds_start_replication_until_gtid_for_channel           | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE v_called_by_user VARCHAR(352);
  DECLARE v_service_state_for_channel ENUM('ON', 'OFF', 'BROKEN', 'NOT_EXIST');
  DECLARE v_replica_parallel_workers INT;
  DECLARE sql_logging BOOLEAN;
  DECLARE skip_repl_error INT;
  SELECT @@sql_log_bin, user(), version(), mysql.rds_replication_service_state_for_channel(channel) INTO sql_logging, v_called_by_user, v_mysql_version, v_service_state_for_channel;
  SELECT @@replica_parallel_workers into v_replica_parallel_workers;
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      INSERT INTO mysql.rds_history(called_by_user, action, mysql_version, master_gtid) VALUES(v_called_by_user, 'Starting: start slave until', v_mysql_version, gtid);
      COMMIT;
    ELSE
      INSERT INTO mysql.rds_history(called_by_user, action, mysql_version, master_gtid) VALUES(v_called_by_user, 'Starting: start channel until', v_mysql_version, gtid);
      COMMIT;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
  IF CONVERT(v_service_state_for_channel USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('NOT_EXIST' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci 
  THEN
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SET @message_text = CONCAT('You can't start replication because the replica isn't configured. First call mysql.rds_set_external_master.');
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @message_text;
    ELSE
      SET @message_text = CONCAT('The given channel does not exist. Run SHOW REPLICA STATUS\G to find all existing channel names.');
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @message_text;
    END IF;
  ELSEIF CONVERT(v_service_state_for_channel USING utf8mb4) COLLATE utf8mb4_0900_ai_ci in (CONVERT('ON' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci  , CONVERT('BROKEN' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci  )
  THEN
    
    
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Replication may already be running. Call rds_stop_replication to stop replication';
    ELSE
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Replication may already be running. Call rds_stop_replication_for_channel to stop replication.';
    END IF;
  ELSEIF v_replica_parallel_workers > 1 THEN
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'rds_start_replication_until_gtid is not supported for multi-threaded slaves';
    ELSE
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'rds_start_replication_until_gtid_for_channel is not supported for multi-threaded replicas.';
    END IF;
  ELSEIF gtid IS NULL THEN
    
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Invalid input: gtid cannot be NULL';
  END IF;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    
    
    SELECT @@global.sql_replica_skip_counter INTO skip_repl_error;
    IF skip_repl_error > 0
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Another session currently running the procedure mysql.rds_skip_repl_error_for_channel. Consider to retry the procedure call.';
    END IF;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      UPDATE mysql.rds_replication_status SET called_by_user = v_called_by_user, action = 'start slave until', mysql_version = v_mysql_version, replication_gtid = gtid, replication_log_file = NULL, replication_stop_point = NULL WHERE action IS NOT NULL AND (CONVERT(channel_name USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci OR channel_name IS NULL);
      COMMIT;
    ELSE
      UPDATE mysql.rds_replication_status SET called_by_user = v_called_by_user, action = 'start channel until', mysql_version = v_mysql_version, replication_gtid = gtid, replication_log_file = NULL, replication_stop_point = NULL WHERE action IS NOT NULL AND CONVERT(QUOTE(channel_name) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
      COMMIT;
    END IF;
    
    SET @cmd = CONCAT('START REPLICA UNTIL SQL_AFTER_GTIDS = ', QUOTE(gtid), ' FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)));
    PREPARE rds_start_replication_for_channel_until FROM @cmd;
    EXECUTE rds_start_replication_for_channel_until;
    DEALLOCATE PREPARE rds_start_replication_for_channel_until;
    DO SLEEP(2);
    SELECT mysql.rds_replication_service_state_for_channel(channel) INTO v_service_state_for_channel;
    IF CONVERT(v_service_state_for_channel USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('ON' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
      THEN
        INSERT INTO mysql.rds_history(called_by_user, action, mysql_version, master_gtid) VALUES(v_called_by_user, 'start slave until', v_mysql_version, gtid);
        COMMIT;
        SELECT CONCAT('Replication started until SQL_AFTER_GTIDS = ', QUOTE(gtid)) AS Message;
      ELSE
        INSERT INTO mysql.rds_history(called_by_user, action, mysql_version, master_gtid) VALUES(v_called_by_user, 'start channel until', v_mysql_version, gtid);
        COMMIT;
        SELECT CONCAT('Replication started until SQL_AFTER_GTIDS = ', QUOTE(gtid), ' for channel ', QUOTE(TRIM(BOTH FROM channel))) AS Message;
      END IF;
    ELSE
      IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
      THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Slave has encountered an error. Run SHOW SLAVE STATUS\G; to see the error.';
      ELSE
        SET @error_message = CONCAT('Replication for specified channel encountered an error. Run SHOW REPLICA STATUS FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)));
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @error_message;
      END IF;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
END |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:31 | 2025-03-11 08:01:31 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_start_upgrade_prechecks                            | def             | mysql          | rds_start_upgrade_prechecks                            | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  DECLARE v_engine_version TEXT;
  DECLARE v_called_by_user TEXT;
  DECLARE most_recent_action TEXT CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
  DECLARE most_recent_status TEXT CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
  DECLARE sql_logging BOOLEAN;

SELECT @@sql_log_bin, user(), version() INTO sql_logging, v_called_by_user, v_engine_version;

BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; SET GLOBAL admin_tls_version=default; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    
    
    
    
    
    
    
    IF CONVERT(substring_index(version(),'.',2) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('8.0' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci AND substring(version(),5,6) <= 35
    THEN
       SET GLOBAL admin_tls_version='TLSv1.3';
    END IF;

    
    INSERT INTO mysql.rds_history(called_by_user, action, mysql_version) VALUES (v_called_by_user, 'start prechecks', v_engine_version);
    COMMIT;

    SELECT action, status INTO most_recent_action, most_recent_status FROM mysql.rds_upgrade_prechecks ORDER BY id DESC LIMIT 1;

    
    IF CONVERT(targetEngineName USING utf8mb4) COLLATE utf8mb4_0900_ai_ci <> CONVERT('mysql' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci OR targetEngineName IS NULL
    THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Only mysql target engine is supported';
    END IF;

    
    IF targetEngineVersion IS NULL OR CONVERT(targetEngineVersion USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Target engine version is required';
    
    ELSEIF NOT CONVERT(targetEngineVersion USING utf8mb4) COLLATE utf8mb4_0900_ai_ci REGEXP '^(5.7.[0-9]{1,2}|8.[0-4].[0-9]{1,2}|9.[0-9].[0-9]{1,2}|10.[0-9].[0-9]{1,2})$'
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Provide valid engine version which must be supported RDS for MySQL version in X.Y.Z format';
    END IF;

    IF most_recent_action = CONVERT('engine upgrade' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci AND most_recent_status IN (CONVERT('in progress' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci)
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Cannot call procedure while engine upgrade in progress.';
    ELSEIF most_recent_action = CONVERT('start_precheck' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci AND most_recent_status IN (CONVERT('in progress' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci,CONVERT('pending' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci)
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Upgrade prechecks in progress. Please stop currently running prechecks using mysql.rds_stop_upgrade_prechecks()';
    ELSE
      INSERT INTO mysql.rds_upgrade_prechecks(action,status,engine_version,target_engine_name,target_engine_version) VALUES (CONVERT('start_precheck' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci, CONVERT('pending' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci, CONVERT(v_engine_version USING utf8mb4) COLLATE utf8mb4_0900_ai_ci, targetEngineName, targetEngineVersion);
      
      INSERT INTO mysql.rds_history(called_by_user, action, mysql_version) VALUES (v_called_by_user, 'start prechecks:ok', v_engine_version);
      COMMIT;
      SELECT 'Starting upgrade prechecks.' as 'Success';
    END IF;
    SET @@sql_log_bin=sql_logging;
    SET GLOBAL admin_tls_version=default;
END;

END |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:34 | 2025-03-11 08:01:34 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_stop_upgrade_prechecks                             | def             | mysql          | rds_stop_upgrade_prechecks                             | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
  DECLARE v_called_by_user TEXT;
  DECLARE v_engine_version TEXT;
  DECLARE most_recent_action TEXT CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
  DECLARE most_recent_status TEXT CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
  DECLARE sql_logging BOOLEAN;

SELECT @@sql_log_bin, user(), version() INTO sql_logging, v_called_by_user, v_engine_version;

BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; SET GLOBAL admin_tls_version=default; RESIGNAL; END;
    SET @@sql_log_bin=OFF;

    
    
    
    
    
    
    
    IF CONVERT(substring_index(version(),'.',2) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('8.0' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci AND substring(version(),5,6) <= 35
    THEN
        SET GLOBAL admin_tls_version='TLSv1.3';
    END IF;

    
    INSERT INTO mysql.rds_history(called_by_user, action, mysql_version) VALUES (v_called_by_user, 'stop prechecks', v_engine_version);
    COMMIT;

    SELECT action, status INTO most_recent_action, most_recent_status FROM mysql.rds_upgrade_prechecks ORDER BY id DESC LIMIT  1;

    IF most_recent_action = CONVERT('engine upgrade' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci AND most_recent_status IN (CONVERT('pending' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci, CONVERT('in progress' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci)
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Cannot call procedure while engine upgrade in progress.';
    ELSEIF most_recent_action = CONVERT('stop_precheck' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci OR most_recent_status IN (CONVERT('stopped' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci, CONVERT('unable to be completed' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci, CONVERT('prechecks failed' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci, CONVERT('prechecks passed' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci)
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Cannot call procedure, upgrade prechecks not running.';
    ELSE
      
      UPDATE mysql.rds_upgrade_prechecks SET STATUS=CONVERT('stopping' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci WHERE CONVERT(status USING utf8mb4) COLLATE utf8mb4_0900_ai_ci IN (CONVERT('pending' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci, CONVERT('in progress' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci);
      
      INSERT INTO mysql.rds_upgrade_prechecks(action, status) VALUES (CONVERT('stop_precheck' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci,CONVERT('stopping' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci);
      
      INSERT INTO mysql.rds_history(called_by_user,action,mysql_version) VALUES (v_called_by_user,'stop prechecks:ok',v_engine_version);
      COMMIT;
      SELECT 'Stopping upgrade prechecks.' as `Success`;
    END IF;

    SET @@sql_log_bin=sql_logging;
    SET GLOBAL admin_tls_version=default;
END;

END |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:34 | 2025-03-11 08:01:34 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_show_upgrade_prechecks_status                      | def             | mysql          | rds_show_upgrade_prechecks_status                      | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
SELECT action, status, engine_version, target_engine_name, target_engine_version, start_timestamp, last_timestamp, prechecks_completed, prechecks_remaining
FROM mysql.rds_upgrade_prechecks WHERE CONVERT(action USING utf8mb4) COLLATE utf8mb4_0900_ai_ci IN (CONVERT('start_precheck' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci, CONVERT('engine upgrade' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci) ORDER BY id DESC LIMIT 1;
END                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:34 | 2025-03-11 08:01:34 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_show_upgrade_prechecks_summary                     | def             | mysql          | rds_show_upgrade_prechecks_summary                     | PROCEDURE    |           |                     NULL |                   NULL |              NULL |          NULL |               NULL | NULL               | NULL               | NULL                                  | SQL          | BEGIN
SELECT summary from mysql.rds_upgrade_prechecks ORDER BY id DESC LIMIT 1;
END                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |          NULL | SQL               | SQL             | NO               | CONTAINS SQL    |     NULL | DEFINER       | 2025-03-11 08:01:34 | 2025-03-11 08:01:34 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
| rds_version                                            | def             | mysql          | rds_version                                            | FUNCTION     | varchar   |                       60 |                    240 |              NULL |          NULL |               NULL | utf8mb4            | utf8mb4_0900_ai_ci | varchar(60)                           | SQL          | BEGIN
RETURN '8.0.40.R1';
END                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |          NULL | SQL               | SQL             | YES              | NO SQL          |     NULL | INVOKER       | 2025-03-11 08:01:35 | 2025-03-11 08:01:35 | NO_ENGINE_SUBSTITUTION |                 | rdsadmin@localhost | utf8mb4              | utf8mb4_0900_ai_ci   | utf8mb4_0900_ai_ci |
+--------------------------------------------------------+-----------------+----------------+--------------------------------------------------------+--------------+-----------+--------------------------+------------------------+-------------------+---------------+--------------------+--------------------+--------------------+---------------------------------------+--------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------+-------------------+-----------------+------------------+-----------------+----------+---------------+---------------------+---------------------+------------------------+-----------------+--------------------+----------------------+----------------------+--------------------+
61 rows in set (0.12 sec)

mysql> \t
mysql> select * from routines where routine_name like '%rds%'\G;
*************************** 1. row ***************************
           SPECIFIC_NAME: rds_set_configuration
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_set_configuration
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: sp: BEGIN
  DECLARE v_exists INT;
  DECLARE sql_logging BOOLEAN;
  
  
  
  
  
  SELECT COUNT(1) INTO v_exists FROM mysql.rds_configuration WHERE mysql.rds_configuration.name = name;
  IF v_exists = 0 THEN
    SET @err = CONCAT('Cannot set unknown configuration parameter ', QUOTE(name), ' using mysql.rds_set_configuration.');
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @err; 
  END IF;
  IF name = 'binlog retention hours' AND rds_is_semi_sync() = 'REPLICA' THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Cannot enable the binlog retention hours on the reader instance in RDS Multi-AZ DB cluster. Please run this query on the writer.';
  ELSEIF name = 'binlog retention hours' AND value NOT BETWEEN 1 AND 168 THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'For binlog retention hours the value must be between 1 and 168 inclusive or be NULL';
  ELSEIF name = 'target delay' AND rds_is_semi_sync() != 'NO' THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Target delay is not supported on the MySQL Multi-AZ cluster';
  ELSEIF name = 'target delay' AND (value IS NULL OR value NOT BETWEEN 0 AND 86400) THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'For target delay the value must be between 0 and 86400 inclusive';
  ELSEIF name = 'source delay' THEN
    CALL mysql.rds_set_source_delay(value);
    LEAVE sp;
  END IF;
  SELECT @@sql_log_bin INTO sql_logging;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    UPDATE mysql.rds_configuration
    SET mysql.rds_configuration.value = value
    WHERE mysql.rds_configuration.name = name;
    COMMIT;
    SET @@sql_log_bin=sql_logging;
  END;
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 2. row ***************************
           SPECIFIC_NAME: rds_set_source_delay
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_set_source_delay
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  CALL mysql.rds_set_source_delay_for_channel(delay, '');
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 3. row ***************************
           SPECIFIC_NAME: rds_show_configuration
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_show_configuration
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  SELECT name, value, description FROM mysql.rds_configuration;
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 4. row ***************************
           SPECIFIC_NAME: rds_kill
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_kill
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  DECLARE l_user TEXT;
  DECLARE l_host TEXT;
  DECLARE rsv_user TEXT;
  DECLARE rsv_host TEXT;
  
  SELECT user, host INTO l_user, l_host
  FROM information_schema.processlist
  WHERE id = thread;
  
  SELECT MAX(user), MAX(host) INTO rsv_user, rsv_host
  FROM mysql.rds_reserved_users
  WHERE user = l_user;
  IF CONNECTION_ID() = thread THEN
    
    
    DO NULL;
  ELSEIF (rsv_user IS NOT NULL AND (l_host = rsv_host OR rsv_host = '%')) THEN
    
    SET @err_msg = CONCAT('CANNOT KILL ', UPPER(l_user), ' SESSION');
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @err_msg;
  END IF;
  KILL thread;
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 5. row ***************************
           SPECIFIC_NAME: rds_kill_query
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_kill_query
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  DECLARE l_user TEXT;
  DECLARE l_host TEXT;
  DECLARE rsv_user TEXT;
  DECLARE rsv_host TEXT;
  
  SELECT user, host INTO l_user, l_host
  FROM information_schema.processlist
  WHERE id = thread;
  
  SELECT MAX(user), MAX(host) INTO rsv_user, rsv_host
  FROM mysql.rds_reserved_users
  WHERE user = l_user;
  IF CONNECTION_ID() = thread THEN
    
    
    DO NULL;
  ELSEIF (rsv_user IS NOT NULL AND (l_host = rsv_host OR rsv_host = '%')) THEN
    
    SET @err_msg = CONCAT('CANNOT KILL ', UPPER(l_user), ' SESSION');
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @err_msg;
  END IF;
  KILL QUERY thread;
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 6. row ***************************
           SPECIFIC_NAME: rds_rotate_general_log
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_rotate_general_log
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
   DECLARE v_called_by_user VARCHAR(352);
   DECLARE v_mysql_version VARCHAR(20);
   DECLARE sql_logging BOOLEAN;
   DECLARE b_general_query_log BOOLEAN;
   SELECT @@sql_log_bin, @@general_log, user(), version() INTO sql_logging, b_general_query_log, v_called_by_user, v_mysql_version;
   
   BEGIN
     DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; SET GLOBAL general_log=b_general_query_log; RESIGNAL; END;
     SET @@sql_log_bin=OFF;
     SET GLOBAL general_log=OFF;
     DROP TABLE IF EXISTS mysql.general_log2;
     CREATE TABLE IF NOT EXISTS mysql.general_log2 LIKE mysql.general_log;
     DROP TABLE IF EXISTS mysql.general_log_backup;
     FLUSH GENERAL LOGS;
     
     
     RENAME TABLE mysql.general_log TO mysql.general_log_backup, mysql.general_log2 TO mysql.general_log;
     INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user, 'rotate_general_log', v_mysql_version);
     COMMIT;
     SET @@sql_log_bin=sql_logging;
     SET GLOBAL general_log=b_general_query_log;
   END;
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 7. row ***************************
           SPECIFIC_NAME: rds_rotate_slow_log
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_rotate_slow_log
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
   DECLARE v_called_by_user VARCHAR(352);
   DECLARE v_mysql_version VARCHAR(20);
   DECLARE sql_logging BOOLEAN;
   DECLARE b_slow_query_log BOOLEAN;
   SELECT @@sql_log_bin, @@GLOBAL.slow_query_log, user(), version() INTO sql_logging, b_slow_query_log, v_called_by_user, v_mysql_version;
   
   BEGIN
     DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; SET GLOBAL slow_query_log=b_slow_query_log; RESIGNAL; END;
     SET @@sql_log_bin=OFF;
     SET GLOBAL slow_query_log=OFF;
     DROP TABLE IF EXISTS mysql.slow_log2;
     CREATE TABLE IF NOT EXISTS mysql.slow_log2 LIKE mysql.slow_log;
     DROP TABLE IF EXISTS mysql.slow_log_backup;
     FLUSH SLOW LOGS;
     
     
     RENAME TABLE mysql.slow_log TO mysql.slow_log_backup, mysql.slow_log2 TO mysql.slow_log;
     INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user, 'rotate_slow_log', v_mysql_version);
     COMMIT;
     SET @@sql_log_bin=sql_logging;
     SET GLOBAL slow_query_log=b_slow_query_log;
   END;
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 8. row ***************************
           SPECIFIC_NAME: rds_clean_replication_status
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_clean_replication_status
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  DECLARE v_has_replication_log_file_column INT;
  DECLARE v_has_replication_stop_point_column INT;
  DECLARE v_has_replication_gtid_column INT;
  DECLARE v_current_security_context_user VARCHAR(352);
  
  
  
  
  SELECT CURRENT_USER() INTO v_current_security_context_user;
  IF v_current_security_context_user <> 'rdsadmin@localhost' THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Must be rdsadmin@localhost to call this procedure';
  END IF;
  SELECT count(*) INTO v_has_replication_log_file_column FROM information_schema.columns WHERE table_schema = 'mysql' AND column_name = 'replication_log_file' AND table_name = 'rds_replication_status';
  SELECT count(*) INTO v_has_replication_stop_point_column FROM information_schema.columns WHERE table_schema = 'mysql' AND column_name = 'replication_stop_point' AND table_name = 'rds_replication_status';
  SELECT count(*) INTO v_has_replication_gtid_column FROM information_schema.columns WHERE table_schema = 'mysql' AND column_name = 'replication_gtid' AND table_name = 'rds_replication_status';
  IF v_has_replication_log_file_column > 0 THEN
    UPDATE mysql.rds_replication_status SET replication_log_file=NULL WHERE action IS NOT NULL;
  END IF;
  IF v_has_replication_stop_point_column > 0 THEN
    UPDATE mysql.rds_replication_status SET replication_stop_point=NULL WHERE action IS NOT NULL;
  END IF;
  IF v_has_replication_gtid_column > 0 THEN
    UPDATE mysql.rds_replication_status SET replication_gtid=NULL WHERE action IS NOT NULL;
  END IF;
  commit;
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: INVOKER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 9. row ***************************
           SPECIFIC_NAME: rds_clean_replication_status_for_channel
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_clean_replication_status_for_channel
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  DECLARE v_has_replication_log_file_column INT;
  DECLARE v_has_replication_stop_point_column INT;
  DECLARE v_has_replication_gtid_column INT;
  DECLARE v_has_replication_channel_name_column INT;
  DECLARE v_current_security_context_user VARCHAR(352);
  DECLARE sql_logging BOOLEAN;
  SELECT @@sql_log_bin INTO sql_logging;
  SELECT CURRENT_USER() INTO v_current_security_context_user;
  IF CONVERT(v_current_security_context_user USING utf8mb4) COLLATE utf8mb4_0900_ai_ci <> CONVERT('rdsadmin@localhost' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Must be rdsadmin@localhost to call this procedure';
  END IF;
  SELECT count(*) INTO v_has_replication_log_file_column FROM information_schema.columns WHERE table_schema = 'mysql' AND column_name = 'replication_log_file' AND table_name = 'rds_replication_status';
  SELECT count(*) INTO v_has_replication_stop_point_column FROM information_schema.columns WHERE table_schema = 'mysql' AND column_name = 'replication_stop_point' AND table_name = 'rds_replication_status';
  SELECT count(*) INTO v_has_replication_gtid_column FROM information_schema.columns WHERE table_schema = 'mysql' AND column_name = 'replication_gtid' AND table_name = 'rds_replication_status';
  SELECT count(*) INTO v_has_replication_channel_name_column FROM information_schema.columns WHERE table_schema = 'mysql' AND column_name = 'channel_name' AND table_name = 'rds_replication_status';
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    IF v_has_replication_channel_name_column > 0 THEN
      IF v_has_replication_log_file_column > 0 THEN
        UPDATE mysql.rds_replication_status SET replication_log_file=NULL WHERE action IS NOT NULL AND CONVERT(QUOTE(channel_name) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
      END IF;
      IF v_has_replication_stop_point_column > 0 THEN
        UPDATE mysql.rds_replication_status SET replication_stop_point=NULL WHERE action IS NOT NULL AND CONVERT(QUOTE(channel_name) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
      END IF;
      IF v_has_replication_gtid_column > 0 THEN
        UPDATE mysql.rds_replication_status SET replication_gtid=NULL WHERE action IS NOT NULL AND CONVERT(QUOTE(channel_name) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
      END IF;
    ELSE
      IF v_has_replication_log_file_column > 0 THEN
        UPDATE mysql.rds_replication_status SET replication_log_file=NULL WHERE action IS NOT NULL;
      END IF;
      IF v_has_replication_stop_point_column > 0 THEN
        UPDATE mysql.rds_replication_status SET replication_stop_point=NULL WHERE action IS NOT NULL;
      END IF;
      IF v_has_replication_gtid_column > 0 THEN
        UPDATE mysql.rds_replication_status SET replication_gtid=NULL WHERE action IS NOT NULL;
      END IF;
    END IF;
    COMMIT;
    SET @@sql_log_bin=sql_logging;
  END;
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: INVOKER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 10. row ***************************
           SPECIFIC_NAME: rds_external_master
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_external_master
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  DECLARE v_rdsrepl INT;
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE v_service_state ENUM('ON', 'OFF', 'BROKEN');
  DECLARE v_called_by_user VARCHAR(352);
  DECLARE v_rep_status int;
  DECLARE v_rep_status_stop int;
  DECLARE sql_logging BOOLEAN;
  SELECT @@sql_log_bin, user(), version(), mysql.rds_replication_service_state() INTO sql_logging, v_called_by_user, v_mysql_version, v_service_state;
  Select count(1) into v_rep_status_stop from mysql.rds_replication_status where action = 'stop slave';
  Select count(1) into v_rep_status from mysql.rds_replication_status;
  Select count(1) into v_rdsrepl from mysql.rds_history where action = 'disable set master' and master_user = 'rdsrepladmin';
  
  IF v_called_by_user != 'rdsadmin@localhost'
  THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'You do not have privileges to call this procedure';
  END IF;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    IF v_rep_status = 0
    Then
      
      insert into mysql.rds_replication_status(called_by_user, action, mysql_version)values (v_called_by_user,'disable set master',v_mysql_version);
      insert into mysql.rds_history(called_by_user, action, master_user, mysql_version)values (v_called_by_user,'disable set master','rdsrepladmin',v_mysql_version);
      commit;
    ELSEIF phase not in ('enable','disable')
    then
      
      
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Please use the values enable or disable for the phase argument';
    
    
    ElseIF v_rdsrepl > 0 and phase = 'disable'
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'MYSQL.RDS_SET_EXTERNAL_MASTER is disabled';
    
    ElseIF v_rdsrepl = 0 and phase = 'disable'
    THEN
      if v_service_state in ('ON'  , 'BROKEN'  )
      then
        call mysql.rds_stop_replication();
        DO SLEEP(1);
        update mysql.rds_replication_status set called_by_user=v_called_by_user, action='disable set master', mysql_version=v_mysql_version where action is not null;
        commit;
        DO SLEEP(1);
        INSERT into mysql.rds_history(called_by_user, action, mysql_version, master_user) values (v_called_by_user,'disable set master', v_mysql_version, 'rdsrepladmin');
        commit;
        select 'Replication has been stopped and MYSQL.RDS_SET_EXTERNAL_MASTER has been disabled' as message;
      else 
        update mysql.rds_replication_status set called_by_user=v_called_by_user, action='disable set master', mysql_version=v_mysql_version where action is not null;
        commit;
        DO SLEEP(1);
        INSERT into mysql.rds_history(called_by_user, action, mysql_version, master_user) values (v_called_by_user,'disable set master', v_mysql_version, 'rdsrepladmin');
        commit;
        Select 'MYSQL.RDS_SET_EXTERNAL_MASTER has been disabled' as message;
      end if;
    
    ELSEIF v_rdsrepl = 0 and phase = 'enable'
    THEN
      if v_service_state in ('ON'  , 'BROKEN'  )
      then
        update mysql.rds_replication_status set called_by_user=v_called_by_user,action='enable set master', mysql_version=v_mysql_version where action is not null;
        commit;
        select 'MYSQL.RDS_SET_EXTERNAL_MASTER is enabled.' as message;
        
      end if;
    ELSEIF v_rdsrepl > 0 and phase = 'enable'
    THEN
      update mysql.rds_replication_status set called_by_user=v_called_by_user,action='enable set master', mysql_version=v_mysql_version where action is not null;
      commit;
      DO SLEEP(1);
      UPDATE mysql.rds_history set action = 'enable set master' where action = 'disable set master' and master_user = 'rdsrepladmin';
      commit;
      select 'MYSQL.RDS_SET_EXTERNAL_MASTER has been enabled' as message;
    END IF;
    IF v_rep_status_stop = 1
    Then
      update mysql.rds_replication_status set called_by_user=v_called_by_user,action='stop slave', mysql_version=v_mysql_version where action is not null;
      commit;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 11. row ***************************
           SPECIFIC_NAME: rds_reset_external_master
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_reset_external_master
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  CALL mysql.rds_reset_external_source_for_channel('');
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 12. row ***************************
           SPECIFIC_NAME: rds_reset_external_source_for_channel
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_reset_external_source_for_channel
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
 DECLARE v_rdsrepl INT;
 DECLARE v_mysql_version VARCHAR(20);
 DECLARE v_called_by_user VARCHAR(352);
 DECLARE v_channel_service_state ENUM('ON', 'OFF', 'BROKEN', 'NOT_EXIST');
 DECLARE sql_logging BOOLEAN;
 SELECT @@sql_log_bin, user(), version(), mysql.rds_replication_service_state_for_channel(channel) into sql_logging, v_called_by_user, v_mysql_version, v_channel_service_state;
 SELECT count(1) INTO v_rdsrepl from mysql.rds_history WHERE CONVERT(action USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('disable set master' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci and CONVERT(master_user USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('rdsrepladmin' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
 BEGIN
   DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
   SET @@sql_log_bin=OFF;
   IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
   THEN
     INSERT INTO mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user,'Starting: reset slave', v_mysql_version);
     COMMIT;
   ELSE
     INSERT INTO mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user,'Starting: reset replica for channel', v_mysql_version);
     COMMIT;
   END IF;
   SET @@sql_log_bin=sql_logging;
 END;
 IF v_rdsrepl > 0 and CONVERT(v_called_by_user USING utf8mb4) COLLATE utf8mb4_0900_ai_ci != CONVERT('rdsadmin@localhost' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
 THEN
     SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Permission Denied: This instance is a RDS Read Replica.';
 ELSEIF CONVERT(v_called_by_user USING utf8mb4) COLLATE utf8mb4_0900_ai_ci != CONVERT('rdsadmin@localhost' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci AND CONVERT(mysql.rds_is_semi_sync() USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('REPLICA' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
 THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Permission Denied: Replication for Multi-AZ clusters is managed exclusively by RDS.';
 END IF;
 BEGIN
   DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
   SET @@sql_log_bin=OFF;
   IF CONVERT(v_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('NOT_EXIST' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci 
   THEN
     IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
     THEN
       SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'You can't reset replication because replication isn't configured. First run mysql.rds_set_external_master.';
     ELSE
       SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'The given channel does not exist. Run SHOW REPLICA STATUS\G to find all existing channel names.';
     END IF;
   ELSEIF CONVERT(v_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('OFF' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
   THEN
     CALL mysql.rds_clean_replication_status_for_channel(channel);
   ELSE 
     SET @cmd = CONCAT('STOP REPLICA FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)));
     PREPARE rds_stop_replica_for_channel FROM @cmd;
     EXECUTE rds_stop_replica_for_channel;
     DEALLOCATE PREPARE rds_stop_replica_for_channel;
     DO SLEEP(2);
     CALL mysql.rds_clean_replication_status_for_channel(channel);
   END IF;
   SET @cmd = CONCAT('RESET REPLICA ALL FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)));
   PREPARE rds_reset_replica_for_channel FROM @cmd;
   EXECUTE rds_reset_replica_for_channel;
   DEALLOCATE PREPARE rds_reset_replica_for_channel;
   IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
   THEN
      INSERT INTO mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user,'reset slave', v_mysql_version);
      COMMIT;
   ELSE
      INSERT INTO mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user,'reset replica for channel', v_mysql_version);
      COMMIT;
   END IF;
   
   IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
   THEN
     UPDATE mysql.rds_replication_status SET called_by_user=v_called_by_user, action='reset slave', mysql_version=v_mysql_version, master_host=NULL, master_port=NULL WHERE action is not null AND (CONVERT(channel_name USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci OR channel_name IS NULL);
     COMMIT;
     SELECT 'Slave has been reset' as message;
   ELSE
     DELETE FROM mysql.rds_replication_status WHERE CONVERT(QUOTE(channel_name) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
     COMMIT;
     SELECT CONCAT('Replication has been reset for channel ', QUOTE(TRIM(BOTH FROM channel))) as message;
   END IF;
   SET @@sql_log_bin=sql_logging;
 END;
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 13. row ***************************
           SPECIFIC_NAME: rds_set_external_master_with_auto_position
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_set_external_master_with_auto_position
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  CALL mysql.rds_set_external_source_with_auto_position_for_channel(host, port, user, passwd, enable_ssl_encryption, delay, '');
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 14. row ***************************
           SPECIFIC_NAME: rds_set_external_source_with_auto_position_for_channel
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_set_external_source_with_auto_position_for_channel
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  DECLARE v_rdsrepl INT;
  DECLARE v_same_name_channel_service_state ENUM('ON', 'OFF', 'BROKEN', 'NOT_EXIST');
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE v_called_by_user VARCHAR(352);
  DECLARE sql_logging BOOLEAN;
  DECLARE v_channel_count INT;
  DECLARE v_same_source_count INT;
  SELECT @@sql_log_bin, user(), version(), mysql.rds_replication_service_state_for_channel(channel) INTO sql_logging, v_called_by_user, v_mysql_version, v_same_name_channel_service_state;
  SELECT count(1) INTO v_rdsrepl from mysql.rds_history WHERE CONVERT(action USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('disable set master' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci and CONVERT(master_user USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('rdsrepladmin' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
  SELECT count(1) INTO v_channel_count FROM performance_schema.replication_connection_status WHERE CONVERT(QUOTE(channel_name) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci != CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
  SELECT count(1) INTO v_same_source_count FROM performance_schema.replication_connection_configuration rcc WHERE rcc.HOST = host AND rcc.PORT = port AND CONVERT(QUOTE(rcc.CHANNEL_NAME) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci != CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      INSERT INTO mysql.rds_history(called_by_user, action, mysql_version, master_host, master_port, master_user, master_ssl, master_delay, auto_position)
      VALUES (v_called_by_user,'Starting: set master AP', v_mysql_version, trim(both from host), port, trim(both from user), enable_ssl_encryption, delay, 1);
      COMMIT;
    ELSE
      INSERT INTO mysql.rds_history(called_by_user, action, mysql_version, master_host, master_port, master_user, master_ssl, master_delay, auto_position)
      VALUES (v_called_by_user,'Starting: set channel AP', v_mysql_version, trim(both from host), port, trim(both from user), enable_ssl_encryption, delay, 1);
      COMMIT;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
  IF delay NOT BETWEEN 0 AND 86400
  THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'For source delay the value must be between 0 and 86400 inclusive.';
  END IF;
  IF v_rdsrepl > 0 and CONVERT(v_called_by_user USING utf8mb4) COLLATE utf8mb4_0900_ai_ci != CONVERT('rdsadmin@localhost' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
  THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Permission Denied: This instance is a RDS Read Replica.';
  ELSEIF CONVERT(v_called_by_user USING utf8mb4) COLLATE utf8mb4_0900_ai_ci != CONVERT('rdsadmin@localhost' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci AND CONVERT(mysql.rds_is_semi_sync() USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('REPLICA' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
  THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Permission Denied: Replication for Multi-AZ clusters is managed exclusively by RDS.';
  END IF;
  IF CONVERT(v_same_name_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('ON' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci OR CONVERT(v_same_name_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('BROKEN' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
  THEN
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'You can't modify replication because replication is running. First call mysql.rds_stop_replication.';
    ELSE
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'You can't modify the given channel because replication is running. First call mysql.rds_stop_replication_for_channel.';
    END IF;
  END IF;
  
  IF v_channel_count >= 15
  THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Maximum 15 channels are allowed in multi source replication on RDS.';
  END IF;
  
  IF v_same_source_count > 0
  THEN
    
    SET @error_message = CONCAT('Use multiple channels to replicate from the host: ', host, ' and port: ', port, ' is not supported.');
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @error_message;
  END IF;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    
    SET @cmd = CONCAT('CHANGE REPLICATION SOURCE TO',
                      ' SOURCE_HOST = ', QUOTE(TRIM(BOTH FROM host)),
                      ', SOURCE_PORT = ', port, 
                      ', SOURCE_USER = ', QUOTE(TRIM(BOTH FROM user)),
                      ', SOURCE_PASSWORD = ', QUOTE(TRIM(BOTH FROM passwd)),
                      ', SOURCE_SSL = ', enable_ssl_encryption, 
                      ', SOURCE_AUTO_POSITION = 1',
                      ', SOURCE_DELAY = ', delay, 
                      ' FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel))
                     );
    PREPARE rds_set_source_for_channel FROM @cmd;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      UPDATE mysql.rds_replication_status SET called_by_user=v_called_by_user, action='set master', mysql_version=v_mysql_version , master_host=trim(both from host), master_port=port WHERE action is not null AND (CONVERT(channel_name USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci OR channel_name IS NULL);
      COMMIT;
    ELSE
      DELETE FROM mysql.rds_replication_status WHERE CONVERT(QUOTE(channel_name) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
      COMMIT;
      INSERT INTO mysql.rds_replication_status(called_by_user, action, mysql_version, master_host, master_port, channel_name)
        VALUES (v_called_by_user, 'set channel source', v_mysql_version, trim(both from host), port, channel);
      COMMIT;
    END IF;
    CALL mysql.rds_clean_replication_status_for_channel(channel);
    EXECUTE rds_set_source_for_channel;
    DEALLOCATE PREPARE rds_set_source_for_channel;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      INSERT INTO mysql.rds_history(called_by_user, action, mysql_version, master_host, master_port, master_user, master_ssl, master_delay, auto_position)
        VALUES (v_called_by_user,'set master with AP', v_mysql_version, trim(both from host), port, trim(both from user), enable_ssl_encryption, delay, 1);
      COMMIT;
      
      
      UPDATE mysql.rds_configuration
        SET mysql.rds_configuration.value = delay
        WHERE CAST(mysql.rds_configuration.name AS BINARY) = 'source delay';
      COMMIT;
    ELSE
      INSERT INTO mysql.rds_history(called_by_user, action, mysql_version, master_host, master_port, master_user, master_ssl, master_delay, auto_position)
        VALUES (v_called_by_user,'set channel with AP', v_mysql_version, trim(both from host), port, trim(both from user), enable_ssl_encryption, delay, 1);
      COMMIT;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 15. row ***************************
           SPECIFIC_NAME: rds_set_source_delay_for_channel
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_set_source_delay_for_channel
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE v_called_by_user VARCHAR(352);
  DECLARE sql_logging BOOLEAN;
  DECLARE v_service_state_for_channel ENUM('ON', 'OFF', 'BROKEN', 'NOT_EXIST');
  SELECT @@sql_log_bin, user(), version(), mysql.rds_replication_service_state_for_channel(channel) INTO sql_logging, v_called_by_user, v_mysql_version, v_service_state_for_channel;
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      INSERT INTO mysql.rds_history(called_by_user, action, mysql_version, master_delay) VALUES(v_called_by_user, 'Starting: set source delay', v_mysql_version, delay);
      COMMIT;
    ELSE
      INSERT INTO mysql.rds_history(called_by_user, action, mysql_version, master_delay) VALUES(v_called_by_user, 'Starting: set source delay channel', v_mysql_version, delay);
      COMMIT;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
  IF CONVERT(rds_is_semi_sync() USING utf8mb4) COLLATE utf8mb4_0900_ai_ci != CONVERT('NO' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Source delay is not supported on the MySQL Multi-AZ cluster';
  ELSEIF delay IS NULL OR delay NOT BETWEEN 0 AND 86400 THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'For source delay the value must be between 0 and 86400 inclusive.';
  END IF;
  IF CONVERT(v_service_state_for_channel USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('NOT_EXIST' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci 
  THEN
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'You can't set replication delay because the replica isn't configured. First call mysql.rds_set_external_master.';
    ELSE
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'The given channel does not exist. Run SHOW REPLICA STATUS\G to find all existing channel names.';
    END IF;
  ELSEIF CONVERT(v_service_state_for_channel USING utf8mb4) COLLATE utf8mb4_0900_ai_ci in (CONVERT('ON' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci  , CONVERT('BROKEN' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci  )
  THEN
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'You can't set replication delay because replication is running. First call mysql.rds_stop_replication.';
    ELSE
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'You can't set replication delay for the given channel when replication is running. First call rds_stop_replication_for_channel.';
    END IF;
  END IF;
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    SET @cmd = CONCAT('CHANGE REPLICATION SOURCE TO SOURCE_DELAY = ', delay, ' FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)));
    PREPARE rds_set_delay_for_channel FROM @cmd;
    EXECUTE rds_set_delay_for_channel;
    DEALLOCATE PREPARE rds_set_delay_for_channel;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      UPDATE mysql.rds_configuration SET value = delay WHERE CONVERT(name USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('source delay' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
      COMMIT;
      INSERT INTO mysql.rds_history(called_by_user, action, mysql_version, master_delay) VALUES(v_called_by_user, 'set source delay', v_mysql_version, delay);
      COMMIT;
      SELECT 'source delay is set successfully.' AS Message;
    ELSE
      INSERT INTO mysql.rds_history(called_by_user, action, mysql_version, master_delay) VALUES(v_called_by_user, 'source delay channel', v_mysql_version, delay);
      COMMIT;
      SELECT CONCAT('source delay is set successfully for channel ', QUOTE(TRIM(BOTH FROM channel))) AS Message;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 16. row ***************************
           SPECIFIC_NAME: rds_start_replication
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_start_replication
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  CALL mysql.rds_start_replication_for_channel('');
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 17. row ***************************
           SPECIFIC_NAME: rds_start_replication_for_channel
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_start_replication_for_channel
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE v_semi_sync ENUM('SOURCE', 'REPLICA', 'NO');
  DECLARE v_called_by_user VARCHAR(50);
  DECLARE v_channel_service_state ENUM('ON', 'OFF', 'BROKEN', 'NOT_EXIST');
  DECLARE sql_logging BOOLEAN;
  DECLARE skip_repl_error INT;
  SELECT @@sql_log_bin, user(), version(), mysql.rds_replication_service_state_for_channel(channel), mysql.rds_is_semi_sync()
  INTO sql_logging, v_called_by_user, v_mysql_version, v_channel_service_state, v_semi_sync;
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      INSERT INTO mysql.rds_history (called_by_user,action,mysql_version) VALUES (v_called_by_user, 'Starting: start slave', v_mysql_version);
      COMMIT;
    ELSE
      INSERT INTO mysql.rds_history (called_by_user,action,mysql_version) VALUES (v_called_by_user, 'Starting: start channel', v_mysql_version);
      COMMIT;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
  IF CONVERT(v_called_by_user USING utf8mb4) COLLATE utf8mb4_0900_ai_ci != CONVERT('rdsadmin@localhost' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci AND CONVERT(v_semi_sync USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('REPLICA' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
  THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Permission Denied: Replication for Multi-AZ clusters is managed exclusively by RDS.';
  ELSEIF CONVERT(v_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('ON' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci 
  THEN
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Replication may already be running. Call rds_stop_replication to stop replication';
    ELSE
      SET @message_text = CONCAT('Replication may already be running for channel. Run SHOW REPLICA STATUS FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)), '\G .' );
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @message_text;
    END IF;
  ELSEIF CONVERT(v_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('NOT_EXIST' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci 
  THEN
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SET @message_text = CONCAT('You can't start replication because the replica isn't configured. First call mysql.rds_set_external_master.');
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @message_text;
    ELSE
      SET @message_text = CONCAT('The given channel does not exist. Run SHOW REPLICA STATUS\G to find all existing channel names.');
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @message_text;
    END IF;
  ELSEIF CONVERT(v_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('BROKEN' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci 
  THEN
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      
      
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Replication might be running. First call mysql.rds_stop_replication.';
    ELSE
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'The replication on given channel might be running. First call mysql.rds_stop_replication_for_channel.';
    END IF;
  ELSEIF CONVERT(v_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('OFF' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci 
  THEN
    
    BEGIN
      DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
      SET @@sql_log_bin=OFF;
      IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
      THEN
        SET @action = 'start slave';
      ELSE
        SET @action = 'start channel';
      END IF;
      SET @cmd = CONCAT('START REPLICA FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)));
      PREPARE rds_start_replica_for_channel FROM @cmd;
      UPDATE mysql.rds_replication_status rrs SET called_by_user=v_called_by_user, action=@action, mysql_version=v_mysql_version
                                              WHERE rrs.action IS NOT NULL AND CONVERT(QUOTE(rrs.channel_name) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
      COMMIT;
      CALL mysql.rds_clean_replication_status_for_channel(channel);
      DO SLEEP(1);
      SELECT @@global.sql_replica_skip_counter INTO skip_repl_error;
      IF skip_repl_error = 0
      THEN
        EXECUTE rds_start_replica_for_channel;
      ELSE
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Another session currently running the procedure mysql.rds_skip_repl_error_for_channel. Consider retrying the procedure call.';
      END IF;
      DO SLEEP(2);
      SELECT mysql.rds_replication_service_state_for_channel(channel) INTO v_channel_service_state;
      IF CONVERT(v_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('ON' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
      THEN
        INSERT INTO mysql.rds_history (called_by_user,action,mysql_version) VALUES (v_called_by_user, @action, v_mysql_version);
        COMMIT;
        IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
        THEN
          SELECT 'Replication started. Slave is now running normally.' AS Message;
        ELSE
          SELECT CONCAT('Replication started for channel ', QUOTE(TRIM(BOTH FROM channel)), ' and replication is now running normally.') AS Message;
        END IF;
      ELSE
        IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
        THEN
          SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Slave has encountered an error. Run SHOW SLAVE STATUS\G; to see the error.';
        ELSE
          SET @message_text = CONCAT('Start replication failed. To see the error, run SHOW REPLICA STATUS FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)), '\G .');
          SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @message_text;
        END IF;
      END IF;
      DEALLOCATE PREPARE rds_start_replica_for_channel;
      SET @@sql_log_bin=sql_logging;
    END;
  END IF;
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 18. row ***************************
           SPECIFIC_NAME: rds_stop_replication
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_stop_replication
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  CALL mysql.rds_stop_replication_for_channel('');
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 19. row ***************************
           SPECIFIC_NAME: rds_stop_replication_for_channel
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_stop_replication_for_channel
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE v_called_by_user VARCHAR(50);
  DECLARE v_channel_service_state ENUM('ON', 'OFF', 'BROKEN', 'NOT_EXIST');
  DECLARE sql_logging BOOLEAN;
  SELECT @@sql_log_bin, user(), version(), mysql.rds_replication_service_state_for_channel(channel) INTO sql_logging, v_called_by_user, v_mysql_version, v_channel_service_state;
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      INSERT INTO mysql.rds_history (called_by_user,action,mysql_version) VALUES (v_called_by_user, 'Starting: stop slave', v_mysql_version);
      COMMIT;
    ELSE
      INSERT INTO mysql.rds_history (called_by_user,action,mysql_version) VALUES (v_called_by_user, 'Starting: stop channel', v_mysql_version);
      COMMIT;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
  IF CONVERT(v_called_by_user USING utf8mb4) COLLATE utf8mb4_0900_ai_ci != CONVERT('rdsadmin@localhost' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci AND CONVERT(mysql.rds_is_semi_sync() USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('REPLICA' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
  THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Permission Denied: Replication for Multi-AZ clusters is managed exclusively by RDS.';
  END IF;
  IF CONVERT(v_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('OFF' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
  THEN
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Slave is already stopped or may not be configured. Run SHOW SLAVE STATUS\G;';
    ELSE
      SET @message_text = CONCAT('Replication is already stopped for the given channel. Run SHOW REPLICA STATUS\G .');
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @message_text;
    END IF;
  ELSEIF CONVERT(v_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('NOT_EXIST' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci 
  THEN
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'You can't stop replication because the replica isn't configured. First call mysql.rds_set_external_master.';
    ELSE
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'The given channel does not exist. Run SHOW REPLICA STATUS\G to find all existing channel names.';
    END IF;
  ELSE
    BEGIN
      DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
      SET @@sql_log_bin=OFF;
      IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
      THEN
        SET @action = 'stop slave';
      ELSE
        SET @action = 'stop channel';
      END IF;
      SET @cmd = CONCAT('STOP REPLICA FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)));
      PREPARE rds_stop_replica_for_channel FROM @cmd;
      UPDATE mysql.rds_replication_status rrs SET called_by_user=v_called_by_user, action=@action, mysql_version=v_mysql_version
                                              WHERE rrs.action IS NOT NULL AND CONVERT(QUOTE(rrs.channel_name) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
      COMMIT;
      DO SLEEP(1);
      EXECUTE rds_stop_replica_for_channel;
      DO SLEEP(2);
      SELECT mysql.rds_replication_service_state_for_channel(channel) INTO v_channel_service_state;
      IF CONVERT(v_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('OFF' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
      THEN
        INSERT INTO mysql.rds_history (called_by_user,action,mysql_version) VALUES (v_called_by_user, @action, v_mysql_version);
        COMMIT;
        IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
        THEN
          SELECT 'Slave is now down or disabled' AS Message;
        ELSE
          SELECT CONCAT('Replication for channel ', QUOTE(TRIM(BOTH FROM channel)), ' is down or disabled.') AS Message;
        END IF;
      ELSE
        IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
        THEN
          SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Slave has encountered an error. Run SHOW SLAVE STATUS\G; to see the error.';
        ELSE
          SET @message_text = CONCAT('Stop replication failed. To see the error, run SHOW REPLICA STATUS FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)), '\G .');
          SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @message_text;
        END IF;
      END IF;
      DEALLOCATE PREPARE rds_stop_replica_for_channel;
      SET @@sql_log_bin=sql_logging;
    END;
  END IF;
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 20. row ***************************
           SPECIFIC_NAME: rds_is_semi_sync
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_is_semi_sync
            ROUTINE_TYPE: FUNCTION
               DATA_TYPE: enum
CHARACTER_MAXIMUM_LENGTH: 7
  CHARACTER_OCTET_LENGTH: 28
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: utf8mb4
          COLLATION_NAME: utf8mb4_0900_ai_ci
          DTD_IDENTIFIER: enum('SOURCE','REPLICA','NO')
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  DECLARE is_semi_sync_source INTEGER;
  DECLARE is_semi_sync_replica INTEGER;
  
  
  
  
  
  
  
  
  
  
  SELECT SUM(variable_value = 'ON' AND variable_name in ('rpl_semi_sync_source_enabled', 'rpl_semi_sync_master_enabled')),
         SUM(variable_value = 'ON' AND variable_name in ('rpl_semi_sync_replica_enabled', 'rpl_semi_sync_slave_enabled'))
  INTO is_semi_sync_source, is_semi_sync_replica
  FROM performance_schema.global_variables;
  IF is_semi_sync_source > 0 THEN
    RETURN 'SOURCE';
  ELSEIF is_semi_sync_replica > 0 THEN
    RETURN 'REPLICA';
  ELSE
    RETURN 'NO';
  END IF;
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: READS SQL DATA
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 21. row ***************************
           SPECIFIC_NAME: rds_replication_service_state
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_replication_service_state
            ROUTINE_TYPE: FUNCTION
               DATA_TYPE: enum
CHARACTER_MAXIMUM_LENGTH: 6
  CHARACTER_OCTET_LENGTH: 24
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: utf8mb4
          COLLATION_NAME: utf8mb4_0900_ai_ci
          DTD_IDENTIFIER: enum('ON','OFF','BROKEN')
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  DECLARE v_service_state ENUM('ON', 'OFF', 'BROKEN');
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
    
    SELECT COALESCE(MAX(
      CASE WHEN rcs.service_state = 'ON' and rca.service_state = 'ON' THEN 'ON'
           WHEN rcs.service_state = 'OFF' and rca.service_state = 'OFF' THEN 'OFF'
           ELSE 'BROKEN' END), 'OFF')
    INTO v_service_state
    FROM performance_schema.replication_connection_status rcs
    JOIN performance_schema.replication_applier_status rca USING (channel_name)
    WHERE channel_name='';
  RETURN v_service_state;
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: READS SQL DATA
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 22. row ***************************
           SPECIFIC_NAME: rds_replication_service_state_for_channel
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_replication_service_state_for_channel
            ROUTINE_TYPE: FUNCTION
               DATA_TYPE: enum
CHARACTER_MAXIMUM_LENGTH: 9
  CHARACTER_OCTET_LENGTH: 36
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: utf8mb4
          COLLATION_NAME: utf8mb4_0900_ai_ci
          DTD_IDENTIFIER: enum('ON','OFF','BROKEN','NOT_EXIST')
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  DECLARE v_service_state ENUM('ON', 'OFF', 'BROKEN', 'NOT_EXIST');
  SELECT COALESCE(MAX(
    CASE WHEN rcs.service_state = 'ON' AND rca.service_state = 'ON' THEN 'ON'
       WHEN rcs.service_state = 'OFF' AND rca.service_state = 'OFF' THEN 'OFF'
       ELSE 'BROKEN' END), 'NOT_EXIST')
  INTO v_service_state
  FROM performance_schema.replication_connection_status rcs
           JOIN performance_schema.replication_applier_status rca USING (channel_name)
  WHERE CONVERT(QUOTE(channel_name) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
  RETURN v_service_state;
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: READS SQL DATA
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 23. row ***************************
           SPECIFIC_NAME: rds_set_fk_checks_off
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_set_fk_checks_off
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  DECLARE v_called_by_user VARCHAR(352);
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE sql_logging BOOLEAN;
  SELECT @@sql_log_bin, user(), version() INTO sql_logging, v_called_by_user, v_mysql_version;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user,'set_fk_checks_off', v_mysql_version);
    commit;
    SET GLOBAL `foreign_key_checks`=0;
    SET SESSION `foreign_key_checks`=0;
    SET @@sql_log_bin=sql_logging;
  END;
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 24. row ***************************
           SPECIFIC_NAME: rds_set_fk_checks_on
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_set_fk_checks_on
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  DECLARE v_called_by_user VARCHAR(352);
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE sql_logging BOOLEAN;
  SELECT @@sql_log_bin, user(), version() INTO sql_logging, v_called_by_user, v_mysql_version;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user,'set_fk_checks_on', v_mysql_version);
    commit;
    SET GLOBAL `foreign_key_checks`=1;
    SET SESSION `foreign_key_checks`=1;
    SET @@sql_log_bin=sql_logging;
  END;
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 25. row ***************************
           SPECIFIC_NAME: rds_collect_global_status_history
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_collect_global_status_history
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: begin
  declare my_row_count int(5) default 0;
  DECLARE sql_logging BOOLEAN;
  select @@sql_log_bin into sql_logging;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    
    set transaction isolation level read committed;
    insert into rds_global_status_history ( collection_start, variable_name, variable_value, variable_delta )
    select b.collection_end, a.variable_name, a.variable_value, a.variable_value-coalesce(b.variable_value,0) as variable_delta
    from performance_schema.global_status a
    left outer join rds_global_status_history b on a.variable_name = b.variable_name
    where b.collection_end = (select max(collection_end) from rds_global_status_history);
    select row_count() into my_row_count;
    if my_row_count = 0
    then
      insert into rds_global_status_history ( collection_start, variable_name, variable_value, variable_delta )
      select null, variable_name, variable_value, variable_value from performance_schema.global_status ;
    end if;
    commit;
    SET @@sql_log_bin=sql_logging;
  END;
end
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 26. row ***************************
           SPECIFIC_NAME: rds_disable_gsh_collector
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_disable_gsh_collector
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: begin
  DECLARE sql_logging BOOLEAN;
  select @@sql_log_bin into sql_logging;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    alter event ev_rds_gsh_collector DISABLE;
    select 'Collector Disabled' as `Success`;
    SET @@sql_log_bin=sql_logging;
  END;
end
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 27. row ***************************
           SPECIFIC_NAME: rds_disable_gsh_rotation
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_disable_gsh_rotation
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: begin
  DECLARE sql_logging BOOLEAN;
  select @@sql_log_bin into sql_logging;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    alter event ev_rds_gsh_table_rotation DISABLE;
    select 'Table Rotation Disabled' as `Success`;
    SET @@sql_log_bin=sql_logging;
  END;
end
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 28. row ***************************
           SPECIFIC_NAME: rds_enable_gsh_collector
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_enable_gsh_collector
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: begin
  call rds_set_gsh_collector(5);
end
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 29. row ***************************
           SPECIFIC_NAME: rds_enable_gsh_rotation
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_enable_gsh_rotation
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: begin
  call rds_set_gsh_rotation(7);
end
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 30. row ***************************
           SPECIFIC_NAME: rds_rotate_global_status_history
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_rotate_global_status_history
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  DECLARE sql_logging BOOLEAN;
  select @@sql_log_bin into sql_logging;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    drop table mysql.rds_global_status_history_old;
    rename table mysql.rds_global_status_history to mysql.rds_global_status_history_old;
    create table mysql.rds_global_status_history like mysql.rds_global_status_history_old;
    SET @@sql_log_bin=sql_logging;
  END;
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 31. row ***************************
           SPECIFIC_NAME: rds_set_gsh_collector
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_set_gsh_collector
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: begin
  declare v_es varchar(3);
  DECLARE sql_logging BOOLEAN;
  select @@sql_log_bin into sql_logging;
  select variable_value into v_es from performance_schema.global_variables where variable_name = 'EVENT_SCHEDULER';
  
  
  
  if v_es != 'ON' then
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Scheduler is NOT Active. Please set the parameter event_scheduler=ON in your Parameter Group';
  end if;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    alter event ev_rds_gsh_collector ON SCHEDULE EVERY p_period MINUTE STARTS CURRENT_TIMESTAMP ENABLE;
    select concat('Collector Enabled every ', p_period ,' Minutes, Scheduler is Active') as `Success`;
    SET @@sql_log_bin=sql_logging;
  END;
end
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 32. row ***************************
           SPECIFIC_NAME: rds_set_gsh_rotation
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_set_gsh_rotation
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: begin
  declare v_es varchar(3);
  DECLARE sql_logging BOOLEAN;
  select @@sql_log_bin into sql_logging;
  select variable_value into v_es from performance_schema.global_variables where variable_name = 'EVENT_SCHEDULER';
  
  
  
  if v_es != 'ON' then
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Scheduler is NOT Active. Please set the parameter event_scheduler=ON in your Parameter Group';
  end if;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    alter event ev_rds_gsh_table_rotation ON SCHEDULE EVERY p_period DAY STARTS CURRENT_TIMESTAMP + interval p_period day ENABLE;
    select concat('Table Rotation Enabled every ', p_period ,' Days, Scheduler is Active') as `Success`;
    SET @@sql_log_bin=sql_logging;
  END;
end
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 33. row ***************************
           SPECIFIC_NAME: rds_group_replication_advance_gtid
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_group_replication_advance_gtid
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  DECLARE v_called_by_user VARCHAR(352);
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE v_plugin_installed INT UNSIGNED;
  DECLARE v_loop_id INT UNSIGNED;
  DECLARE sql_logging BOOLEAN;
  SELECT @@sql_log_bin, user(), version() INTO sql_logging, v_called_by_user, v_mysql_version;
  SELECT count(*) INTO v_plugin_installed FROM information_schema.plugins WHERE plugin_name='group_replication';
  IF v_plugin_installed = 0 THEN
    SIGNAL SQLSTATE 'HY000' SET MESSAGE_TEXT = 'Procedure must be executed with group_replication plugin installed.', MYSQL_ERRNO = 1524;
  END IF;
  IF begin_id = 0 or end_id = 0 THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Both start and end transaction ID of the transactions should be bigger than 0.', MYSQL_ERRNO = 1644;
  ELSEIF begin_id > end_id THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Start transaction ID should be smaller or equal to the end transaction ID.', MYSQL_ERRNO = 1644;
  END IF;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; SET @@GTID_NEXT='AUTOMATIC'; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    SET v_loop_id = begin_id;
    loop_label: LOOP
      IF v_loop_id > end_id THEN
        LEAVE loop_label;
      END IF;
      SET @@GTID_NEXT=CONCAT(server_uuid, ':', v_loop_id);
      COMMIT;
      SET v_loop_id = v_loop_id + 1;
      SET @@GTID_NEXT='AUTOMATIC';
    END LOOP;
    
    INSERT into mysql.rds_history(called_by_user, action, mysql_version, master_gtid) values
                                 (v_called_by_user, 'advance gtid', v_mysql_version, CONCAT(server_uuid, ':', begin_id, '-', end_id));
    COMMIT;
    SET @@sql_log_bin=sql_logging;
  END;
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 34. row ***************************
           SPECIFIC_NAME: rds_group_replication_create_user
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_group_replication_create_user
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  DECLARE v_called_by_user VARCHAR(352);
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE v_plugin_installed INT UNSIGNED;
  DECLARE v_count_user_exist INT UNSIGNED;
  DECLARE v_count_mysql_session_exist INT UNSIGNED;
  DECLARE sql_logging BOOLEAN;
  DECLARE user_altered INT DEFAULT 0;
  SELECT @@sql_log_bin, user(), version() INTO sql_logging, v_called_by_user, v_mysql_version;
  SELECT count(*) INTO v_plugin_installed FROM information_schema.plugins WHERE plugin_name='group_replication';
  IF v_plugin_installed = 0 THEN
    SIGNAL SQLSTATE 'HY000' SET MESSAGE_TEXT = 'You must install the group_replication plugin before you call the mysql.rds_group_replication_create_user stored procedure. Install the plugin, and then run the procedure again.', MYSQL_ERRNO = 1524;
  END IF;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    
    SET @@sql_log_bin=OFF;
    
    SELECT count(*) INTO v_count_mysql_session_exist FROM mysql.user WHERE Host='localhost' AND user = 'mysql.session';
    
    IF v_count_mysql_session_exist=0 THEN
      CREATE USER IF NOT EXISTS 'mysql.session'@'localhost'
      IDENTIFIED WITH 'caching_sha2_password' AS '$A$005$THISISACOMBINATIONOFINVALIDSALTANDPASSWORDTHATMUSTNEVERBRBEUSED'
      REQUIRE NONE PASSWORD EXPIRE DEFAULT ACCOUNT LOCK PASSWORD HISTORY DEFAULT PASSWORD REUSE INTERVAL DEFAULT PASSWORD REQUIRE CURRENT DEFAULT;
      GRANT SELECT ON mysql.user to 'mysql.session'@localhost;
      GRANT SELECT ON performance_schema.* TO 'mysql.session'@localhost;
    END IF;
    
    SELECT count(*) into v_count_user_exist FROM mysql.user WHERE Host='%' and user = 'rdsgrprepladmin';
    IF v_count_user_exist>0 THEN
      SET @alter_u_cmd = CONCAT('ALTER USER rdsgrprepladmin@'%' IDENTIFIED BY ',
                  QUOTE(TRIM(BOTH FROM passwd)),
                  ';'
                  );
      PREPARE alter_u_cmd FROM @alter_u_cmd;
      EXECUTE alter_u_cmd;
      SET user_altered=1;
    ELSE
      SET @create_u_cmd = CONCAT('CREATE USER rdsgrprepladmin@'%' IDENTIFIED BY ',
                    QUOTE(TRIM(BOTH FROM passwd)),
                    ';'
                    );
      PREPARE create_u_stmt FROM @create_u_cmd;
      EXECUTE create_u_stmt;
    END IF;
    SET @grant_u_cmd = CONCAT('GRANT REPLICATION SLAVE, GROUP_REPLICATION_STREAM ',
                  'ON *.* TO rdsgrprepladmin@'%';');
    PREPARE grant_u_stmt FROM @grant_u_cmd;
    EXECUTE grant_u_stmt;
    FLUSH PRIVILEGES;
    
    IF user_altered=1 THEN
          SELECT 'Warning: Group replication user already exists, password altered. Please ensure that all your instances have the same password for this user.' AS Message;
          INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user, 'group replication user altered.', v_mysql_version);
    ELSE
          SELECT 'Group replication user created successfully.' AS Message;
          INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user, 'group replication user created.', v_mysql_version);
    END IF;
    
    SET @@sql_log_bin=sql_logging;
  END;
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 35. row ***************************
           SPECIFIC_NAME: rds_group_replication_set_recovery_channel
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_group_replication_set_recovery_channel
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  DECLARE v_called_by_user VARCHAR(352);
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE v_plugin_installed INT UNSIGNED;
  DECLARE v_count_user_exist INT UNSIGNED;
  DECLARE sql_logging BOOLEAN;
  SELECT @@sql_log_bin, user(), version() INTO sql_logging, v_called_by_user, v_mysql_version;
  SELECT count(*) INTO v_plugin_installed FROM information_schema.plugins WHERE plugin_name='group_replication';
  SELECT count(*) into v_count_user_exist FROM mysql.user WHERE Host='%' and user = 'rdsgrprepladmin';
  IF v_plugin_installed = 0 THEN
    SIGNAL SQLSTATE 'HY000' SET MESSAGE_TEXT = 'You must install the group_replication plugin before you call the mysql.rds_group_replication_set_recovery_channel stored procedure. Install the plugin, and then run the procedure again.', MYSQL_ERRNO = 1524;
  ELSEIF v_count_user_exist = 0 THEN
    SIGNAL SQLSTATE 'HY000' SET MESSAGE_TEXT = 'The database user rdsgrprepladmin must exist to set up the group replication recovery channel. Call the stored procedure mysql.rds_group_replication_create_user to create the user, and then set up the group replication recovery channel.', MYSQL_ERRNO = 3162;
  END IF;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    SET @cmd = CONCAT('CHANGE REPLICATION SOURCE TO ',
                      'SOURCE_USER='rdsgrprepladmin'',
                      ', SOURCE_PASSWORD=', QUOTE(TRIM(BOTH FROM passwd)),
                      ' FOR CHANNEL 'group_replication_recovery''
                      );
    PREPARE stmt FROM @cmd;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
    INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user, 'set group replication recovery channel', v_mysql_version);
    COMMIT;
    SET @@sql_log_bin=sql_logging;
  END;
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 36. row ***************************
           SPECIFIC_NAME: rds_group_replication_start
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_group_replication_start
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  DECLARE v_called_by_user VARCHAR(352);
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE v_plugin_installed INT UNSIGNED;
  DECLARE v_member_state VARCHAR(20);
  DECLARE sql_logging BOOLEAN;
  SELECT @@sql_log_bin, user(), version() INTO sql_logging, v_called_by_user, v_mysql_version;
  SELECT count(*) INTO v_plugin_installed FROM information_schema.plugins WHERE plugin_name='group_replication';
  IF v_plugin_installed = 0 THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Procedure must be executed with group_replication plugin installed.';
  END IF;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN
      SET @cmd = 'SET GLOBAL group_replication_bootstrap_group = OFF';
      PREPARE stmt FROM @cmd;
      EXECUTE stmt;
      DEALLOCATE PREPARE stmt;
      SET @@sql_log_bin=sql_logging;
      RESIGNAL;
    END;
    SET @@sql_log_bin=OFF;
    SET @cmd = CONCAT('SET GLOBAL group_replication_bootstrap_group = ', bootstrap);
    PREPARE stmt FROM @cmd;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
    START GROUP_REPLICATION;
    DO SLEEP(2);
    SET @cmd = 'SET GLOBAL group_replication_bootstrap_group = OFF';
    PREPARE stmt FROM @cmd;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
    INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user, CONCAT('start group replication. bootstrap:', bootstrap), v_mysql_version);
    COMMIT;
    SELECT MEMBER_STATE INTO v_member_state FROM performance_schema.replication_group_members WHERE MEMBER_ID=@@server_uuid;
    IF v_member_state = 'ONLINE' THEN
      SELECT 'Group replication started successfully.' AS Message;
    ELSEIF v_member_state = 'RECOVERING' THEN
      SELECT 'Group replication started and recovery is in progress. Run SELECT * FROM performance_schema.replication_group_members to get the current member state.' AS Message;
    ELSE
      SELECT 'Group replication might have encountered an error as member state is not ONLINE or RECOVERING. Run SELECT * FROM performance_schema.replication_group_members to get the current member state.' AS Message;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 37. row ***************************
           SPECIFIC_NAME: rds_group_replication_stop
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_group_replication_stop
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  DECLARE v_called_by_user VARCHAR(352);
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE v_plugin_installed INT UNSIGNED;
  DECLARE v_member_state VARCHAR(20);
  DECLARE sql_logging BOOLEAN;
  SELECT @@sql_log_bin, user(), version() INTO sql_logging, v_called_by_user, v_mysql_version;
  SELECT count(*) INTO v_plugin_installed FROM information_schema.plugins WHERE plugin_name='group_replication';
  IF v_plugin_installed = 0 THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Procedure must be executed with group_replication plugin installed.';
  END IF;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    STOP GROUP_REPLICATION;
    DO SLEEP(2);
    INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user, 'stop group replication', v_mysql_version);
    COMMIT;
    SELECT MEMBER_STATE INTO v_member_state FROM performance_schema.replication_group_members WHERE MEMBER_ID=@@server_uuid;
    IF v_member_state = 'OFFLINE' THEN
      SELECT 'Group replication stopped successfully.' AS MESSAGE;
    ELSE
      SELECT 'Group replication might have encountered an error as member state is not OFFLINE. Run select * from performance_schema.replication_group_members to get the current member state.' AS MESSAGE;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 38. row ***************************
           SPECIFIC_NAME: rds_innodb_buffer_pool_dump_now
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_innodb_buffer_pool_dump_now
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  DECLARE v_called_by_user VARCHAR(352);
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE sql_logging BOOLEAN;
  SELECT @@sql_log_bin, user(), version() INTO sql_logging, v_called_by_user, v_mysql_version;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user,'innodb_buf_dump_now', v_mysql_version);
    commit;
    SET GLOBAL `INNODB_BUFFER_POOL_DUMP_NOW`=1;
    SET @@sql_log_bin=sql_logging;
  END;
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 39. row ***************************
           SPECIFIC_NAME: rds_innodb_buffer_pool_load_abort
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_innodb_buffer_pool_load_abort
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  DECLARE v_called_by_user VARCHAR(352);
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE sql_logging BOOLEAN;
  SELECT @@sql_log_bin, user(), version() INTO sql_logging, v_called_by_user, v_mysql_version;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user,'innodb_buf_ld_abort', v_mysql_version);
    commit;
    SET GLOBAL `innodb_buffer_pool_load_abort`=1;
    SET @@sql_log_bin=sql_logging;
  END;
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 40. row ***************************
           SPECIFIC_NAME: rds_innodb_buffer_pool_load_now
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_innodb_buffer_pool_load_now
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  DECLARE v_called_by_user VARCHAR(352);
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE sql_logging BOOLEAN;
  SELECT @@sql_log_bin, user(), version() INTO sql_logging, v_called_by_user, v_mysql_version;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user,'innodb_buf_load_now', v_mysql_version);
    commit;
    SET GLOBAL `innodb_buffer_pool_load_now`=1;
    SET @@sql_log_bin=sql_logging;
  END;
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 41. row ***************************
           SPECIFIC_NAME: rds_next_master_log
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_next_master_log
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  CALL mysql.rds_next_source_log_for_channel(curr_master_log, '');
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 42. row ***************************
           SPECIFIC_NAME: rds_next_source_log_for_channel
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_next_source_log_for_channel
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  DECLARE v_service_state_for_channel ENUM('ON', 'OFF', 'BROKEN', 'NOT_EXIST');
  DECLARE v_called_by_user VARCHAR(352);
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE sql_logging BOOLEAN;
  DECLARE skip_repl_error INT;
  DECLARE source_log_name TEXT;
  SELECT @@sql_log_bin, user(), version(), mysql.rds_replication_service_state_for_channel(channel) INTO sql_logging, v_called_by_user, v_mysql_version, v_service_state_for_channel;
  SELECT SUBSTRING(Master_log_name, 1, CHAR_LENGTH(Master_log_name)-6) INTO source_log_name FROM mysql.slave_master_info WHERE CONVERT(QUOTE(channel_name) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      INSERT into mysql.rds_history(called_by_user, action, mysql_version, master_log_file, master_log_pos) values (v_called_by_user,'Starting: next_master_log', v_mysql_version, CONCAT('mysql-bin-changelog.', LPAD('1' + curr_source_log, 6, '0')),4);
      COMMIT;
    ELSE
      INSERT into mysql.rds_history(called_by_user, action, mysql_version, master_log_file, master_log_pos) values (v_called_by_user,'Starting: next_channel_log', v_mysql_version, CONCAT(source_log_name, LPAD('1' + curr_source_log, 6, '0')),4);
      COMMIT;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
  IF CONVERT(v_service_state_for_channel USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('NOT_EXIST' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci 
  THEN
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'You can't set the log file name because the replica isn't configured. First call mysql.rds_set_external_master.';
    ELSE
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'The given channel does not exist. Run SHOW REPLICA STATUS\G to find all existing channel names.';
    END IF;
  ELSEIF CONVERT(v_service_state_for_channel USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('ON' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci 
  THEN
    
    
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Slave is running normally.  No errors detected to skip.';
    ELSE
      SET @message_text = CONCAT('Replication is running normally and no errors detected to skip for channel - ', QUOTE(TRIM(BOTH FROM channel)), '');
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @message_text;
    END IF;
  ELSEIF CONVERT(v_service_state_for_channel USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('OFF' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci 
  THEN
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Slave is down or disabled.';
    ELSE
      SET @message_text = CONCAT('Replication is down or disabled for channel ', QUOTE(TRIM(BOTH FROM channel)));
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @message_text;
    END IF;
  ELSE 
    
    
    SELECT @@global.sql_replica_skip_counter into skip_repl_error;
    IF skip_repl_error = 0
    THEN
      SET @cmd = CONCAT('STOP REPLICA FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)));
      PREPARE rds_stop_replica_for_channel FROM @cmd;
      EXECUTE rds_stop_replica_for_channel;
      DEALLOCATE PREPARE rds_stop_replica_for_channel;
      DO SLEEP(2);
      
      IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
      THEN
        
        SET @cmd = CONCAT('CHANGE REPLICATION SOURCE TO SOURCE_LOG_FILE = ', QUOTE(CONCAT('mysql-bin-changelog.', LPAD(1 + curr_source_log, 6, '0'))) ,', SOURCE_LOG_POS = 4 FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)));
      ELSE
        
        SET @cmd = CONCAT('CHANGE REPLICATION SOURCE TO SOURCE_LOG_FILE = ', QUOTE(CONCAT(source_log_name, LPAD(1 + curr_source_log, 6, '0'))) ,', SOURCE_LOG_POS = 4 FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)));
      END IF;
      PREPARE rds_set_source FROM @cmd;
      EXECUTE rds_set_source;
      DEALLOCATE PREPARE rds_set_source;
      SET @cmd = CONCAT('START REPLICA FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)));
      PREPARE rds_start_replica_for_channel FROM @cmd;
      EXECUTE rds_start_replica_for_channel;
      DEALLOCATE PREPARE rds_start_replica_for_channel;
      DO SLEEP(2);
      IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
      THEN
        SELECT 'Master Log Position has been set to start of next log' AS Message;
      ELSE
        SELECT CONCAT('Replication Log Position has been set to start from the next binary log for channel - ', QUOTE(TRIM(BOTH FROM channel))) AS Message;
      END IF;
    ELSE
    
      SET @message_text = CONCAT('Another session currently running the procedure mysql.rds_skip_repl_error_for_channel. Consider to retry the procedure call.');
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @message_text;
    END IF;
    SELECT mysql.rds_replication_service_state_for_channel(channel) INTO v_service_state_for_channel;
    
    BEGIN
      DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
      SET @@sql_log_bin=OFF;
      IF CONVERT(v_service_state_for_channel USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('ON' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
      THEN
        IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
        THEN
          SELECT 'Slave is now running normally' AS Message;
          INSERT into mysql.rds_history(called_by_user, action, mysql_version, master_log_file, master_log_pos) values (v_called_by_user,'next_master_log:OK', v_mysql_version, CONCAT('mysql-bin-changelog.', LPAD('1' + curr_source_log, 6, '0')),4);
          COMMIT;
        ELSE
          SELECT CONCAT('Replication is now running normally for channel ', QUOTE(TRIM(BOTH FROM channel))) AS Message;
          INSERT into mysql.rds_history(called_by_user, action, mysql_version, master_log_file, master_log_pos) values (v_called_by_user,'next_channel_log:OK', v_mysql_version, CONCAT(source_log_name, LPAD('1' + curr_source_log, 6, '0')),4);
          COMMIT;
        END IF;
      ELSE
        IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
        THEN
          INSERT into mysql.rds_history(called_by_user, action, mysql_version, master_log_file, master_log_pos) values (v_called_by_user,'next_master_log:ERR', v_mysql_version, CONCAT('mysql-bin-changelog.', LPAD('1' + curr_source_log, 6, '0')),4);
          COMMIT;
          SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Slave has encountered a new error. Please use SHOW SLAVE STATUS to see the error.';
        ELSE
          INSERT into mysql.rds_history(called_by_user, action, mysql_version, master_log_file, master_log_pos) values (v_called_by_user,'next_channel_log:ERR', v_mysql_version, CONCAT(source_log_name, LPAD('1' + curr_source_log, 6, '0')),4);
          COMMIT;
          SET @message_text = CONCAT('Replication on mentioned channel encountered a new error. Run SHOW REPLICA STATUS FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)));
          SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @message_text;
        END IF;
      END IF;
      SET @@sql_log_bin=sql_logging;
    END;
  END IF;
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 43. row ***************************
           SPECIFIC_NAME: rds_set_external_master
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_set_external_master
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  CALL mysql.rds_set_external_source_for_channel(host, port, user, passwd, name, pos, enable_ssl_encryption, '');
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 44. row ***************************
           SPECIFIC_NAME: rds_set_external_master_with_delay
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_set_external_master_with_delay
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  CALL mysql.rds_set_external_source_with_delay_for_channel(host, port, user, passwd, name, pos, enable_ssl_encryption, delay, '');
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 45. row ***************************
           SPECIFIC_NAME: rds_set_external_source_for_channel
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_set_external_source_for_channel
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  DECLARE v_rdsrepl INT;
  DECLARE v_same_name_channel_service_state ENUM('ON', 'OFF', 'BROKEN', 'NOT_EXIST');
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE v_called_by_user VARCHAR(50);
  DECLARE v_channel_count INT;
  DECLARE v_same_source_count INT;
  DECLARE sql_logging BOOLEAN;
  SELECT @@sql_log_bin, user(), version(), mysql.rds_replication_service_state_for_channel(channel) INTO sql_logging, v_called_by_user, v_mysql_version, v_same_name_channel_service_state;
  SELECT count(1) INTO v_rdsrepl from mysql.rds_history WHERE CONVERT(action USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('disable set master' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci and CONVERT(master_user USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('rdsrepladmin' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
  SELECT count(1) INTO v_channel_count FROM performance_schema.replication_connection_status WHERE CONVERT(QUOTE(channel_name) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci != CONVERT(QUOTE(TRIM(BOTH FROM channel))USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
  SELECT count(1) INTO v_same_source_count FROM performance_schema.replication_connection_configuration rcc WHERE rcc.HOST = host AND rcc.PORT = port AND CONVERT(QUOTE(rcc.CHANNEL_NAME) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci != CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      INSERT INTO mysql.rds_history(called_by_user, action, mysql_version, master_host, master_port, master_user, master_log_file, master_log_pos, master_ssl, auto_position)
      VALUES (v_called_by_user,'Starting: set master', v_mysql_version, TRIM(BOTH FROM host), port, TRIM(BOTH FROM user), TRIM(BOTH FROM log_file_name), pos, enable_ssl_encryption, 0);
      COMMIT;
    ELSE
      INSERT INTO mysql.rds_history(called_by_user, action, mysql_version, master_host, master_port, master_user, master_log_file, master_log_pos, master_ssl, auto_position)
      VALUES (v_called_by_user,'Starting: set channel', v_mysql_version, TRIM(BOTH FROM host), port, TRIM(BOTH FROM user), TRIM(BOTH FROM log_file_name), pos, enable_ssl_encryption, 0);
      COMMIT;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
  IF v_rdsrepl > 0 AND CONVERT(v_called_by_user USING utf8mb4) COLLATE utf8mb4_0900_ai_ci != CONVERT('rdsadmin@localhost' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
  THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Permission Denied: This instance is a RDS Read Replica.';
  END IF;
  IF CONVERT(v_same_name_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci != CONVERT('OFF' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci AND CONVERT(v_same_name_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci != CONVERT('NOT_EXIST' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
  THEN
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'You can't modify replication because replication is running. First call mysql.rds_stop_replication.';
    ELSE
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'You can't modify the given channel because replication is running. First call mysql.rds_stop_replication_for_channel.';
    END IF;
  END IF;
  
  IF v_channel_count >= 15
  THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Maximum 15 channels are allowed in multi-source replication on RDS.';
  END IF;
  
  IF v_same_source_count > 0
  THEN
    SET @error_message = CONCAT('Configuring multiple channels to replicate from the host: ', host, ' and port: ', port, ' is not supported.');
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @error_message;
  END IF;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    SET @cmd = CONCAT('CHANGE REPLICATION SOURCE TO',
                      ' SOURCE_HOST = ', QUOTE(TRIM(BOTH FROM host)),
                      ', SOURCE_PORT = ', port, 
                      ', SOURCE_USER = ', QUOTE(TRIM(BOTH FROM user)),
                      ', SOURCE_PASSWORD = ', QUOTE(TRIM(BOTH FROM passwd)),
                      ', SOURCE_LOG_FILE = ', QUOTE(TRIM(BOTH FROM log_file_name)),
                      ', SOURCE_LOG_POS = ', pos, 
                      ', SOURCE_SSL = ', enable_ssl_encryption, 
                      ', SOURCE_AUTO_POSITION = 0',
                      '  FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel))
                     );
    PREPARE rds_set_source FROM @cmd;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      UPDATE mysql.rds_replication_status SET called_by_user=v_called_by_user, action='set master', mysql_version=v_mysql_version, master_host=TRIM(BOTH FROM host), master_port=port WHERE CONVERT(channel_name USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci AND action IS NOT NULL;
      COMMIT;
    ELSE
      DELETE FROM mysql.rds_replication_status rrs WHERE CONVERT(QUOTE(rrs.channel_name) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
      INSERT INTO mysql.rds_replication_status(called_by_user, action, mysql_version, master_host, master_port, channel_name)
      VALUES (v_called_by_user, 'set channel source', v_mysql_version, TRIM(BOTH FROM host), port, TRIM(BOTH FROM channel));
      COMMIT;
    END IF;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      CALL mysql.rds_clean_replication_status_for_channel(channel);
    END IF;
    EXECUTE rds_set_source;
    DEALLOCATE PREPARE rds_set_source;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      INSERT INTO mysql.rds_history(called_by_user, action, mysql_version, master_host, master_port, master_user, master_log_file, master_log_pos, master_ssl, auto_position)
      VALUES (v_called_by_user,'set master', v_mysql_version, TRIM(BOTH FROM host), port, TRIM(BOTH FROM user), TRIM(BOTH FROM log_file_name), pos, enable_ssl_encryption, 0);
      COMMIT;
    ELSE
      INSERT INTO mysql.rds_history(called_by_user, action, mysql_version, master_host, master_port, master_user, master_log_file, master_log_pos, master_ssl, auto_position)
      VALUES (v_called_by_user,'set channel source', v_mysql_version, TRIM(BOTH FROM host), port, TRIM(BOTH FROM user), TRIM(BOTH FROM log_file_name), pos, enable_ssl_encryption, 0);
      COMMIT;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 46. row ***************************
           SPECIFIC_NAME: rds_set_external_source_gtid_purged
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_set_external_source_gtid_purged
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  DECLARE v_rdsrepl INT;
  DECLARE v_active_replication_channels INT;
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE v_called_by_user VARCHAR(352);
  DECLARE sql_logging BOOLEAN;
  SELECT @@sql_log_bin, user(), version() INTO sql_logging, v_called_by_user, v_mysql_version;
  SELECT count(1) INTO v_rdsrepl from mysql.rds_history WHERE CONVERT(action USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('disable set master' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci and CONVERT(master_user USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('rdsrepladmin' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
  SELECT count(1) INTO v_active_replication_channels FROM performance_schema.replication_connection_status rcs JOIN performance_schema.replication_applier_status rca USING (channel_name) WHERE CONVERT(rcs.service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('ON' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci OR CONVERT(rca.service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('ON' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
      BEGIN
        SET @@sql_log_bin=OFF;
        INSERT INTO mysql.rds_history(called_by_user, action, mysql_version) VALUES (v_called_by_user,'set gtid_purged:ERR', v_mysql_version);
        COMMIT;
        SET @@sql_log_bin=sql_logging;
        RESIGNAL;
      END;
    SET @@sql_log_bin=OFF;
    
    INSERT INTO mysql.rds_history(called_by_user, action, mysql_version) VALUES (v_called_by_user,'begin: set gtid_purged', v_mysql_version);
    COMMIT;
    SET @@sql_log_bin=sql_logging;
    
    
    
    IF v_rdsrepl > 0 and CONVERT(v_called_by_user USING utf8mb4) COLLATE utf8mb4_0900_ai_ci != CONVERT('rdsadmin@localhost' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Permission Denied: This instance is an RDS Read Replica';
    ELSEIF CONVERT(v_called_by_user USING utf8mb4) COLLATE utf8mb4_0900_ai_ci != CONVERT('rdsadmin@localhost' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci AND (CONVERT(mysql.rds_is_semi_sync() USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('REPLICA' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci OR CONVERT(mysql.rds_is_semi_sync() USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('SOURCE' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci)
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Permission Denied: Replication for Multi-AZ clusters is managed exclusively by RDS.';
    END IF;
    
    IF v_active_replication_channels > 0
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'You can't modify gtid_purged because replication is already running.';
    END IF;
    IF CONVERT(server_uuid USING utf8mb4) COLLATE utf8mb4_0900_ai_ci REGEXP '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$' != 1
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = "Invalid input value for server_uuid";
    ELSEIF start_pos < 1
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = "Invalid input value for start_pos. The value of start_pos should be greater than or equal to 1";
    ELSEIF end_pos < start_pos
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = "Invalid input value for end_pos. The value of end_pos should be greater than or equal to start_pos value";
    END IF;
    
    
    SET @cmd = CONCAT("SELECT count(1) INTO @rds_external_gtid_count FROM mysql.gtid_executed 
                WHERE source_uuid='",server_uuid,"' and (",
    start_pos," BETWEEN interval_start AND interval_end 
    OR ",
    end_pos," BETWEEN interval_start AND interval_end 
    OR
    interval_start BETWEEN ",start_pos," AND ",end_pos,"
    OR
    interval_end BETWEEN ",start_pos," AND ",end_pos,")");
    PREPARE rds_external_gtid_check FROM @cmd;
    EXECUTE rds_external_gtid_check;
    DEALLOCATE PREPARE rds_external_gtid_check;
    IF CONVERT(server_uuid USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(@@GLOBAL.SERVER_UUID USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = "You cannot change the GTID set belongs to the current instance";
    END IF;
    IF @rds_external_gtid_count > 0
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = "The GTID set must be a superset of current @@GLOBAL.GTID_PURGED value";
    END IF;
    
    SET GLOBAL GTID_PURGED = CONCAT('+',server_uuid,':',start_pos,'-',end_pos);
    SET @@sql_log_bin=OFF;
    INSERT INTO mysql.rds_history(called_by_user, action, mysql_version) VALUES (v_called_by_user,'set gtid_purged:OK', v_mysql_version);
    COMMIT;
    SET @@sql_log_bin=sql_logging;
  END;
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 47. row ***************************
           SPECIFIC_NAME: rds_set_external_source_with_delay_for_channel
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_set_external_source_with_delay_for_channel
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  DECLARE v_rdsrepl INT;
  DECLARE v_channel_service_state ENUM('ON', 'OFF', 'BROKEN', 'NOT_EXIST');
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE v_called_by_user VARCHAR(50);
  DECLARE v_channel_count INT;
  DECLARE v_same_source_count INT;
  DECLARE sql_logging BOOLEAN;
  SELECT @@sql_log_bin, user(), version(), mysql.rds_replication_service_state_for_channel(channel) INTO sql_logging, v_called_by_user, v_mysql_version, v_channel_service_state;
  SELECT count(1) INTO v_rdsrepl from mysql.rds_history WHERE CONVERT(action USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('disable set master' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci and CONVERT(master_user USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('rdsrepladmin' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
  SELECT count(1) INTO v_channel_count FROM performance_schema.replication_connection_status WHERE CONVERT( QUOTE(channel_name) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci != CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
  SELECT count(1) INTO v_same_source_count FROM performance_schema.replication_connection_configuration rcc WHERE rcc.HOST = host AND rcc.PORT = port AND CONVERT(QUOTE(rcc.CHANNEL_NAME) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci != CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      INSERT INTO mysql.rds_history(called_by_user,action,mysql_version,master_host,master_port,master_user,master_log_file,master_log_pos,master_ssl,master_delay,auto_position)
      VALUES (v_called_by_user,'Starting: set master',v_mysql_version,trim(both from host),port,trim(both from user),trim(both from log_file_name),pos,enable_ssl_encryption,delay, 0);
      COMMIT;
    ELSE
      INSERT INTO mysql.rds_history(called_by_user,action,mysql_version,master_host,master_port,master_user,master_log_file,master_log_pos,master_ssl,master_delay,auto_position)
      VALUES (v_called_by_user,'Starting: set channel',v_mysql_version,trim(both from host),port,trim(both from user),trim(both from log_file_name),pos,enable_ssl_encryption,delay, 0);
      COMMIT;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
  IF delay NOT BETWEEN 0 AND 86400 THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'For source delay the value must be between 0 and 86400 inclusive.';
  END IF;
  IF v_rdsrepl > 0 and CONVERT(v_called_by_user USING utf8mb4) COLLATE utf8mb4_0900_ai_ci != CONVERT('rdsadmin@localhost' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
  THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Permission Denied: This instance is a RDS Read Replica.';
  END IF;
  IF CONVERT(v_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('ON' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci OR CONVERT(v_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('BROKEN' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
  THEN
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'You can't modify replication because replication is running. First call mysql.rds_stop_replication.';
    ELSE
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'You can't modify the given channel because replication is running. First call mysql.rds_stop_replication_for_channel.';
    END IF;
  END IF;
  
  IF v_channel_count >= 15
  THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Maximum 15 channels are allowed in multi source replication on RDS';
  END IF;
  
  IF v_same_source_count > 0
  THEN
    
    SET @error_message = CONCAT('Use multiple channels to replicate from the host: ', host, ' and port: ', port, ' is not supported');
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @error_message;
  END IF;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    SET @cmd = CONCAT('CHANGE REPLICATION SOURCE TO',
                        ' SOURCE_HOST = ', QUOTE(TRIM(BOTH FROM host)),
                        ', SOURCE_PORT = ', port, 
                        ', SOURCE_USER = ', QUOTE(TRIM(BOTH FROM user)),
                        ', SOURCE_PASSWORD = ', QUOTE(TRIM(BOTH FROM passwd)),
                        ', SOURCE_LOG_FILE = ', QUOTE(TRIM(BOTH FROM log_file_name)),
                        ', SOURCE_LOG_POS = ', pos, 
                        ', SOURCE_SSL = ', enable_ssl_encryption, 
                        ', SOURCE_AUTO_POSITION = 0',
                        ', SOURCE_DELAY = ', delay, 
                        ' FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel))
        );
    PREPARE rds_set_source_with_delay FROM @cmd;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      UPDATE mysql.rds_replication_status SET called_by_user=v_called_by_user, action='set master', mysql_version=v_mysql_version , master_host=trim(both from host), master_port=port WHERE action is not null AND (CONVERT(channel_name USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci OR channel_name IS NULL);
      COMMIT;
    ELSE
      DELETE FROM mysql.rds_replication_status WHERE CONVERT(QUOTE(channel_name) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
      INSERT INTO mysql.rds_replication_status(called_by_user, action, mysql_version, master_host, master_port, channel_name) VALUES (v_called_by_user, 'set channel source', v_mysql_version, trim(both from host), port, channel);
      COMMIT;
    END IF;
    CALL mysql.rds_clean_replication_status_for_channel(channel);
    EXECUTE rds_set_source_with_delay;
    DEALLOCATE PREPARE rds_set_source_with_delay;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      INSERT INTO mysql.rds_history(called_by_user,action,mysql_version,master_host,master_port,master_user,master_log_file,master_log_pos,master_ssl,master_delay,auto_position)
        VALUES (v_called_by_user,'set master',v_mysql_version,trim(both from host),port,trim(both from user),trim(both from log_file_name),pos,enable_ssl_encryption,delay, 0);
      COMMIT;
      
      
      UPDATE mysql.rds_configuration
        SET mysql.rds_configuration.value = delay
        WHERE CAST(mysql.rds_configuration.name AS BINARY) = 'source delay';
      COMMIT;
    ELSE
      INSERT INTO mysql.rds_history(called_by_user,action,mysql_version,master_host,master_port,master_user,master_log_file,master_log_pos,master_ssl,master_delay,auto_position)
        VALUES (v_called_by_user,'set channel source',v_mysql_version,trim(both from host),port,trim(both from user),trim(both from log_file_name),pos,enable_ssl_encryption,delay, 0);
      COMMIT;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 48. row ***************************
           SPECIFIC_NAME: rds_set_master_auto_position
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_set_master_auto_position
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  CALL mysql.rds_set_source_auto_position_for_channel(auto_position_mode, '');
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 49. row ***************************
           SPECIFIC_NAME: rds_set_source_auto_position_for_channel
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_set_source_auto_position_for_channel
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  DECLARE v_channel_service_state ENUM('ON', 'OFF', 'BROKEN', 'NOT_EXIST');
  DECLARE v_called_by_user VARCHAR(352);
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE sql_logging BOOLEAN;
  SELECT @@sql_log_bin, user(), version(), mysql.rds_replication_service_state_for_channel(channel) INTO sql_logging, v_called_by_user, v_mysql_version, v_channel_service_state;
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      INSERT into mysql.rds_history(called_by_user, action, mysql_version, auto_position) values (v_called_by_user,'Starting: set_master_AP', v_mysql_version, auto_position_mode);
      COMMIT;
    ELSE
      INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user,'Starting: set_channel_AP',v_mysql_version);
      COMMIT;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
  IF CONVERT(v_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('NOT_EXIST' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci 
  THEN
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SET @message_text = CONCAT('You can't modify auto_position mode because the replica isn't configured. First call mysql.rds_set_external_master.');
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @message_text;
    ELSE
      SET @message_text = CONCAT('The given channel does not exist. Run SHOW REPLICA STATUS\G to find all existing channel names.');
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @message_text;
    END IF;
  END IF;
  
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    SET @cmd = CONCAT('STOP REPLICA FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)));
    PREPARE rds_stop_replica_for_channel FROM @cmd;
    EXECUTE rds_stop_replica_for_channel;
    DEALLOCATE PREPARE rds_stop_replica_for_channel;
    
    SET @cmd = CONCAT('CHANGE REPLICATION SOURCE TO SOURCE_AUTO_POSITION = ', auto_position_mode,
                       ' FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)));
    PREPARE rds_set_source_for_channel FROM @cmd;
    EXECUTE rds_set_source_for_channel;
    DEALLOCATE PREPARE rds_set_source_for_channel;
    SET @cmd = CONCAT('START REPLICA FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)));
    PREPARE rds_start_replica_for_channel FROM @cmd;
    EXECUTE rds_start_replica_for_channel;
    DEALLOCATE PREPARE rds_start_replica_for_channel;
    DO SLEEP(2);
    SELECT mysql.rds_replication_service_state_for_channel(channel) INTO v_channel_service_state;
    IF CONVERT(v_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('ON' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
      THEN
        SELECT CONCAT('Master Auto Position has been set to ', auto_position_mode,'.') AS Message;
        SELECT 'Slave is running normally' as Message;
        INSERT into mysql.rds_history(called_by_user, action, mysql_version, auto_position) values (v_called_by_user,'set_master_AP:OK', v_mysql_version, auto_position_mode);
        COMMIT;
      ELSE
        SELECT CONCAT('Source Auto Position has been set to ', auto_position_mode,' for channel ', QUOTE(TRIM(BOTH FROM channel)),'.') AS Message;
        SELECT CONCAT('Replication is running normally for channel ', QUOTE(TRIM(BOTH from channel))) as Message;
        INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user,'set_channel_AP:OK',v_mysql_version);
        COMMIT;
      END IF;
    ELSE
      IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
      THEN
        SELECT CONCAT('Master Auto Position has been set to ', auto_position_mode,'.') AS Message;
        INSERT into mysql.rds_history(called_by_user, action, mysql_version, auto_position) values (v_called_by_user,'set_master_AP:ERR', v_mysql_version, auto_position_mode);
        COMMIT;
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Slave has encountered a new error. Please use SHOW SLAVE STATUS to see the error.';
      ELSE
        SELECT CONCAT('Source Auto Position has been set to ', auto_position_mode,' for channel ', QUOTE(TRIM(BOTH FROM channel)),'.') AS Message;
        INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user,'set_channel_AP:ERR',v_mysql_version);
        COMMIT;
        SET @message_text = CONCAT('Replication for specified channel encountered a new error.Run SHOW REPLICA STATUS FOR CHANNEL ', QUOTE(TRIM(BOTH from channel)));
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @message_text;
      END IF;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 50. row ***************************
           SPECIFIC_NAME: rds_skip_repl_error
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_skip_repl_error
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  CALL mysql.rds_skip_repl_error_for_channel('');
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 51. row ***************************
           SPECIFIC_NAME: rds_skip_repl_error_for_channel
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_skip_repl_error_for_channel
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  DECLARE v_channel_service_state ENUM('ON', 'OFF', 'BROKEN', 'NOT_EXIST');
  DECLARE v_called_by_user VARCHAR(352);
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE sql_logging BOOLEAN;
  DECLARE v_max_applier_error_number INT;
  DECLARE skip_repl_error INT;
  SELECT @@sql_log_bin, user(), version(), mysql.rds_replication_service_state_for_channel(channel) into sql_logging, v_called_by_user, v_mysql_version, v_channel_service_state;
  SELECT MAX(rasbw.LAST_ERROR_NUMBER) INTO v_max_applier_error_number FROM performance_schema.replication_applier_status_by_worker rasbw WHERE CONVERT(QUOTE(channel_name) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user,'Starting: skip_repl_error',v_mysql_version);
      COMMIT;
    ELSE
      INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user,'Starting: skip_repl_err_ch',v_mysql_version);
      COMMIT;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
  IF CONVERT(v_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('NOT_EXIST' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci 
  THEN
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'You can't skip a replication error because the replica isn't configured. First call mysql.rds_set_external_master.';
    ELSE
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'The given channel does not exist. Run SHOW REPLICA STATUS\G to find all existing channel names.';
    END IF;
  ELSEIF CONVERT(v_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('ON' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci 
  THEN
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Slave is running normally.  No errors detected to skip.';
    ELSE
      SET @message_text = CONCAT('Replication is running normally and no errors detected to skip for channel ', QUOTE(TRIM(BOTH FROM channel)));
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @message_text;
    END IF;
  ELSEIF CONVERT(v_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('OFF' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci 
  THEN
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Slave is down or disabled.';
    ELSE
      SET @message_text = CONCAT('Replication is down or disabled for channel ', QUOTE(TRIM(BOTH FROM channel)));
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @message_text;
    END IF;
  ELSE 
    
    IF v_max_applier_error_number > 0
    THEN
      BEGIN
        DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
        SET @@sql_log_bin=OFF;
        
        
        SELECT @@global.sql_replica_skip_counter into skip_repl_error;
        IF skip_repl_error = 0
        THEN
          SET GLOBAL sql_replica_skip_counter = 1;
          SET @cmd = CONCAT('STOP REPLICA FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)));
          PREPARE rds_stop_replica_for_channel FROM @cmd;
          EXECUTE rds_stop_replica_for_channel;
          DEALLOCATE PREPARE rds_stop_replica_for_channel;
          DO SLEEP(2);
          SET @cmd = CONCAT('START REPLICA FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)));
          PREPARE rds_start_replica_for_channel FROM @cmd;
          EXECUTE rds_start_replica_for_channel;
          DEALLOCATE PREPARE rds_start_replica_for_channel;
          DO SLEEP(2);
        ELSE
          IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
          THEN
            SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'A mysql.rds_skip_repl_error procedure is in progress. Wait a few seconds before calling mysql.rds_skip_repl_error again.';
          ELSE
            SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Another skip_repl_error procedure is in progress. Wait a few seconds before calling mysql.rds_skip_repl_error_for_channel again.';
          END IF;
        END IF;
        IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
        THEN
          SELECT 'Statement in error has been skipped' as Message;
        ELSE
          SELECT CONCAT('Statement in error has been skipped for channel ', QUOTE(TRIM(BOTH from channel))) as Message;
        END IF;
        SELECT mysql.rds_replication_service_state_for_channel(channel) INTO v_channel_service_state;
        IF CONVERT(v_channel_service_state USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('ON' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
        THEN
          IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
          THEN
            SELECT 'Slave is now running normally' as Message;
            INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user,'skip_repl_error:OK',v_mysql_version);
            COMMIT;
          ELSE
            SELECT CONCAT('Replication is running normally for channel ', QUOTE(TRIM(BOTH from channel))) as Message;
            INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user,'skip_repl_err_ch:OK',v_mysql_version);
            COMMIT;
          END IF;
        ELSE
          IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
          THEN
            INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user,'skip_repl_error:ERR',v_mysql_version);
            COMMIT;
            SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Slave has encountered a new error. Please use SHOW SLAVE STATUS to see the error.';
          ELSE
            INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user,'skip_repl_err_ch:ERR',v_mysql_version);
            COMMIT;
            SELECT CONCAT('Replication for specified channel encountered a new error. Run SHOW REPLICA STATUS FOR CHANNEL ', QUOTE(TRIM(BOTH from channel)), ';') as Message;
          END IF;
        END IF;
        SET @@sql_log_bin=sql_logging;
      END;
    ELSE
      
      IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
      THEN
        SELECT CONCAT('The replica SQL thread is running for the specified channel without encountering errors. Run SHOW REPLICA STATUS FOR CHANNEL ', QUOTE(''), ';') as Message;
      ELSE
        SELECT CONCAT('Replica SQL_Thread running normally for specified channel. Run SHOW REPLICA STATUS FOR CHANNEL ', QUOTE(TRIM(BOTH from channel)), ';') as Message;
      END IF;
    END IF;
  END IF;
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 52. row ***************************
           SPECIFIC_NAME: rds_skip_transaction_with_gtid
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_skip_transaction_with_gtid
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  DECLARE v_threads_running int;
  DECLARE v_called_by_user VARCHAR(352);
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE sql_logging BOOLEAN;
  SELECT @@sql_log_bin, user(), version() INTO sql_logging, v_called_by_user, v_mysql_version;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    SET GTID_NEXT=gtid_to_skip;
    START TRANSACTION;
    COMMIT;
    SET GTID_NEXT="AUTOMATIC";
    Select 'Transaction has been skipped successfully.' as Message;
    set @@sql_log_bin=off; 
    INSERT into mysql.rds_history(called_by_user, action, mysql_version) values (v_called_by_user,'rds_skip_transaction_with_gtid:OK',v_mysql_version);
    commit;
    SET @@sql_log_bin=sql_logging;
  END;
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 53. row ***************************
           SPECIFIC_NAME: rds_start_replication_until
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_start_replication_until
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  CALL rds_start_replication_until_for_channel(replication_log_file, replication_stop_point, '');
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 54. row ***************************
           SPECIFIC_NAME: rds_start_replication_until_for_channel
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_start_replication_until_for_channel
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE v_called_by_user VARCHAR(352);
  DECLARE v_service_state_for_channel ENUM('ON', 'OFF', 'BROKEN', 'NOT_EXIST');
  DECLARE v_replica_parallel_workers INT;
  DECLARE sql_logging BOOLEAN;
  DECLARE skip_repl_error INT;
  SELECT @@sql_log_bin, user(), version(), mysql.rds_replication_service_state_for_channel(channel) INTO sql_logging, v_called_by_user, v_mysql_version, v_service_state_for_channel;
  SELECT @@replica_parallel_workers into v_replica_parallel_workers;
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      INSERT INTO mysql.rds_history(called_by_user, action, mysql_version, master_log_file, master_log_pos) VALUES(v_called_by_user, 'Starting: start slave until', v_mysql_version, SUBSTRING(replication_log_file, 1, 50), replication_stop_point);
      COMMIT;
    ELSE
      INSERT INTO mysql.rds_history(called_by_user, action, mysql_version, master_log_file, master_log_pos) VALUES(v_called_by_user, 'Starting: start channel until', v_mysql_version, SUBSTRING(replication_log_file, 1, 50), replication_stop_point);
      COMMIT;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
  IF CONVERT(v_service_state_for_channel USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('NOT_EXIST' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci 
  THEN
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SET @message_text = CONCAT('You can't start replication because the replica isn't configured. First call mysql.rds_set_external_master.');
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @message_text;
    ELSE
      SET @message_text = CONCAT('The given channel does not exist. Run SHOW REPLICA STATUS\G to find all existing channel names.');
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @message_text;
    END IF;
  ELSEIF CONVERT(v_service_state_for_channel USING utf8mb4) COLLATE utf8mb4_0900_ai_ci in (CONVERT('ON' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci  , CONVERT('BROKEN' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci  )
  THEN
    
    
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Replication may already be running. Call rds_stop_replication to stop replication';
    ELSE
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Replication may already be running. Call rds_stop_replication_for_channel procedure to stop replication.';
    END IF;
  ELSEIF v_replica_parallel_workers > 1
  THEN
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'rds_start_replication_until is not supported for multi-threaded slaves';
    ELSE
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'rds_start_replication_until_for_channel is not supported in multi-threaded replica environment.';
    END IF;
  ELSEIF replication_stop_point IS NULL OR replication_stop_point <= 0
  THEN
    
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Invalid input: replication_stop_point cannot be NULL, less than or equal to 0';
  END IF;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    
    
    SELECT @@global.sql_replica_skip_counter INTO skip_repl_error;
    IF skip_repl_error > 0
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Another session currently running the procedure mysql.rds_skip_repl_error_for_channel. Consider retrying the procedure call.';
    END IF;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      UPDATE mysql.rds_replication_status SET called_by_user = v_called_by_user, action = 'start slave until', mysql_version = v_mysql_version, replication_log_file = TRIM(replication_log_file), replication_stop_point = replication_stop_point, replication_gtid = NULL WHERE action IS NOT NULL AND (CONVERT(channel_name USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci OR channel_name IS NULL);
      COMMIT;
    ELSE
      UPDATE mysql.rds_replication_status SET called_by_user = v_called_by_user, action = 'start channel until', mysql_version = v_mysql_version, replication_log_file = TRIM(replication_log_file), replication_stop_point = replication_stop_point, replication_gtid = NULL WHERE action IS NOT NULL AND CONVERT(QUOTE(channel_name) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
      COMMIT;
    END IF;
    
    SET @cmd = CONCAT('START REPLICA UNTIL SOURCE_LOG_FILE = ', QUOTE(TRIM(replication_log_file)), ', SOURCE_LOG_POS = ', replication_stop_point, ' FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)));
    PREPARE rds_start_replication_for_channel_until FROM @cmd;
    EXECUTE rds_start_replication_for_channel_until;
    DEALLOCATE PREPARE rds_start_replication_for_channel_until;
    DO SLEEP(2);
    SELECT mysql.rds_replication_service_state_for_channel(channel) INTO v_service_state_for_channel;
    IF CONVERT(v_service_state_for_channel USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('ON' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
      THEN
        INSERT INTO mysql.rds_history(called_by_user, action, mysql_version, master_log_file, master_log_pos) VALUES(v_called_by_user, 'start slave until', v_mysql_version, SUBSTRING(replication_log_file, 1, 50), replication_stop_point);
        COMMIT;
        SELECT CONCAT('Replication started until MASTER_LOG_FILE = ', QUOTE(TRIM(replication_log_file)), ' and MASTER_LOG_POS = ', replication_stop_point) AS Message;
      ELSE
        INSERT INTO mysql.rds_history(called_by_user, action, mysql_version, master_log_file, master_log_pos) VALUES(v_called_by_user, 'start channel until', v_mysql_version, SUBSTRING(replication_log_file, 1, 50), replication_stop_point);
        COMMIT;
        SELECT CONCAT('Replication started until SOURCE_LOG_FILE = ', QUOTE(TRIM(replication_log_file)), ' and SOURCE_LOG_POS = ', replication_stop_point, ' for channel ', QUOTE(TRIM(BOTH FROM channel))) AS Message;
      END IF;
    ELSE
      IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
      THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Slave has encountered an error. Run SHOW SLAVE STATUS\G; to see the error.';
      ELSE
        SET @error_message = CONCAT('Replication for specified channel encountered an error. Run SHOW REPLICA STATUS FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)));
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @error_message;
      END IF;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 55. row ***************************
           SPECIFIC_NAME: rds_start_replication_until_gtid
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_start_replication_until_gtid
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  CALL mysql.rds_start_replication_until_gtid_for_channel(gtid, '');
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 56. row ***************************
           SPECIFIC_NAME: rds_start_replication_until_gtid_for_channel
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_start_replication_until_gtid_for_channel
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  DECLARE v_mysql_version VARCHAR(20);
  DECLARE v_called_by_user VARCHAR(352);
  DECLARE v_service_state_for_channel ENUM('ON', 'OFF', 'BROKEN', 'NOT_EXIST');
  DECLARE v_replica_parallel_workers INT;
  DECLARE sql_logging BOOLEAN;
  DECLARE skip_repl_error INT;
  SELECT @@sql_log_bin, user(), version(), mysql.rds_replication_service_state_for_channel(channel) INTO sql_logging, v_called_by_user, v_mysql_version, v_service_state_for_channel;
  SELECT @@replica_parallel_workers into v_replica_parallel_workers;
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      INSERT INTO mysql.rds_history(called_by_user, action, mysql_version, master_gtid) VALUES(v_called_by_user, 'Starting: start slave until', v_mysql_version, gtid);
      COMMIT;
    ELSE
      INSERT INTO mysql.rds_history(called_by_user, action, mysql_version, master_gtid) VALUES(v_called_by_user, 'Starting: start channel until', v_mysql_version, gtid);
      COMMIT;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
  IF CONVERT(v_service_state_for_channel USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('NOT_EXIST' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci 
  THEN
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SET @message_text = CONCAT('You can't start replication because the replica isn't configured. First call mysql.rds_set_external_master.');
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @message_text;
    ELSE
      SET @message_text = CONCAT('The given channel does not exist. Run SHOW REPLICA STATUS\G to find all existing channel names.');
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @message_text;
    END IF;
  ELSEIF CONVERT(v_service_state_for_channel USING utf8mb4) COLLATE utf8mb4_0900_ai_ci in (CONVERT('ON' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci  , CONVERT('BROKEN' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci  )
  THEN
    
    
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Replication may already be running. Call rds_stop_replication to stop replication';
    ELSE
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Replication may already be running. Call rds_stop_replication_for_channel to stop replication.';
    END IF;
  ELSEIF v_replica_parallel_workers > 1 THEN
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'rds_start_replication_until_gtid is not supported for multi-threaded slaves';
    ELSE
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'rds_start_replication_until_gtid_for_channel is not supported for multi-threaded replicas.';
    END IF;
  ELSEIF gtid IS NULL THEN
    
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Invalid input: gtid cannot be NULL';
  END IF;
  
  BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    
    
    SELECT @@global.sql_replica_skip_counter INTO skip_repl_error;
    IF skip_repl_error > 0
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Another session currently running the procedure mysql.rds_skip_repl_error_for_channel. Consider to retry the procedure call.';
    END IF;
    IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      UPDATE mysql.rds_replication_status SET called_by_user = v_called_by_user, action = 'start slave until', mysql_version = v_mysql_version, replication_gtid = gtid, replication_log_file = NULL, replication_stop_point = NULL WHERE action IS NOT NULL AND (CONVERT(channel_name USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci OR channel_name IS NULL);
      COMMIT;
    ELSE
      UPDATE mysql.rds_replication_status SET called_by_user = v_called_by_user, action = 'start channel until', mysql_version = v_mysql_version, replication_gtid = gtid, replication_log_file = NULL, replication_stop_point = NULL WHERE action IS NOT NULL AND CONVERT(QUOTE(channel_name) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci;
      COMMIT;
    END IF;
    
    SET @cmd = CONCAT('START REPLICA UNTIL SQL_AFTER_GTIDS = ', QUOTE(gtid), ' FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)));
    PREPARE rds_start_replication_for_channel_until FROM @cmd;
    EXECUTE rds_start_replication_for_channel_until;
    DEALLOCATE PREPARE rds_start_replication_for_channel_until;
    DO SLEEP(2);
    SELECT mysql.rds_replication_service_state_for_channel(channel) INTO v_service_state_for_channel;
    IF CONVERT(v_service_state_for_channel USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('ON' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
      THEN
        INSERT INTO mysql.rds_history(called_by_user, action, mysql_version, master_gtid) VALUES(v_called_by_user, 'start slave until', v_mysql_version, gtid);
        COMMIT;
        SELECT CONCAT('Replication started until SQL_AFTER_GTIDS = ', QUOTE(gtid)) AS Message;
      ELSE
        INSERT INTO mysql.rds_history(called_by_user, action, mysql_version, master_gtid) VALUES(v_called_by_user, 'start channel until', v_mysql_version, gtid);
        COMMIT;
        SELECT CONCAT('Replication started until SQL_AFTER_GTIDS = ', QUOTE(gtid), ' for channel ', QUOTE(TRIM(BOTH FROM channel))) AS Message;
      END IF;
    ELSE
      IF CONVERT(QUOTE(TRIM(BOTH FROM channel)) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT(QUOTE('') USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
      THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Slave has encountered an error. Run SHOW SLAVE STATUS\G; to see the error.';
      ELSE
        SET @error_message = CONCAT('Replication for specified channel encountered an error. Run SHOW REPLICA STATUS FOR CHANNEL ', QUOTE(TRIM(BOTH FROM channel)));
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = @error_message;
      END IF;
    END IF;
    SET @@sql_log_bin=sql_logging;
  END;
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:31
            LAST_ALTERED: 2025-03-11 08:01:31
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 57. row ***************************
           SPECIFIC_NAME: rds_start_upgrade_prechecks
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_start_upgrade_prechecks
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  DECLARE v_engine_version TEXT;
  DECLARE v_called_by_user TEXT;
  DECLARE most_recent_action TEXT CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
  DECLARE most_recent_status TEXT CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
  DECLARE sql_logging BOOLEAN;

SELECT @@sql_log_bin, user(), version() INTO sql_logging, v_called_by_user, v_engine_version;

BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; SET GLOBAL admin_tls_version=default; RESIGNAL; END;
    SET @@sql_log_bin=OFF;
    
    
    
    
    
    
    
    IF CONVERT(substring_index(version(),'.',2) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('8.0' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci AND substring(version(),5,6) <= 35
    THEN
       SET GLOBAL admin_tls_version='TLSv1.3';
    END IF;

    
    INSERT INTO mysql.rds_history(called_by_user, action, mysql_version) VALUES (v_called_by_user, 'start prechecks', v_engine_version);
    COMMIT;

    SELECT action, status INTO most_recent_action, most_recent_status FROM mysql.rds_upgrade_prechecks ORDER BY id DESC LIMIT 1;

    
    IF CONVERT(targetEngineName USING utf8mb4) COLLATE utf8mb4_0900_ai_ci <> CONVERT('mysql' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci OR targetEngineName IS NULL
    THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Only mysql target engine is supported';
    END IF;

    
    IF targetEngineVersion IS NULL OR CONVERT(targetEngineVersion USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Target engine version is required';
    
    ELSEIF NOT CONVERT(targetEngineVersion USING utf8mb4) COLLATE utf8mb4_0900_ai_ci REGEXP '^(5.7.[0-9]{1,2}|8.[0-4].[0-9]{1,2}|9.[0-9].[0-9]{1,2}|10.[0-9].[0-9]{1,2})$'
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Provide valid engine version which must be supported RDS for MySQL version in X.Y.Z format';
    END IF;

    IF most_recent_action = CONVERT('engine upgrade' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci AND most_recent_status IN (CONVERT('in progress' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci)
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Cannot call procedure while engine upgrade in progress.';
    ELSEIF most_recent_action = CONVERT('start_precheck' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci AND most_recent_status IN (CONVERT('in progress' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci,CONVERT('pending' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci)
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Upgrade prechecks in progress. Please stop currently running prechecks using mysql.rds_stop_upgrade_prechecks()';
    ELSE
      INSERT INTO mysql.rds_upgrade_prechecks(action,status,engine_version,target_engine_name,target_engine_version) VALUES (CONVERT('start_precheck' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci, CONVERT('pending' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci, CONVERT(v_engine_version USING utf8mb4) COLLATE utf8mb4_0900_ai_ci, targetEngineName, targetEngineVersion);
      
      INSERT INTO mysql.rds_history(called_by_user, action, mysql_version) VALUES (v_called_by_user, 'start prechecks:ok', v_engine_version);
      COMMIT;
      SELECT 'Starting upgrade prechecks.' as 'Success';
    END IF;
    SET @@sql_log_bin=sql_logging;
    SET GLOBAL admin_tls_version=default;
END;

END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:34
            LAST_ALTERED: 2025-03-11 08:01:34
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 58. row ***************************
           SPECIFIC_NAME: rds_stop_upgrade_prechecks
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_stop_upgrade_prechecks
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
  DECLARE v_called_by_user TEXT;
  DECLARE v_engine_version TEXT;
  DECLARE most_recent_action TEXT CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
  DECLARE most_recent_status TEXT CHARSET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
  DECLARE sql_logging BOOLEAN;

SELECT @@sql_log_bin, user(), version() INTO sql_logging, v_called_by_user, v_engine_version;

BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION BEGIN SET @@sql_log_bin=sql_logging; SET GLOBAL admin_tls_version=default; RESIGNAL; END;
    SET @@sql_log_bin=OFF;

    
    
    
    
    
    
    
    IF CONVERT(substring_index(version(),'.',2) USING utf8mb4) COLLATE utf8mb4_0900_ai_ci = CONVERT('8.0' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci AND substring(version(),5,6) <= 35
    THEN
        SET GLOBAL admin_tls_version='TLSv1.3';
    END IF;

    
    INSERT INTO mysql.rds_history(called_by_user, action, mysql_version) VALUES (v_called_by_user, 'stop prechecks', v_engine_version);
    COMMIT;

    SELECT action, status INTO most_recent_action, most_recent_status FROM mysql.rds_upgrade_prechecks ORDER BY id DESC LIMIT  1;

    IF most_recent_action = CONVERT('engine upgrade' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci AND most_recent_status IN (CONVERT('pending' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci, CONVERT('in progress' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci)
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Cannot call procedure while engine upgrade in progress.';
    ELSEIF most_recent_action = CONVERT('stop_precheck' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci OR most_recent_status IN (CONVERT('stopped' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci, CONVERT('unable to be completed' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci, CONVERT('prechecks failed' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci, CONVERT('prechecks passed' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci)
    THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Cannot call procedure, upgrade prechecks not running.';
    ELSE
      
      UPDATE mysql.rds_upgrade_prechecks SET STATUS=CONVERT('stopping' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci WHERE CONVERT(status USING utf8mb4) COLLATE utf8mb4_0900_ai_ci IN (CONVERT('pending' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci, CONVERT('in progress' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci);
      
      INSERT INTO mysql.rds_upgrade_prechecks(action, status) VALUES (CONVERT('stop_precheck' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci,CONVERT('stopping' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci);
      
      INSERT INTO mysql.rds_history(called_by_user,action,mysql_version) VALUES (v_called_by_user,'stop prechecks:ok',v_engine_version);
      COMMIT;
      SELECT 'Stopping upgrade prechecks.' as `Success`;
    END IF;

    SET @@sql_log_bin=sql_logging;
    SET GLOBAL admin_tls_version=default;
END;

END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:34
            LAST_ALTERED: 2025-03-11 08:01:34
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 59. row ***************************
           SPECIFIC_NAME: rds_show_upgrade_prechecks_status
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_show_upgrade_prechecks_status
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
SELECT action, status, engine_version, target_engine_name, target_engine_version, start_timestamp, last_timestamp, prechecks_completed, prechecks_remaining
FROM mysql.rds_upgrade_prechecks WHERE CONVERT(action USING utf8mb4) COLLATE utf8mb4_0900_ai_ci IN (CONVERT('start_precheck' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci, CONVERT('engine upgrade' USING utf8mb4) COLLATE utf8mb4_0900_ai_ci) ORDER BY id DESC LIMIT 1;
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:34
            LAST_ALTERED: 2025-03-11 08:01:34
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 60. row ***************************
           SPECIFIC_NAME: rds_show_upgrade_prechecks_summary
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_show_upgrade_prechecks_summary
            ROUTINE_TYPE: PROCEDURE
               DATA_TYPE: 
CHARACTER_MAXIMUM_LENGTH: NULL
  CHARACTER_OCTET_LENGTH: NULL
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: NULL
          COLLATION_NAME: NULL
          DTD_IDENTIFIER: NULL
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
SELECT summary from mysql.rds_upgrade_prechecks ORDER BY id DESC LIMIT 1;
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: NO
         SQL_DATA_ACCESS: CONTAINS SQL
                SQL_PATH: NULL
           SECURITY_TYPE: DEFINER
                 CREATED: 2025-03-11 08:01:34
            LAST_ALTERED: 2025-03-11 08:01:34
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
*************************** 61. row ***************************
           SPECIFIC_NAME: rds_version
         ROUTINE_CATALOG: def
          ROUTINE_SCHEMA: mysql
            ROUTINE_NAME: rds_version
            ROUTINE_TYPE: FUNCTION
               DATA_TYPE: varchar
CHARACTER_MAXIMUM_LENGTH: 60
  CHARACTER_OCTET_LENGTH: 240
       NUMERIC_PRECISION: NULL
           NUMERIC_SCALE: NULL
      DATETIME_PRECISION: NULL
      CHARACTER_SET_NAME: utf8mb4
          COLLATION_NAME: utf8mb4_0900_ai_ci
          DTD_IDENTIFIER: varchar(60)
            ROUTINE_BODY: SQL
      ROUTINE_DEFINITION: BEGIN
RETURN '8.0.40.R1';
END
           EXTERNAL_NAME: NULL
       EXTERNAL_LANGUAGE: SQL
         PARAMETER_STYLE: SQL
        IS_DETERMINISTIC: YES
         SQL_DATA_ACCESS: NO SQL
                SQL_PATH: NULL
           SECURITY_TYPE: INVOKER
                 CREATED: 2025-03-11 08:01:35
            LAST_ALTERED: 2025-03-11 08:01:35
                SQL_MODE: NO_ENGINE_SUBSTITUTION
         ROUTINE_COMMENT: 
                 DEFINER: rdsadmin@localhost
    CHARACTER_SET_CLIENT: utf8mb4
    COLLATION_CONNECTION: utf8mb4_0900_ai_ci
      DATABASE_COLLATION: utf8mb4_0900_ai_ci
61 rows in set (0.12 sec)

ERROR: 
No query specified

mysql> \t
